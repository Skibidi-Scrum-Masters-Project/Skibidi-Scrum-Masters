@using FitLifeFitness.Services
@using Frontend.Models
@inject NavigationManager Nav
@inject TokenService TokenService
@inject SocialService SocialService

<header class="topbar">
    <div class="topbar-left">
        <h1 class="brand">FitLife Fitness</h1>
        <p class="welcome">Velkommen tilbage, @Username</p>
    </div>

    <div class="topbar-right">
        <button class="icon-btn" type="button" aria-label="Søg" title="Søg" @onclick="GoToSearch">
            <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false">
                    <circle cx="11" cy="11" r="6"></circle>
                    <path d="M20 20l-3.5-3.5"></path>
                </svg>
            </span>
        </button>

        <button class="icon-btn" type="button" aria-label="Notifikationer" title="Notifikationer" @onclick="GoToNotifications">
            <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </span>

            @if (HasNotifications)
            {
                <span class="dot" aria-hidden="true"></span>
            }
        </button>

        <button class="avatar" type="button" aria-label="Profil" title="Profil" @onclick="GoToProfile">
            @UserInitial
        </button>
    </div>
</header>

@code {
    private string? Username { get; set; }
    private string? UserId { get; set; }
    private List<Friendship> PendingList = new();
    private string UserInitial => string.IsNullOrWhiteSpace(Username) ? "?" : Username.Substring(0, 1).ToUpperInvariant();

    private bool HasNotifications { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        Username = await TokenService.GetUsernameAsync();
        UserId = await TokenService.GetUserIdAsync();


        await CheckForNotifications();
    }


    private async Task CheckForNotifications()
    {
        HasNotifications = false;
            
        if (string.IsNullOrWhiteSpace(UserId))
        {
            return;
        }
        
        var res = await SocialService.GetIncomingFriendRequestsAsync(UserId);
        
        if (!res.IsSuccessStatusCode)
        {
            return;
        }
        
        var resResult = await res.Content.ReadFromJsonAsync<List<Friendship>>();
        
        HasNotifications = resResult?.Any() == true;

    }

    private void GoToProfile() => Nav.NavigateTo("/profile");

    private void GoToSearch() => Nav.NavigateTo("/friends/search");

    private void GoToNotifications() => Nav.NavigateTo("/notifications");
}