@page "/locker"
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using System.Net.Http.Json
@using System.Text.Json
@layout PhoneLayout

@inject AccessControlService AccessControlService
@inject TokenService TokenService
@inject NavigationManager Nav

<div class="locker-page">
    @if (isLoading)
    {
        <section class="page-header">
            <h1 class="page-title">Mit Skab</h1>
            <p class="page-subtitle">Indlæser...</p>
        </section>

        <section class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Henter skabsoplysninger</p>
        </section>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <section class="page-header">
            <h1 class="page-title">Mit Skab</h1>
            <p class="page-subtitle">Der opstod en fejl</p>
        </section>

        <section class="error-state">
            <div class="error-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
            </div>
            <h3 class="error-title">Noget gik galt</h3>
            <p class="error-message">@error</p>
            <button class="retry-btn" type="button" @onclick="ReloadAll">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                <span>Prøv igen</span>
            </button>
        </section>
    }
    else
    {
        <section class="page-header">
            <h1 class="page-title">Mit Skab</h1>
            <p class="page-subtitle">@GetSubtitle()</p>
        </section>

        @if (myLocker != null)
        {
            <section class="my-locker-hero">
                <div class="locker-badge-large">
                    <div class="badge-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                    </div>
                    <div class="badge-number">#@myLocker.LockerId</div>
                </div>

                <div class="locker-status">
                    <div class="status-indicator active"></div>
                    <span>Dit skab er aktivt</span>
                </div>
            </section>
            

            <section class="action-cards">
                <button class="action-card danger" type="button" @onclick="ReleaseMyLocker" disabled="@isLockerBusy">
                    <div class="action-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                    </div>
                    <div class="action-content">
                        <div class="action-title">Frigiv skab</div>
                        <div class="action-subtitle">Gør skabet tilgængeligt for andre</div>
                    </div>
                    <div class="action-arrow">›</div>
                </button>
            </section>

            <section class="info-card">
                <div class="info-row">
                    <div class="info-label">Status</div>
                    <div class="info-value">Ejet af dig</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Skab nummer</div>
                    <div class="info-value">@myLocker.LockerId</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Handling</div>
                    <div class="info-value">Frigiv når du er færdig</div>
                </div>
            </section>
        }
        else if (availableLockers.Any())
        {
            <section class="select-section">
                <div class="select-header">
                    <div class="select-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                    </div>
                    <h3 class="select-title">Vælg et ledigt skab</h3>
                    <p class="select-subtitle">@availableLockers.Count ledige skabe</p>
                </div>

                <div class="locker-grid">
                    @foreach (var locker in availableLockers)
                    {
                        <button class="locker-cell" type="button" @onclick="() => ClaimLocker(locker)" disabled="@isLockerBusy">
                            <div class="cell-number">#@locker.LockerId</div>
                            <div class="cell-status">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12" />
                                </svg>
                                <span>Ledig</span>
                            </div>
                        </button>
                    }
                </div>
            </section>
        }
        else
        {
            <section class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>
                </div>
                <h3 class="empty-title">Ingen ledige skabe</h3>
                <p class="empty-text">Alle skabe er i øjeblikket i brug. Prøv igen om lidt.</p>
            </section>
        }

        <button class="refresh-fab" type="button" @onclick="ReloadAll" disabled="@isLockerBusy">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="23 4 23 10 17 10" />
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
            </svg>
        </button>
    }
</div>

@code {
    private string? lockerRoomId;

    private bool isLoading = true;
    private bool isLockerBusy;

    private string? error;
    private string? userId;

    private string lockerHint = "Klar til brug";

    private Locker? myLocker;
    private List<Locker> availableLockers = new();

    protected override async Task OnInitializedAsync()
    {
        await TokenService.FlushPendingAsync();

        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        await LoadLockerRoomId();

        if (!string.IsNullOrWhiteSpace(error) || string.IsNullOrWhiteSpace(lockerRoomId))
        {
            isLoading = false;
            return;
        }

        await ReloadAll();
    }

    private async Task LoadLockerRoomId()
    {
        try
        {
            var res = await AccessControlService.GetLockerRoomId();

            if (!res.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente locker room: {(int)res.StatusCode}";
                return;
            }

            lockerRoomId = (await res.Content.ReadAsStringAsync()).Trim().Trim('"');

            if (string.IsNullOrWhiteSpace(lockerRoomId))
                error = "Locker room id var tom";
        }
        catch (Exception ex)
        {
            error = $"Fejl ved hentning af locker room: {ex.Message}";
        }
    }

    private async Task ReloadAll()
    {
        try
        {
            isLoading = true;
            error = null;
            StateHasChanged();

            if (string.IsNullOrWhiteSpace(userId))
            {
                error = "Kunne ikke finde bruger id";
                return;
            }

            if (string.IsNullOrWhiteSpace(lockerRoomId))
            {
                error = "Kunne ikke finde locker room id";
                return;
            }

            await LoadMyLocker();
            await LoadAvailableLockers();
        }
        catch (Exception ex)
        {
            error = $"Fejl: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMyLocker()
    {
        myLocker = null;

        if (string.IsNullOrWhiteSpace(userId) || string.IsNullOrWhiteSpace(lockerRoomId))
            return;

        var res = await AccessControlService.GetLockerForUserAsync(lockerRoomId, userId);

        if (!res.IsSuccessStatusCode)
            return;

        var json = (await res.Content.ReadAsStringAsync())?.Trim();

        if (string.IsNullOrWhiteSpace(json) || json == "null")
            return;

        try
        {
            var locker = JsonSerializer.Deserialize<Locker>(json, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });

            if (locker != null && !string.IsNullOrWhiteSpace(locker.LockerId) && locker.UserId == userId)
                myLocker = locker;
        }
        catch
        {
            myLocker = null;
        }
    }

    private async Task LoadAvailableLockers()
    {
        availableLockers = new List<Locker>();

        if (string.IsNullOrWhiteSpace(lockerRoomId))
            return;

        var res = await AccessControlService.GetAvailableLockersAsync(lockerRoomId);

        if (!res.IsSuccessStatusCode)
        {
            error = $"Kunne ikke hente skabe: {(int)res.StatusCode}";
            return;
        }

        var json = (await res.Content.ReadAsStringAsync())?.Trim();

        if (string.IsNullOrWhiteSpace(json) || json == "null")
            return;

        try
        {
            availableLockers = JsonSerializer.Deserialize<List<Locker>>(json, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            }) ?? new List<Locker>();
        }
        catch
        {
            availableLockers = new List<Locker>();
        }
    }

    private async Task ClaimLocker(Locker locker)
    {
        if (string.IsNullOrWhiteSpace(userId) ||
            string.IsNullOrWhiteSpace(lockerRoomId) ||
            string.IsNullOrWhiteSpace(locker?.LockerId))
            return;

        try
        {
            isLockerBusy = true;
            lockerHint = "Reserverer skab...";
            error = null;
            StateHasChanged();

            var res = await AccessControlService.LockLockerAsync(lockerRoomId, locker.LockerId, userId);

            if (!res.IsSuccessStatusCode)
            {
                error = $"Kunne ikke reservere skab: {(int)res.StatusCode}";
                return;
            }

            await LoadMyLocker();
            await LoadAvailableLockers();
        }
        catch (Exception ex)
        {
            error = $"Fejl: {ex.Message}";
        }
        finally
        {
            lockerHint = "Klar til brug";
            isLockerBusy = false;
            StateHasChanged();
        }
    }

    private async Task UnlockMyLocker()
    {
        if (string.IsNullOrWhiteSpace(userId) ||
            string.IsNullOrWhiteSpace(lockerRoomId) ||
            string.IsNullOrWhiteSpace(myLocker?.LockerId))
            return;

        try
        {
            isLockerBusy = true;
            lockerHint = "Låser op...";
            error = null;
            StateHasChanged();

            var res = await AccessControlService.OpenLockerAsync(lockerRoomId, myLocker.LockerId, userId);

            if (!res.IsSuccessStatusCode)
            {
                error = $"Kunne ikke låse op: {(int)res.StatusCode}";
                return;
            }

            lockerHint = "Skab låst op!";
            await Task.Delay(900);

            await LoadMyLocker();
            await LoadAvailableLockers();
        }
        catch (Exception ex)
        {
            error = $"Fejl: {ex.Message}";
        }
        finally
        {
            lockerHint = "Klar til brug";
            isLockerBusy = false;
            StateHasChanged();
        }
    }

    private async Task ReleaseMyLocker()
    {
        if (string.IsNullOrWhiteSpace(userId) ||
            string.IsNullOrWhiteSpace(lockerRoomId) ||
            string.IsNullOrWhiteSpace(myLocker?.LockerId))
            return;

        try
        {
            isLockerBusy = true;
            lockerHint = "Frigiver skab...";
            error = null;
            StateHasChanged();

            var res = await AccessControlService.OpenLockerAsync(lockerRoomId, myLocker.LockerId, userId);

            if (!res.IsSuccessStatusCode)
            {
                error = $"Kunne ikke frigive skab: {(int)res.StatusCode}";
                return;
            }

            lockerHint = "Skab frigivet!";
            await Task.Delay(700);

            await LoadMyLocker();
            await LoadAvailableLockers();
        }
        catch (Exception ex)
        {
            error = $"Fejl: {ex.Message}";
        }
        finally
        {
            lockerHint = "Klar til brug";
            isLockerBusy = false;
            StateHasChanged();
        }
    }

    private string GetSubtitle()
    {
        if (myLocker != null)
            return $"Skab #{myLocker.LockerId}";

        var count = availableLockers.Count;
        if (count == 0) return "Ingen ledige skabe";
        if (count == 1) return "1 ledigt skab";
        return $"{count} ledige skabe";
    }
}
