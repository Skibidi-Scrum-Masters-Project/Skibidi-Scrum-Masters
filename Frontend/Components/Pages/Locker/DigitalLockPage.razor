@page "/locker"
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@inject AccessControlService AccessControlService
@inject TokenService TokenService
@layout PhoneLayout

<div class="locker-page">
    <main class="locker-body">
        @if (isLoading)
        {
            <section class="loading-card">
                <div class="spinner"></div>
                <p class="loading-text">Indl√¶ser skabe...</p>
            </section>
        }
        else if (!string.IsNullOrEmpty(error))
        {
            <section class="error-card">
                <p class="error-text">‚ùå @error</p>
                <button class="retry-button" @onclick="LoadLockers" type="button">
                    Pr√∏v igen
                </button>
            </section>
        }
        else if (myLocker != null)
        {
            <section class="my-locker-card">
                <div class="locker-header">
                    <h2 class="locker-number">Skab #@myLocker.LockerId</h2>
                    <span class="status-badge">‚úì Aktiv</span>
                </div>

                <div class="bluetooth-section">
                    <div class="bluetooth-icon">
                        üì∂
                    </div>
                    <div class="bluetooth-status">Bluetooth tilsluttet</div>
                    <div class="bluetooth-device">Locker @myLocker.LockerId</div>
                </div>

                <button class="action-button btn-unlock" @onclick="UnlockMyLocker" type="button">
                    üîì L√•s op
                </button>

                <button class="action-button btn-lock" @onclick="() => LockLocker(myLocker)" type="button">
                    üîí L√•s skab
                </button>

                <button class="action-button btn-secondary" @onclick="ReleaseLocker" type="button">
                    Frigiv skab
                </button>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">L√•st</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Batteri</div>
                        <div class="info-value">92%</div>
                    </div>
                </div>
            </section>
        }
        else if (availableLockers.Any())
        {
            <section class="available-section">
                <h3 class="available-header">V√¶lg et ledigt skab</h3>
                <div class="locker-grid">
                    @foreach (var locker in availableLockers)
                    {
                        <button class="locker-item" @onclick="() => LockLocker(locker)" type="button">
                            <div class="locker-item-number">#@locker.LockerId</div>
                            <div class="locker-item-status">‚úì Ledig</div>
                        </button>
                    }
                </div>
            </section>
        }
        else
        {
            <section class="empty-card">
                <p class="empty-text">Ingen ledige skabe tilg√¶ngelige lige nu</p>
            </section>
        }
    </main>
</div>

@code {
    private List<Locker> Lockers = new();
    private bool isLoading = true;
    private string? error;
    private Locker? userLocker;

    private string lockerRoomId = "69429a77064cd3c851ab289a";
    private string? userId;

    private Locker? myLocker => Lockers.FirstOrDefault(l => l.UserId == userId);
    private List<Locker> availableLockers => Lockers.Where(l => !l.IsLocked).ToList();

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        await LoadLockers();
        await GetLockerForUser();
    }

    private async Task LoadLockers()
    {
        try
        {
            isLoading = true;
            error = null;

            var res = await AccessControlService.GetAvailableLockersAsync(lockerRoomId);

            if (!res.IsSuccessStatusCode)
            {
                error = await res.Content.ReadAsStringAsync();
                return;
            }

            Lockers =
                await res.Content.ReadFromJsonAsync<List<Locker>>()
                ?? new List<Locker>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task GetLockerForUser()
    {
        if (userId == null)
            return;

        var response =
            await AccessControlService.GetLockerForUserAsync(lockerRoomId, userId);

        if (response.IsSuccessStatusCode)
        {
            userLocker =
                await response.Content.ReadFromJsonAsync<Locker>();
        }
    }


    private async Task LockLocker(Locker locker)
    {
        if (locker.LockerId == null || userId == null)
            return;

        await AccessControlService.LockLockerAsync(
            lockerRoomId,
            locker.LockerId,
            userId);

        await LoadLockers();
    }

    private async Task UnlockMyLocker()
    {
        if (myLocker?.LockerId == null)
            return;

        // Her skulle Bluetooth unlock logik v√¶re
        // For nu simulerer vi bare en unlock handling
        await Task.Delay(500);
        
        // Evt. kald til AccessControlService.UnlockLockerAsync()
        
        await LoadLockers();
    }

    private async Task ReleaseLocker()
    {
        if (myLocker?.LockerId == null || userId == null)
            return;

        // Frigiv skabet s√• andre kan bruge det
        // Dette skal tilpasses din API
        await LoadLockers();
    }
}