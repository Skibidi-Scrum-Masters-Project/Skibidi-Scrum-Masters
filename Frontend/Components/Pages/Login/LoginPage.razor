@page "/"
@page "/login"
@layout PhoneLayoutWithoutNav
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components

<div class="login-page">

    <header class="login-top">
        <h1 class="login-brand">FitLife Fitness</h1>
        <p class="login-lead">Log ind for at se din status, dine hold og dit skab.</p>
    </header>

    <main class="login-main">

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="login-alert">@errorMessage</div>
        }

        <EditForm Model="@loginModel" OnValidSubmit="OnLoginClicked" FormName="LoginForm" class="login-form">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="username">Brugernavn</label>
                <InputText id="username" @bind-Value="loginModel.Username" class="input-field" disabled="@isLoading" />
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <InputText id="password" type="password" @bind-Value="loginModel.Password" class="input-field" disabled="@isLoading" />
            </div>

            <ValidationSummary />

            <button type="submit" class="primary-btn" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Logger ind...</span>
                }
                else
                {
                    <span>Log ind</span>
                }
            </button>
        </EditForm>

        <div class="login-actions">
            <button type="button" class="ghost-btn">Glemt password?</button>
            <button type="button" class="ghost-btn" @onclick="GoToCreateUser">Opret bruger</button>
        </div>

        <button type="button" class="secondary-btn" @onclick="GoToDashboardNow">
            Fortsæt til dashboard
        </button>

    </main>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginModel loginModel { get; set; } = new();

    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task OnLoginClicked()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result != null)
                {
                    // Gem token inkl. Role
                    await TokenService.SaveTokenAsync(result.Token, result.User.Id, result.User.Username, result.User.Role);

                    try
                    {
                        await TokenService.FlushPendingAsync();
                        await Task.Delay(50);
                    }
                    catch { }

                    Nav.NavigateTo("/dashboard", forceLoad: false);
                    return;
                }
            }
            else
            {
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    errorMessage = "Forkert brugernavn eller password.";
                }
                else
                {
                    errorMessage = "Login mislykkedes. Prøv igen.";
                }
            }
        }
        catch (NavigationException)
        {
            throw; // Blazor håndterer navigation
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Kunne ikke oprette forbindelse til serveren.";
            Console.WriteLine($"HTTP error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = "Der opstod en fejl. Prøv igen senere.";
            Console.WriteLine($"Exception: {ex.GetType().Name} - {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToDashboardNow()
    {
        var uri = new Uri(Nav.Uri);
        var dashboardUrl = $"{uri.Scheme}://{uri.Authority}/dashboard";
        Nav.NavigateTo(dashboardUrl, forceLoad: true);
    }

    private void GoToCreateUser()
    {
        Nav.NavigateTo("/create-user");
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Indtast brugernavn")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Indtast password")]
        public string Password { get; set; } = string.Empty;
    }
}
