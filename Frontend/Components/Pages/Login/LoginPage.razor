@page "/"
@page "/login"
@layout EmptyLayout
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components

<div class="login-card">
    <h1 class="app-title">FitLife Fitness</h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }

    <EditForm Model="@loginModel" OnValidSubmit="OnLoginClicked" FormName="LoginForm">
        <DataAnnotationsValidator />
        <div class="form-group">
            <label for="username">Brugernavn</label>
            <InputText id="username" @bind-Value="loginModel.Username" class="input-field" disabled="@isLoading" />
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <InputText id="password" type="password" @bind-Value="loginModel.Password" class="input-field"
                disabled="@isLoading" />
        </div>
        <ValidationSummary />
        <button type="submit" class="primary-btn" disabled="@isLoading">
            @if (isLoading)
            {
                <span>Logger ind...</span>
            }
            else
            {
                <span>Log ind</span>
            }
        </button>
    </EditForm>
    <div class="login-links">
        <button type="button" class="link-btn">Glemt password?</button>
        <button type="button" class="link-btn">Opret bruger</button>
        <button type="button" class="primary-btn" @onclick="GoToDashboardNow">Fortsæt til dashboard</button>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginModel loginModel { get; set; } = new();

    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task OnLoginClicked()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result != null)
                {
                    // Save token and ensure it's flushed to storage
                    await TokenService.SaveTokenAsync(result.Token, result.User.Id, result.User.Username, result.User.Role);
                    
                    // Try to flush any pending values before navigating
                    try
                    {
                        await TokenService.FlushPendingAsync();
                        // Small delay to ensure storage write completes
                        await Task.Delay(50);
                    }
                    catch { }
                    
                    // Navigate WITHOUT force reload to preserve state
                    Nav.NavigateTo("/dashboard", forceLoad: false);
                    return;
                }
            }
            else
            {
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    errorMessage = "Forkert brugernavn eller password.";
                }
                else
                {
                    errorMessage = "Login mislykkedes. Prøv igen.";
                }
            }
        }
        catch (NavigationException)
        {
            // This is EXPECTED - it means navigation is working!
            // Blazor throws this to stop execution and navigate
            throw; // Re-throw to let Blazor handle the navigation
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Kunne ikke oprette forbindelse til serveren.";
            Console.WriteLine($"HTTP error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = "Der opstod en fejl. Prøv igen senere.";
            Console.WriteLine($"Exception: {ex.GetType().Name} - {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToDashboardNow()
    {
        // Use the current browser location to preserve the port
        var uri = new Uri(Nav.Uri);
        var dashboardUrl = $"{uri.Scheme}://{uri.Authority}/dashboard";
        Nav.NavigateTo(dashboardUrl, forceLoad: true);
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Indtast brugernavn")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Indtast password")]
        public string Password { get; set; } = string.Empty;
    }
}