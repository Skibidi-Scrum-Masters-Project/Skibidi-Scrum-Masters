@page "/login"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@layout PhoneLayoutWithoutNav
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.TokenAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components

<section class="login-page">

    <header class="login-hero">
        <div class="hero-icon">ðŸ”‘</div>
        <div class="hero-content">
            <h1 class="hero-title">FitLife Fitness</h1>
            <p class="hero-subtitle">Log ind for at se din status, dine hold og dit skab.</p>
        </div>
    </header>

    <main class="login-body">

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="state-card error">
                <div class="state-title">Noget gik galt</div>
                <div class="state-sub">@errorMessage</div>
            </div>
        }

        <EditForm Model="@loginModel" OnValidSubmit="OnLoginClicked" FormName="LoginForm" class="login-form">
            <DataAnnotationsValidator />

            <section class="card">
                <div class="card-title">Log ind</div>

                <div class="field">
                    <label for="username">Brugernavn</label>
                    <input id="username"
                           class="input"
                           @bind="loginModel.Username"
                           disabled="@isLoading"
                           autocomplete="username"
                           placeholder="Dit brugernavn" />
                </div>

                <div class="field">
                    <label for="password">Password</label>
                    <input id="password"
                           class="input"
                           type="password"
                           @bind="loginModel.Password"
                           disabled="@isLoading"
                           autocomplete="current-password"
                           placeholder="Dit password" />
                </div>

                <ValidationSummary />

                <button type="submit" class="primary" disabled="@isLoading">
                    @(isLoading ? "Logger ind..." : "Log ind")
                </button>
            </section>
        </EditForm>

        <div class="actions">
            <button type="button" class="ghost" disabled="@isLoading">Glemt password?</button>
            <button type="button" class="ghost" @onclick="GoToCreateUser" disabled="@isLoading">Opret bruger</button>
        </div>

        <button type="button" class="secondary" @onclick="GoToDashboardNow" disabled="@isLoading">
            FortsÃ¦t til dashboard
        </button>

        <button type="button" class="ghost" @onclick="OnLogoutClicked">Log ud (test)</button>

    </main>
</section>

@code {
    [SupplyParameterFromForm]
    private LoginModel loginModel { get; set; } = new();

    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private async Task OnLoginClicked()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            Console.WriteLine("=== LOGIN: Starting login process ===");
            var response = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result != null)
                {
                    Console.WriteLine($"=== LOGIN: Received token for user {result.User.Username} ===");
                    
                    // Save token to localStorage
                    await TokenService.SaveTokenAsync(
                        result.Token, 
                        result.User.Id!, 
                        result.User.Username, 
                        result.User.Role, 
                        result.RefreshToken
                    );

                    Console.WriteLine("=== LOGIN: Token saved, waiting 100ms ===");
                    // Give localStorage a moment to persist
                    await Task.Delay(100);

                    // Notify authentication state provider
                    try
                    {
                        await AuthStateProvider.NotifyAuthenticationStateChangedAsync();
                        Console.WriteLine("=== LOGIN: Auth state notified ===");
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"!!! LOGIN: Auth state notification failed: {ex.Message}");
                    }

                    Console.WriteLine("=== LOGIN: Navigating to dashboard ===");
                    // Navigate to dashboard
                    Nav.NavigateTo("/dashboard", forceLoad: false);
                    return;
                }
            }
            else
            {
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                    errorMessage = "Forkert brugernavn eller password.";
                else
                    errorMessage = "Login mislykkedes. PrÃ¸v igen.";
            }
        }
        catch (NavigationException)
        {
            // Allow navigation exceptions to propagate
            throw;
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"!!! LOGIN: HTTP error: {ex.Message}");
            errorMessage = "Kunne ikke oprette forbindelse til serveren.";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"!!! LOGIN: Unexpected error: {ex.Message}");
            errorMessage = "Der opstod en fejl. PrÃ¸v igen senere.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToDashboardNow()
    {
        var uri = new Uri(Nav.Uri);
        var dashboardUrl = $"{uri.Scheme}://{uri.Authority}/dashboard";
        Nav.NavigateTo(dashboardUrl, forceLoad: true);
    }

    private void GoToCreateUser() => Nav.NavigateTo("/create-user");

    private async Task OnLogoutClicked()
    {
        try
        {
            var LoggedInUserId = await TokenService.GetUserIdAsync();
            if (!string.IsNullOrEmpty(LoggedInUserId))
            {
                await AuthService.LogoutAsync(LoggedInUserId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout API call failed: {ex.Message}");
        }

        try
        {
            await TokenService.ClearAsync();
            AuthStateProvider.MarkUserLoggedOut();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout cleanup failed: {ex.Message}");
        }
        
        Nav.NavigateTo("/login", forceLoad: true);
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Indtast brugernavn")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Indtast password")]
        public string Password { get; set; } = string.Empty;
    }
}