@page "/post/{PostId}"
@layout PhoneLayout
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Services
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components
@using System.Net.Http.Json
@inject TokenService TokenService
@inject SocialService SocialService
@inject NavigationManager Nav

<div class="postpage" @onclick="CloseAllMenus">

    <header class="topbar">
        <div class="topbar-left">
            <button class="back-btn" type="button" @onclick:stopPropagation="true" @onclick="GoBack" aria-label="Tilbage">
                <span class="back-ico">‚Üê</span>
            </button>

            <div class="topbar-text">
                <h1 class="brand">Post</h1>
                <p class="welcome">Detaljer</p>
            </div>
        </div>

        @if (post != null && IsPostOwner(post))
        {
            <div class="topbar-right" style="position:relative;">
                <button class="icon-btn"
                        type="button"
                        aria-label="Menu"
                        @onclick:stopPropagation="true"
                        @onclick="TogglePostMenu">
                    ‚ãØ
                </button>

                @if (openPostMenu && (!post.IsDraft))
                {
                    <div class="comment-menu-dropdown" style="right:0;" @onclick:stopPropagation="true">
                        <button class="menu-item"
                                type="button"
                                @onclick="StartEditPost">
                            ‚úèÔ∏è Rediger post
                        </button>
                        <button class="menu-item delete"
                                type="button"
                                @onclick="ConfirmDeletePost">
                            üóëÔ∏è Slet post
                        </button>
                    </div>
                }
                @if (openPostMenu && (post.IsDraft))
                {
                    <div class="comment-menu-dropdown" style="right:0;" @onclick:stopPropagation="true">
                        <button class="menu-item"
                                type="button"
                                @onclick="PostDraft">
                            ‚úèÔ∏è Del post
                        </button>
                        <button class="menu-item delete"
                                type="button"
                                @onclick="ConfirmDeletePost">
                            üóëÔ∏è Slet post
                        </button>
                    </div>
                }
            </div>
        }
    </header>

    <main class="postpage-body">

        @if (isLoading)
        {
            <section class="state-wrap">
                <div class="state-card">
                    <div class="state-title">Loader post</div>
                    <div class="state-sub">Et √∏jeblik</div>
                </div>
            </section>
        }
        else if (!string.IsNullOrWhiteSpace(error))
        {
            <section class="state-wrap">
                <div class="state-card error">
                    <div class="state-title">Noget gik galt</div>
                    <div class="state-sub">@error</div>
                </div>
            </section>
        }
        else if (post == null)
        {
            <section class="state-wrap">
                <div class="state-card">
                    <div class="state-title">Post ikke fundet</div>
                    <div class="state-sub">Det post findes ikke l√¶ngere</div>
                </div>
            </section>
        }
        else
        {
            <section class="post-edge">
                <div class="post-hero @(post.Type == PostType.Workout ? "workout" : "")">

                    @if (post.Type == PostType.Workout)
                    {
                        <div class="workout-type-bar"></div>
                    }

                    <div class="post-hero-inner">
                        <div class="post-head">
                            <div class="post-avatar">@GetInitial(post.UserName ?? post.UserId)</div>

                            <div class="post-meta">
                                <div class="post-name">@GetDisplayName(post)</div>
                                <div class="post-sub">@FormatWhen(post.PostDate)</div>
                            </div>

                            <span class="post-pill @(post.Type == PostType.Workout ? "workout" : "")">
                                @GetTypeLabel(post.Type)
                            </span>
                        </div>

                        @if (isEditingPost)
                        {
                            <input class="post-title post-title-edit"
                                   @bind="editPostTitle"
                                   @ref="titleInputRef"
                                   placeholder="Titel"
                                   maxlength="120" />
                        }
                        else
                        {
                            <h2 class="post-title">@post.PostTitle</h2>
                        }

                        @if (post.Type == PostType.Workout)
                        {
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-icon">üí™</span>
                                    <span class="stat-value">@GetExercises(post)</span>
                                    <span class="stat-label">√òvelser</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-icon">‚è±</span>
                                    <span class="stat-value">@GetDurationMinutes(post)</span>
                                    <span class="stat-label">Min</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-icon">üî•</span>
                                    <span class="stat-value">@GetCalories(post)</span>
                                    <span class="stat-label">Cal</span>
                                </div>
                            </div>

                            <div class="intensity-section">
                                <div class="intensity-label">Intensitet</div>
                                <div class="intensity-bar">
                                    <div class="intensity-fill" style="width:@GetIntensityPercent(post)%"></div>
                                </div>
                            </div>

                            @if (post.IsDraft)
                            {
                                <div class="post-chips">
                                    <span class="chip chip-warn">Draft</span>
                                </div>
                            }
                        }
                        else if (post.IsDraft)
                        {
                            <div class="post-chips">
                                <span class="chip chip-warn">Draft</span>
                            </div>
                        }
                    </div>
                </div>

                <div class="post-body">
                    @if (isEditingPost)
                    {
                        <textarea class="comment-edit-input"
                                  @bind="editPostText"
                                  rows="5"></textarea>

                        <div class="comment-edit-actions">
                            <button class="edit-btn edit-btn-cancel"
                                    type="button"
                                    @onclick="CancelEditPost">
                                Annuller
                            </button>

                            <button class="edit-btn edit-btn-save"
                                    type="button"
                                    @onclick="SaveEditPost"
                                    disabled="@(
                                              string.IsNullOrWhiteSpace(editPostTitle) ||
                                              string.IsNullOrWhiteSpace(editPostText))">
                                Gem
                            </button>
                        </div>
                    }
                    else
                    {
                        <p class="post-text">@post.PostContent</p>
                    }
                </div>
            </section>

            <section class="comments-edge">
                <div class="comments-head">
                    <h2>Kommentarer</h2>
                    <div class="comments-meta">
                        <span class="comments-count">@((post.Comments?.Count ?? 0))</span>
                    </div>
                </div>

                @if (post.Comments is null || post.Comments.Count == 0)
                {
                    <div class="comments-empty">
                        <div class="state-title">Ingen kommentarer endnu</div>
                        <div class="state-sub">V√¶r den f√∏rste til at skrive noget</div>
                    </div>
                }
                else
                {
                    <div class="comment-list">
                        @foreach (var c in SortedComments)
                        {
                            <article class="comment-card">
                                <div class="comment-avatar">@GetInitial(c.AuthorName)</div>

                                <div class="comment-body">
                                    <div class="comment-top">
                                        <div class="comment-name">@GetCommentDisplayName(c)</div>
                                        <div class="comment-time">@FormatWhen(c.CommentDate)</div>

                                        @if (IsCommentOwner(c) && !string.IsNullOrWhiteSpace(c.Id))
                                        {
                                            <div style="position:relative;">
                                                <button class="comment-menu-btn"
                                                        type="button"
                                                        @onclick:stopPropagation="true"
                                                        @onclick="() => ToggleCommentMenu(c.Id!)">
                                                    ‚ãÆ
                                                </button>

                                                @if (!string.IsNullOrEmpty(openMenuCommentId) && openMenuCommentId == c.Id)
                                                {
                                                    <div class="comment-menu-dropdown" @onclick:stopPropagation="true">
                                                        <button class="menu-item"
                                                                type="button"
                                                                @onclick="() => StartEditComment(c)">
                                                            ‚úèÔ∏è Rediger
                                                        </button>
                                                        <button class="menu-item delete"
                                                                type="button"
                                                                @onclick="() => ConfirmDeleteComment(c.Id!)">
                                                            üóëÔ∏è Slet
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(editingCommentId) && editingCommentId == c.Id)
                                    {
                                        <div class="comment-edit-form">
                                            <textarea class="comment-edit-input"
                                                      @bind="editCommentText"
                                                      rows="3"></textarea>

                                            <div class="comment-edit-actions">
                                                <button class="edit-btn edit-btn-cancel"
                                                        type="button"
                                                        @onclick="CancelEdit">
                                                    Annuller
                                                </button>
                                                <button class="edit-btn edit-btn-save"
                                                        type="button"
                                                        @onclick="SaveEditComment"
                                                        disabled="@string.IsNullOrWhiteSpace(editCommentText)">
                                                    Gem
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="comment-text">@c.CommentText</div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
            </section>
        }

    </main>

    @if (post != null)
    {
        <div class="comment-composer" @onclick:stopPropagation="true">
            <div class="composer-inner">
                <div class="composer-avatar">@GetInitial(Username)</div>
                <input class="composer-input"
                       placeholder="Skriv en kommentar..."
                       @bind="newCommentText" />
                <button class="composer-send"
                        type="button"
                        @onclick="SendComment"
                        disabled="@IsSendDisabled">
                    Send
                </button>
            </div>
        </div>
    }

    <nav class="bottom-nav" @onclick:stopPropagation="true">
        <button class="bn-item" @onclick="GoToDashboard" type="button">‚åÇ Hjem</button>
        <button class="bn-item" @onclick="GoToTrainingPrograms" type="button">üí™ Tr√¶ning</button>
        <button class="bn-item" @onclick="GoToClasses" type="button">üóìÔ∏è Hold</button>
        <button class="bn-item active" @onclick="GoToFeed" type="button">üë• F√¶llesskab</button>
        <button class="bn-item" type="button">üö™ Adgang</button>
    </nav>

    @if (showDeleteConfirm)
    {
        <div class="delete-confirm-overlay" @onclick="CancelDelete">
            <div class="delete-confirm-dialog" @onclick:stopPropagation="true">
                <h3 class="delete-confirm-title">Slet kommentar?</h3>
                <p class="delete-confirm-text">
                    Er du sikker p√• at du vil slette denne kommentar? Dette kan ikke fortrydes.
                </p>
                <div class="delete-confirm-actions">
                    <button class="delete-confirm-btn cancel"
                            type="button"
                            @onclick="CancelDelete">
                        Annuller
                    </button>
                    <button class="delete-confirm-btn delete"
                            type="button"
                            @onclick="ExecuteDeleteComment">
                        Slet
                    </button>
                </div>
            </div>
        </div>
    }

    @if (showDeletePostConfirm)
    {
        <div class="delete-confirm-overlay" @onclick="CancelDeletePost">
            <div class="delete-confirm-dialog" @onclick:stopPropagation="true">
                <h3 class="delete-confirm-title">Slet post?</h3>
                <p class="delete-confirm-text">
                    Er du sikker p√• at du vil slette dette post? Dette kan ikke fortrydes.
                </p>
                <div class="delete-confirm-actions">
                    <button class="delete-confirm-btn cancel"
                            type="button"
                            @onclick="CancelDeletePost">
                        Annuller
                    </button>
                    <button class="delete-confirm-btn delete"
                            type="button"
                            @onclick="ExecuteDeletePost">
                        Slet
                    </button>
                </div>
            </div>
        </div>
    }

</div>

@code {
    [Parameter] public string? PostId { get; set; }
    private ElementReference titleInputRef;

    private string? LoggedInUserId;
    private string? Username;

    private bool isLoading;
    private string error = string.Empty;
    private Post? post;

    private bool openPostMenu;
    private bool isEditingPost;
    private string editPostTitle = string.Empty;
    private string editPostText = string.Empty;

    private string newCommentText = string.Empty;

    private string? openMenuCommentId;
    private string? editingCommentId;
    private string editCommentText = string.Empty;

    private bool showDeleteConfirm;
    private bool showDeletePostConfirm;
    private string? deleteCommentId;
    private string? jwt; 
    
    private bool IsSendDisabled =>
        string.IsNullOrWhiteSpace(newCommentText) || newCommentText.Trim().Length < 2;

    private List<Comment> SortedComments =>
        post?.Comments?
            .OrderByDescending(x => x.CommentDate)
            .ToList()
        ?? new List<Comment>();

    protected override async Task OnInitializedAsync()
    {
        LoggedInUserId = await TokenService.GetUserIdAsync();
        Username = await TokenService.GetUsernameAsync();
        jwt = await TokenService.GetTokenAsync();
        await LoadPostAsync();
    }

    private async Task LoadPostAsync()
    {
        isLoading = true;
        try
        {
            if (string.IsNullOrWhiteSpace(PostId))
            {
                error = "Mangler post id.";
                return;
            }

            var res = await SocialService.SeeSpecificPostByPostIdAsync(PostId, jwt ?? "");
            if (!res.IsSuccessStatusCode)
            {
                error = "Kunne ikke hente post.";
                return;
            }

            post = await res.Content.ReadFromJsonAsync<Post>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool IsPostOwner(Post p) =>
        string.Equals(p.UserId, LoggedInUserId, StringComparison.OrdinalIgnoreCase);

    private bool IsCommentOwner(Comment c) =>
        string.Equals(c.AuthorId, LoggedInUserId, StringComparison.OrdinalIgnoreCase);

    private void CloseAllMenus()
    {
        openPostMenu = false;
        openMenuCommentId = null;
    }

    private void TogglePostMenu()
    {
        openPostMenu = !openPostMenu;
        openMenuCommentId = null;
    }

    private async Task StartEditPost()
    {
        if (post == null) return;

        isEditingPost = true;
        editPostTitle = post.PostTitle;
        editPostText = post.PostContent ?? string.Empty;
        openPostMenu = false;

        await Task.Yield();
        await titleInputRef.FocusAsync();
    }

    private void CancelEditPost()
    {
        isEditingPost = false;
        editPostTitle = string.Empty;
        editPostText = string.Empty;
    }

    private async Task SaveEditPost()
    {
        if (post == null) return;

        if (string.IsNullOrWhiteSpace(LoggedInUserId))
        {
            error = "Du er ikke logget ind, s√• posten kan ikke gemmes.";
            return;
        }

        error = string.Empty;

        var payload = new Post
        {
            Id = post.Id,
            UserId = LoggedInUserId,
            PostTitle = editPostTitle.Trim(),
            PostContent = editPostText.Trim(),
            FitnessClassId = post.FitnessClassId,
            WorkoutId = post.WorkoutId
        };

        try
        {
            var res = await SocialService.EditAPostAsync(payload, jwt ?? "");

            if (!res.IsSuccessStatusCode)
            {
                var body = await res.Content.ReadAsStringAsync();
                error = $"Kunne ikke gemme post: {(int)res.StatusCode} {res.ReasonPhrase}. {body}";
                return;
            }

            post = await res.Content.ReadFromJsonAsync<Post>();

            isEditingPost = false;
            editPostTitle = string.Empty;
            editPostText = string.Empty;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            error = $"Kunne ikke gemme post: {ex.Message}";
        }
    }

    private void ConfirmDeletePost()
    {
        showDeletePostConfirm = true;
        openPostMenu = false;
    }

    private void CancelDeletePost()
    {
        showDeletePostConfirm = false;
    }

    private async Task ExecuteDeletePost()
    {
        if (string.IsNullOrWhiteSpace(PostId)) return;

        var res = await SocialService.RemoveAPostAsync(PostId, jwt ?? "");

        if (res.IsSuccessStatusCode)
        {
            showDeletePostConfirm = false;
            Nav.NavigateTo("/feedpage");
            return;
        }

        showDeletePostConfirm = false;
        error = $"Kunne ikke slette post: {(int)res.StatusCode} {res.ReasonPhrase}";
    }

    private void ToggleCommentMenu(string id)
    {
        openMenuCommentId = openMenuCommentId == id ? null : id;
        openPostMenu = false;
    }

    private void StartEditComment(Comment c)
    {
        editingCommentId = c.Id;
        editCommentText = c.CommentText ?? "";
        openMenuCommentId = null;
        openPostMenu = false;
    }

    private void CancelEdit()
    {
        editingCommentId = null;
        editCommentText = "";
    }

    private async Task SaveEditComment()
    {
        if (PostId is null || editingCommentId is null) return;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(Username))
        {
            error = "Du er ikke logget ind.";
            return;
        }

        var payload = new
        {
            Id = editingCommentId,
            AuthorId = LoggedInUserId,
            AuthorName = Username,
            CommentText = editCommentText.Trim()
        };

        var res = await SocialService.EditCommentAsync(PostId, payload, jwt ?? "");
        if (res.IsSuccessStatusCode)
            post = await res.Content.ReadFromJsonAsync<Post>();

        editingCommentId = null;
    }

    private void ConfirmDeleteComment(string id)
    {
        deleteCommentId = id;
        showDeleteConfirm = true;
        openMenuCommentId = null;
        openPostMenu = false;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        deleteCommentId = null;
    }

    private async Task ExecuteDeleteComment()
    {
        if (PostId is null || deleteCommentId is null) return;

        var res = await SocialService.RemoveACommentFromPostAsync(PostId, deleteCommentId, jwt ?? "");
        if (res.IsSuccessStatusCode)
            post = await res.Content.ReadFromJsonAsync<Post>();

        showDeleteConfirm = false;
        deleteCommentId = null;
    }

    private async Task PostDraft()
    {
        if (string.IsNullOrWhiteSpace(PostId))
        {
            error = "Mangler post id.";
            return;
        }

        error = string.Empty;

        try
        {
            var res = await SocialService.ChangeDraftStatusForPostAsync(PostId, jwt ?? "");

            if (!res.IsSuccessStatusCode)
            {
                var body = await res.Content.ReadAsStringAsync();
                error = $"Kunne ikke dele post: {(int)res.StatusCode} {res.ReasonPhrase}. {body}";
                return;
            }

            openPostMenu = false;

            // Tilbage til feed (Alle tabben)
            Nav.NavigateTo("/feedpage");
        }
        catch (Exception ex)
        {
            error = $"Kunne ikke dele post: {ex.Message}";
        }
    }


    private async Task SendComment()
    {
        if (PostId is null || IsSendDisabled) return;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(Username))
        {
            error = "Du er ikke logget ind.";
            return;
        }

        var payload = new
        {
            AuthorId = LoggedInUserId,
            AuthorName = Username,
            CommentText = newCommentText.Trim()
        };

        var res = await SocialService.AddACommentToPostAsync(PostId, payload, jwt ?? "");
        if (res.IsSuccessStatusCode)
            post = await res.Content.ReadFromJsonAsync<Post>();

        newCommentText = "";
    }

    private void GoBack() => Nav.NavigateTo("/feedpage");
    private void GoToDashboard() => Nav.NavigateTo("/dashboard");
    private void GoToTrainingPrograms() => Nav.NavigateTo("/training");
    private void GoToClasses() => Nav.NavigateTo("/classes");
    private void GoToFeed() => Nav.NavigateTo("/feedpage");

    private static string GetInitial(string? t) =>
        string.IsNullOrWhiteSpace(t) ? "?" : t.Trim()[0].ToString().ToUpperInvariant();

    private static string GetDisplayName(Post p) =>
        !string.IsNullOrWhiteSpace(p.UserName) ? p.UserName : "Bruger";

    private static string GetCommentDisplayName(Comment c) =>
        !string.IsNullOrWhiteSpace(c.AuthorName) ? c.AuthorName : "Bruger";

    private static string GetTypeLabel(PostType t) =>
        t == PostType.Workout ? "üí™ Workout" : "üìù Generic";

    private static int GetExercises(Post p) => p.WorkoutStats?.ExerciseCount ?? 0;

    private static int GetDurationMinutes(Post p) =>
        (int)Math.Round((p.WorkoutStats?.DurationSeconds ?? 0) / 60.0);

    private static int GetCalories(Post p) => p.WorkoutStats?.Calories ?? 0;

    private static int GetIntensityPercent(Post p)
    {
        var mins = GetDurationMinutes(p);
        if (mins == 0) return 50;
        return (int)Math.Clamp((GetCalories(p) / (double)mins / 15.0) * 100, 30, 100);
    }

    private static string FormatWhen(DateTime dt) =>
        dt == default ? "" : dt.ToString("dd-MM-yyyy HH:mm");
}
