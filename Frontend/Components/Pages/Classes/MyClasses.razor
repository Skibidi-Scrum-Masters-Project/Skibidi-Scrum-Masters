@page "/classes"
@rendermode InteractiveServer
@layout PhoneLayout
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components

<section class="classes-screen">
    <button class="secondary-btn classes-back" @onclick="GoToDashboard">Tilbage</button>

    <header class="classes-hero">
        <h2 class="classes-title">Mine hold</h2>
        <p class="classes-subtitle">Se dine kommende holdbookinger.</p>
    </header>

    <p class="classes-user">Bruger-id: @(userId ?? "ikke logget ind")</p>

    @if (!MyClassesList.Any())
    {
        <div class="classes-empty">Du har ingen bookede hold endnu.</div>
    }
    else
    {
        <div class="classes-list">
            @foreach (FitnessClass c in MyClassesList)
            {
                <article class="class-card" @onclick="() => GoToBooking(c)">
                    <div class="class-main">
                        <p class="class-name">@c.Name</p>
                        <p class="class-meta">@c.Date.ToString("dd/MM") • @c.Time</p>
                        <p class="class-location">@c.Location</p>
                    </div>

                    <div class="class-status-area">
                        <span class="class-status">@c.Category.ToString()</span>

                        @{
                            var waitIndex = -1;
                            var waitCount = 0;
                            if (!string.IsNullOrEmpty(userId) && c.WaitlistUserIds != null)
                            {
                                waitIndex = c.WaitlistUserIds.IndexOf(userId);
                                waitCount = c.WaitlistUserIds.Count;
                            }
                        }

                        @if (waitIndex >= 0)
                        {
                            <span class="class-waitlist">På venteliste #@((waitIndex + 1)) af @waitCount</span>
                        }

                        <button class="class-cancel" @onclick:stopPropagation @onclick="() => CancelClassBooking(c.Id!)">Afbryd</button>
                    </div>
                </article>
            }
        </div>
    }

    @if (userRole == UserRole.Coach)
    {
        <button class="primary-btn classes-cta" @onclick="GoToCreate">
            Opret nyt hold
        </button>
    }
    else
    {
        <button class="primary-btn classes-cta" @onclick="GoToBook">
            Book nyt hold
        </button>
    }
</section>

@code {

    private string? userId;
    private UserRole? userRole;
    private string jwt = "";
    private List<FitnessClass> MyClassesList = new();
    private bool isCancelling = false;

    private bool _loaded; // prevents double execution

    protected override async Task OnInitializedAsync()
    {
        // DO NOT call authenticated APIs here
        // This runs before ProtectedLocalStorage is available
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded)
            return;

        _loaded = true;

        // Ensure buffered login data is persisted


        // Load auth state
        userId = await TokenService.GetUserIdAsync();
     

        userRole = await TokenService.GetUserRoleAsync();
        jwt = await TokenService.GetTokenAsync() ?? "";

        await LoadClassesAsync();

        StateHasChanged();
    }

    private async Task LoadClassesAsync()
    {
        if (string.IsNullOrEmpty(userId))
            return;

        HttpResponseMessage response;

        if (userRole == UserRole.Coach)
        {
            response = await ClassService.GetClassesByCoachIdAsync(userId, jwt);
        }
        else
        {
            response = await ClassService.GetClassesByUserIdAsync(userId, jwt);
        }

        if (response.IsSuccessStatusCode)
        {
            MyClassesList =
                await response.Content.ReadFromJsonAsync<List<FitnessClass>>()
                ?? new List<FitnessClass>();

            MyClassesList = MyClassesList
                .OrderBy(c => c.Date)
                .ThenBy(c => c.Time)
                .ToList();
        }

    }

    private void GoToCreate()
        => Nav.NavigateTo("/classes/create");

    private void GoToBook()
        => Nav.NavigateTo("/classes/book");

    private void GoToBooking(FitnessClass c)
    {
        if (string.IsNullOrEmpty(c?.Id))
            return;

        if (userRole == UserRole.Coach)
        {
            Nav.NavigateTo($"/classes/coach/{c.Id}");
            return;
        }

        if (c.SeatBookingEnabled)
            Nav.NavigateTo($"/classes/seat/{c.Id}");
        else
            Nav.NavigateTo($"/classes/book/{c.Id}");
    }

    private void GoToDashboard()
        => Nav.NavigateTo("/dashboard");

    private async Task CancelClassBooking(string classId)
    {
        if (string.IsNullOrEmpty(userId))
            return;

        isCancelling = true;

        var response =
            await ClassService.CancelClassBookingForUserAsync(classId, userId, jwt);

        if (response.IsSuccessStatusCode)
        {
            await LoadClassesAsync();
        }

        isCancelling = false;
        StateHasChanged();
    }



    public class MyClassModel
    {
        public string Name { get; set; } = "";
        public DateOnly Date { get; set; }
        public string Time { get; set; } = "";
        public string Location { get; set; } = "";
        public string Status { get; set; } = "";
    }
}
