@page "/classes"
@layout EmptyLayout
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components
<div class="classes-screen">
    <h2 class="classes-title">Mine hold</h2>
    <p class="classes-subtitle">Se dine kommende holdbookinger.</p>
    <p class="classes-user">Bruger-id: @(userId ?? "ikke logget ind")</p>

    @if (!MyClassesList.Any())
    {
        <p class="classes-empty">Du har ingen bookede hold endnu.</p>
    }
    else
    {
        <div class="classes-list">
            @foreach (var c in MyClassesList)
            {
                <div class="class-card">
                    <div class="class-main">
                        <p class="class-name">@c.Name</p>
                        <p class="class-meta">@c.Date.ToString("dd/MM") â€¢ @c.Time</p>
                        <p class="class-location">@c.Location</p>
                    </div>
                    <div class="class-status-area">
                        <span class="class-status">@c.Status</span>
                        <button class="class-cancel">Afbryd</button>
                    </div>
                </div>
            }
        </div>
    }

    <button class="primary-btn classes-cta" @onclick="GoToBook">
        Book nyt hold
    </button>
</div>

@code {
    
    private string? userId;
    private List<FitnessClass> MyClassesList = new();
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // If token was buffered during prerender, attempt to persist it now
            await TokenService.FlushPendingAsync();
        }
    }
    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            // Not logged in, redirect to login
            Nav.NavigateTo("/login");
            return;
        }

        var response = await ClassService.GetClassesByUserIdAsync(userId);
        if (response.IsSuccessStatusCode)
        {
            MyClassesList = await response.Content.ReadFromJsonAsync<List<FitnessClass>>() ?? new List<FitnessClass>();
        }
    }

    private void GoToBook()
    {
        Nav.NavigateTo("/classes/book");
    }

    public class MyClassModel
    {
        public string Name { get; set; } = "";
        public DateOnly Date { get; set; }
        public string Time { get; set; } = "";
        public string Location { get; set; } = "";
        public string Status { get; set; } = "";
    }
}