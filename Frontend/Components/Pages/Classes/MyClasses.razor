@page "/classes"
@layout PhoneLayout
@using System.Net.Http.Json
@using System.Globalization
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components

@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@inject NavigationManager Nav

<div class="myclasses" @onclick="CloseAllMenus">

    <main class="myclasses-body">
        <section class="myclasses-shell">

            <div class="page-head">
                <div class="page-left">
                    <button class="back-btn" type="button" @onclick:stopPropagation="true" @onclick="GoToDashboard" aria-label="Tilbage">
                        <span class="back-ico">←</span>
                    </button>

                    <div class="page-text">
                        <h1 class="page-title">@PageTitle</h1>
                        <p class="page-sub">@PageSubtitle</p>
                    </div>
                </div>

                <div class="page-right" style="position:relative;">
                    <button class="icon-btn"
                            type="button"
                            aria-label="Menu"
                            @onclick:stopPropagation="true"
                            @onclick="ToggleMenu">
                        ⋯
                    </button>

                    @if (openMenu)
                    {
                        <div class="menu-dropdown" @onclick:stopPropagation="true">
                            <button class="menu-item" type="button" @onclick="Reload" disabled="@isLoading">
                                Opdater
                            </button>

                            @if (userRole == UserRole.Coach)
                            {
                                <button class="menu-item" type="button" @onclick="GoToCreate">
                                    Opret nyt hold
                                </button>
                            }
                            else
                            {
                                <button class="menu-item" type="button" @onclick="GoToBook">
                                    Book nyt hold
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (isLoading)
            {
                <div class="state-card">
                    <div class="state-title">Indlæser hold</div>
                    <div class="state-sub">Et øjeblik</div>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(loadError))
            {
                <div class="state-card error">
                    <div class="state-title">Noget gik galt</div>
                    <div class="state-sub">@loadError</div>
                </div>
            }
            else if (VisibleClasses.Count == 0)
            {
                <div class="state-card">
                    <div class="state-title">@EmptyTitle</div>
                    <div class="state-sub">@EmptySubtitle</div>
                </div>
            }
            else
            {
                <div class="toolbar">
                    <div class="search">
                        <span class="search-ico">⌕</span>
                        <input class="search-input"
                               placeholder="Søg i hold..."
                               @bind="search"
                               @bind:event="oninput" />
                    </div>
                </div>

                <div class="date-groups">
                    @foreach (var g in GroupedClasses)
                    {
                        <section class="date-group">
                            <div class="date-head">
                                <div class="date-title">@FormatDateHeader(g.Key)</div>
                                <div class="date-count">@g.Count() hold</div>
                            </div>

                            <div class="classes-list">
                                @foreach (var c in g)
                                {
                                    <article class="class-card" role="button" tabindex="0" @onclick="() => GoToBooking(c)">
                                        <div class="class-top">
                                            <div class="class-left">
                                                <div class="class-name">@c.Name</div>
                                                <div class="class-meta">@c.Time</div>
                                                <div class="class-location">Center: @c.Location</div>
                                            </div>

                                            <div class="class-right">
                                                <span class="pill green">@c.Category</span>
                                                <span class="pill yellow">@c.Intensity</span>
                                            </div>
                                        </div>

                                        @if (ShowWaitlistBadge(c))
                                        {
                                            <div class="waitlist-badge">
                                                Du er på venteliste som nummer @(GetWaitIndex(c) + 1) af @GetWaitCount(c)
                                            </div>
                                        }

                                        <div class="class-bottom">
                                            <div class="class-bottom-left">
                                                <span class="mini-pill">@CapacityText(c)</span>
                                            </div>
                                        </div>
                                    </article>
                                }
                            </div>
                        </section>
                    }
                </div>
            }

            <div class="cta-row">
                @if (userRole == UserRole.Coach)
                {
                    <button class="primary-btn cta-btn" type="button" @onclick="GoToCreate">
                        Opret nyt hold
                    </button>
                }
                else
                {
                    <button class="primary-btn cta-btn" type="button" @onclick="GoToBook">
                        Book nyt hold
                    </button>
                }
            </div>

        </section>
    </main>
</div>

@code {
    private string? userId;
    private UserRole? userRole;

    private bool isLoading;
    private string loadError = string.Empty;

    private List<FitnessClass> MyClassesList = new();

    private string search = string.Empty;

    private bool openMenu;

    private readonly CultureInfo da = CultureInfo.GetCultureInfo("da-DK");

    private string PageTitle => "Mine hold";
    private string PageSubtitle => userRole == UserRole.Coach ? "Se dine hold som coach." : "Se dine kommende holdbookinger.";

    private string EmptyTitle => userRole == UserRole.Coach ? "Ingen hold endnu" : "Ingen bookinger endnu";
    private string EmptySubtitle => userRole == UserRole.Coach
        ? "Du har ikke oprettet nogle hold endnu."
        : "Du har ingen bookede hold endnu.";

    private List<FitnessClass> VisibleClasses =>
        MyClassesList
            .Where(c => MatchesSearch(c, search))
            .OrderBy(c => c.Date)
            .ThenBy(c => c.Time)
            .ToList();

    private IEnumerable<IGrouping<DateOnly, FitnessClass>> GroupedClasses =>
        VisibleClasses.GroupBy(c => c.Date);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TokenService.FlushPendingAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }

        userRole = await TokenService.GetUserRoleAsync();
        await LoadClassesAsync();
    }

    private async Task LoadClassesAsync()
    {
        isLoading = true;
        loadError = string.Empty;

        try
        {
            if (string.IsNullOrWhiteSpace(userId))
            {
                loadError = "Kunne ikke finde bruger id. Log ind igen.";
                return;
            }

            HttpResponseMessage response =
                userRole == UserRole.Coach
                    ? await ClassService.GetClassesByCoachIdAsync(userId)
                    : await ClassService.GetClassesByUserIdAsync(userId);

            if (!response.IsSuccessStatusCode)
            {
                loadError = $"Kunne ikke hente hold. Status: {(int)response.StatusCode}";
                return;
            }

            MyClassesList = await response.Content.ReadFromJsonAsync<List<FitnessClass>>() ?? new List<FitnessClass>();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Reload()
    {
        openMenu = false;
        await LoadClassesAsync();
    }

    private void ToggleMenu()
    {
        openMenu = !openMenu;
    }

    private void CloseAllMenus()
    {
        openMenu = false;
    }

    private void GoToCreate()
    {
        openMenu = false;
        Nav.NavigateTo("/classes/create");
    }

    private void GoToBook()
    {
        openMenu = false;
        Nav.NavigateTo("/classes/book");
    }

    private void GoToDashboard()
    {
        Nav.NavigateTo("/dashboard");
    }

    private void GoToBooking(FitnessClass c)
    {
        if (c == null || string.IsNullOrWhiteSpace(c.Id)) return;

        if (userRole == UserRole.Coach)
        {
            Nav.NavigateTo($"/classes/coach/{c.Id}");
            return;
        }

        if (c.SeatBookingEnabled)
        {
            Nav.NavigateTo($"/classes/seat/{c.Id}");
        }
        else
        {
            Nav.NavigateTo($"/classes/book/{c.Id}");
        }
    }

    private static bool MatchesSearch(FitnessClass c, string needle)
    {
        if (string.IsNullOrWhiteSpace(needle)) return true;

        var n = needle.Trim().ToLowerInvariant();
        var hay =
            $"{c.Name} {c.Location} {c.Category} {c.Intensity} {c.Date:dd/MM} {c.Time}"
                .ToLowerInvariant();

        return hay.Contains(n);
    }

    private bool ShowWaitlistBadge(FitnessClass c)
    {
        if (string.IsNullOrWhiteSpace(userId)) return false;
        if (c.WaitlistUserIds == null) return false;
        return c.WaitlistUserIds.Contains(userId);
    }

    private int GetWaitIndex(FitnessClass c)
    {
        if (string.IsNullOrWhiteSpace(userId)) return -1;
        if (c.WaitlistUserIds == null) return -1;
        return c.WaitlistUserIds.IndexOf(userId);
    }

    private int GetWaitCount(FitnessClass c) => c.WaitlistUserIds?.Count ?? 0;

    private static string CapacityText(FitnessClass c)
    {
        var booked = c.BookingList?.Count ?? 0;
        var max = c.MaxCapacity;
        if (max <= 0) return "Kapacitet n/a";
        return $"{booked}/{max} pladser";
    }

    private string FormatDateHeader(DateOnly d)
    {
        var dt = d.ToDateTime(TimeOnly.MinValue);
        var s = dt.ToString("dddd dd.MM", da);
        return char.ToUpperInvariant(s[0]) + s.Substring(1);
    }
}
