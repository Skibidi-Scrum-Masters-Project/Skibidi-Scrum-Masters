@page "/classes"
@layout PhoneLayout
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components
<div class="classes-screen">
    <button class="secondary-btn classes-back" @onclick="GoToDashboard">Tilbage</button>
    <h2 class="classes-title">Mine hold</h2>
    <p class="classes-subtitle">Se dine kommende holdbookinger.</p>
    <p class="classes-user">Bruger-id: @(userId ?? "ikke logget ind")</p>

    @if (!MyClassesList.Any())
    {
        <p class="classes-empty">Du har ingen bookede hold endnu.</p>
    }
    else
    {
        <div class="classes-list">
            @foreach (FitnessClass c in MyClassesList)
            {
                <div class="class-card" @onclick="() => GoToBooking(c)" style="cursor:pointer;">
                    <div class="class-main">
                        <p class="class-name">@c.Name</p>
                        <p class="class-meta">@c.Date.ToString("dd/MM") • @c.Time</p>
                        <p class="class-location">@c.Location</p>
                    </div>
                    <div class="class-status-area">
                        <span class="class-status">@c.Category.ToString()</span>
                        @{ 
                            var waitIndex = -1;
                            var waitCount = 0;
                            if (!string.IsNullOrEmpty(userId) && c.WaitlistUserIds != null)
                            {
                                waitIndex = c.WaitlistUserIds.IndexOf(userId);
                                waitCount = c.WaitlistUserIds.Count;
                            }
                        }
                        @if (waitIndex >= 0)
                        {
                            <span class="class-waitlist">På venteliste #@((waitIndex + 1)) af @waitCount</span>
                        }
                        <button class="class-cancel" @onclick:stopPropagation @onclick="() => CancelClassBooking(c.Id!)">Afbryd</button>
                    </div>
                </div>
            }
        </div>
    }

    @if (userRole == UserRole.Coach)
    {
        <button class="primary-btn classes-cta" @onclick="GoToCreate">
            Opret nyt hold
        </button>
    }
    else
    {
        <button class="primary-btn classes-cta" @onclick="GoToBook">
            Book nyt hold
        </button>
    }
</div>

@code {
    
    private string? userId;
    private UserRole? userRole;
    private List<FitnessClass> MyClassesList = new();
    private bool isCancelling = false;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // If token was buffered during prerender, attempt to persist it now
            await TokenService.FlushPendingAsync();
        }
    }
    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            // Not logged in, redirect to login
            Nav.NavigateTo("/login");
            return;
        }

        userRole = await TokenService.GetUserRoleAsync();
        HttpResponseMessage response;
        if (userRole == UserRole.Coach)
        {
            response = await ClassService.GetClassesByCoachIdAsync(userId);
        }
        else
        {
            // Default/member behavior: load classes booked by the user
            response = await ClassService.GetClassesByUserIdAsync(userId);
        }

        if (response.IsSuccessStatusCode)
        {
            MyClassesList = await response.Content.ReadFromJsonAsync<List<FitnessClass>>() ?? new List<FitnessClass>();
            MyClassesList = MyClassesList.OrderBy(c => c.Date).ThenBy(c => c.Time).ToList();
        }
    }


    private void GoToCreate()
    {
        // Navigate to the class creation page (page not implemented yet)
        Nav.NavigateTo("/classes/create");
    }

    private void GoToBook()
    {
        // Navigate to the general class booking page
        Nav.NavigateTo("/classes/book");
    }

    private void GoToBooking(FitnessClass c)
    {
        if (c == null || string.IsNullOrEmpty(c.Id)) return;

        // Coaches should be taken to their coach view for the class
        if (userRole == UserRole.Coach)
        {
            Nav.NavigateTo($"/classes/coach/{c.Id}");
            return;
        }

        if (c.SeatBookingEnabled)
        {
            Nav.NavigateTo($"/classes/seat/{c.Id}");
        }
        else
        {
            Nav.NavigateTo($"/classes/book/{c.Id}");
        }
    }

    private void GoToDashboard()
    {
        Nav.NavigateTo("/dashboard");
    }

    private async Task CancelClassBooking(string classId)
    {
        if (string.IsNullOrEmpty(userId)) return;
        isCancelling = true;
        var response = await ClassService.CancelClassBookingForUserAsync(classId, userId);
        if (response.IsSuccessStatusCode)
        {
            // Refresh the list using the same role-based endpoint as on init
            HttpResponseMessage refreshed;
            var roleToUse = userRole ?? await TokenService.GetUserRoleAsync();
            if (roleToUse == UserRole.Coach)
            {
                refreshed = await ClassService.GetClassesByCoachIdAsync(userId);
            }
            else
            {
                refreshed = await ClassService.GetClassesByUserIdAsync(userId);
            }
            if (refreshed.IsSuccessStatusCode)
            {
                MyClassesList = await refreshed.Content.ReadFromJsonAsync<List<FitnessClass>>() ?? new List<FitnessClass>();
                MyClassesList = MyClassesList.OrderBy(c => c.Date).ThenBy(c => c.Time).ToList();
            }
        }
        isCancelling = false;
        StateHasChanged();
    }



    public class MyClassModel
    {
        public string Name { get; set; } = "";
        public DateOnly Date { get; set; }
        public string Time { get; set; } = "";
        public string Location { get; set; } = "";
        public string Status { get; set; } = "";
    }
}

<style>
    .classes-screen {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }

    .classes-title {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .classes-subtitle {
        font-size: 18px;
        margin-bottom: 20px;
        color: #666;
    }

    .classes-user {
        font-size: 14px;
        margin-bottom: 30px;
        color: #999;
    }

    .classes-empty {
        text-align: center;
        color: #999;
        font-style: italic;
    }

    .classes-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .class-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 15px;
        position: relative;
    }

    .class-main {
        margin-bottom: 10px;
    }

    .class-name {
        font-size: 18px;
        font-weight: 500;
        margin: 0;
    }

    .class-meta {
        font-size: 14px;
        color: #666;
        margin: 5px 0;
    }

    .class-location {
        font-size: 14px;
        color: #999;
        margin: 0;
    }

    .class-status-area {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto;
        gap: 6px 12px;
        align-items: center;
        margin-top: 10px;
        padding-bottom: 6px;
    }

    .class-status {
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 12px;
        background: #e0f7fa;
        color: #00796b;
        font-weight: 500;
    }

    .class-waitlist {
        font-size: 13px;
        padding: 4px 8px;
        border-radius: 12px;
        background: #fff3e0;
        color: #bf360c;
        font-weight: 600;
        grid-column: 1 / -1;
        justify-self: center;
        margin-top: 4px;
    }

    .class-status-area .class-status {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
        justify-self: start;
    }

    .class-status-area .class-cancel {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        justify-self: end;
    }

    .class-cancel {
        background: #ef5350;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .class-cancel:hover {
        background: #e53935;
    }

    .primary-btn {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .primary-btn:hover {
        background: #0056b3;
    }

    .secondary-btn {
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .secondary-btn:hover {
        background: #5a6268;
    }
</style>