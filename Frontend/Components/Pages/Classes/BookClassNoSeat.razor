@page "/classes/book/{Id}"
@layout PhoneLayout
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@inject FitLifeFitness.Services.SocialService SocialService
@inject FitLifeFitness.Services.UserService UserService
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Frontend.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

<section class="classd">

    <div class="classd-top">
        <button class="secondary-btn back" type="button" @onclick="GoBack">Tilbage</button>

        <button class="friends-btn"
                type="button"
                @onclick="ToggleFriendsMenu"
                disabled="@IsUserBooked">
            Book med venner
        </button>
    </div>

    <div class="classd-body">

        <header class="hero">
            <div class="hero-head">
                <div class="hero-title-wrap">
                    <h2 class="title">@ClassName</h2>
                    <div class="subtitle">@ClassDescription</div>
                </div>

                <div class="hero-badges">
                    <span class="pill intensity @GetIntensityClass()">@Intensity</span>

                    @if (IsUserBooked)
                    {
                        <span class="pill booked">Du er med</span>
                    }

                    @if (WaitlistPosition > 0)
                    {
                        <span class="pill waitlist">Venteliste #@WaitlistPosition</span>
                    }
                </div>
            </div>

            @if (SelectedClass is not null)
            {
                var booked = SelectedClass.BookingList?.Count ?? 0;
                var max = SelectedClass.MaxCapacity;
                var ratio = max <= 0 ? 0 : (double)booked / max;
                var barColor = GetCapacityColor(ratio);

                <div class="capacity">
                    <div class="cap-row">
                        <span class="cap-label">Pladser</span>
                        <span class="cap-value" style="color:@barColor">@booked/@max</span>
                    </div>

                    <div class="cap-bar">
                        <div class="cap-fill"
                             style="width:@(Math.Min(100, ratio * 100))%; background:@barColor">
                        </div>
                    </div>

                    <div class="cap-hint">
                        @(RemainingSpots <= 0 ? "Holdet er fyldt" : $"{RemainingSpots} ledige pladser")
                    </div>
                </div>
            }

            <div class="actions">
                @if (IsUserBooked)
                {
                    <button class="primary-btn danger" type="button" @onclick="CancelBooking">
                        Cancel booking
                    </button>
                }
                else
                {
                    <button class="primary-btn"
                            type="button"
                            @onclick="ConfirmSeat"
                            disabled="@(!CanConfirmBooking)">
                        Bekr√¶ft booking
                    </button>
                }
            </div>

            <div class="mini-meta">
                @(SelectedFriends.Count > 0
                    ? $"Du booker ogs√• {SelectedFriends.Count} ven(ner)"
                    : "Book alene eller sammen med venner")
            </div>
        </header>

        @if (!string.IsNullOrEmpty(BookingMessage))
        {
            <div class="message @(BookingMessage.Contains("fejl") ? "error" : "ok")">
                @BookingMessage
            </div>
        }

    </div>

    @if (ShowFriendsMenu)
    {
        <div class="sheet-backdrop" @onclick="ToggleFriendsMenu">
            <div class="sheet" @onclick:stopPropagation="true">

                <div class="sheet-handle"></div>

                <div class="sheet-head">
                    <div class="sheet-title">Book med venner</div>
                    <button class="icon-x" type="button" @onclick="ToggleFriendsMenu">‚úï</button>
                </div>

                <div class="sheet-body">

                    <div class="hint">
                        Du kan maks booke @RemainingSpots pladser inkl dig selv.
                        Lige nu booker du @TotalBookingCount.
                    </div>

                    <div class="search">
                        <span class="search-ico">üîç</span>
                        <input class="search-input"
                               placeholder="S√∏g efter venner"
                               @oninput="OnFriendSearch"
                               @onkeydown="OnFriendSearchKeyDown"
                               value="@FriendSearchTerm" />
                    </div>

                    <div class="section-title">S√∏geresultater</div>

                    @if (SearchResults.Count == 0 && !string.IsNullOrWhiteSpace(FriendSearchTerm))
                    {
                        <div class="empty">Ingen match</div>
                    }
                    else
                    {
                        <div class="results">
                            @foreach (var friend in SearchResults)
                            {
                                var isSelected = SelectedFriends.Any(f => f.Id == friend.Id);

                                <button class="result-row @(isSelected ? "selected" : "")"
                                        type="button"
                                        @onclick="() => ToggleFriendSelection(friend)">
                                    <div class="rr-name">@friend.FirstName @friend.LastName</div>
                                    <span class="tag @(isSelected ? "" : "ghost")">
                                        @(isSelected ? "Valgt" : "Tilf√∏j")
                                    </span>
                                </button>
                            }
                        </div>
                    }

                    <div class="section-title">Valgte venner</div>

                    @if (SelectedFriends.Count == 0)
                    {
                        <div class="empty">Ingen valgt endnu</div>
                    }
                    else
                    {
                        <div class="chips">
                            @foreach (var friend in SelectedFriends)
                            {
                                <div class="chip">
                                    <span>@friend.FirstName</span>
                                    <button class="chip-x" @onclick="() => RemoveFriend(friend)">‚úï</button>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="sheet-foot">
                    <button class="primary-btn"
                            type="button"
                            @onclick="ConfirmSeat"
                            disabled="@(!CanConfirmBooking)">
                        Bekr√¶ft booking
                    </button>
                </div>

            </div>
        </div>
    }

</section>

@code {
    [Parameter] public string? Id { get; set; }
    private FitnessClass? SelectedClass { get; set; }
    private string ClassName { get; set; } = "Indl√¶ser...";
    private string ClassDescription { get; set; } = "Indl√¶ser...";
    private Intensity Intensity { get; set; } = Intensity.Medium;
    public string? userId { get; set; }
    private string BookingMessage { get; set; } = string.Empty;
    private bool ShowFriendsMenu { get; set; } = false;

    private List<Friendship> FriendIds { get; set; } = new();
    private List<UserDto> FriendList { get; set; } = new();

    private List<UserDto> SelectedFriends { get; set; } = new();
    private bool HasSelectedFriends => SelectedFriends.Count > 0;
    private int RemainingSpots => SelectedClass == null ? 0 : SelectedClass.MaxCapacity - (SelectedClass.BookingList?.Count ?? 0);
    private int TotalBookingCount => SelectedFriends.Count + 1;
    private bool CanConfirmBooking => TotalBookingCount > 0 && TotalBookingCount <= RemainingSpots;
    private bool CanAddMoreFriends => TotalBookingCount < RemainingSpots;
    private string FriendSearchTerm { get; set; } = string.Empty;
    private List<UserDto> SearchResults { get; set; } = new();

    private List<UserDto> FriendsAlreadyInClass { get; set; } = new();
    private string jwt { get; set; } = string.Empty;

    private bool IsUserBooked => SelectedClass != null && !string.IsNullOrEmpty(userId) && (
        (SelectedClass.BookingList?.Any(b => b.UserId == userId) == true) ||
        (SelectedClass.WaitlistUserIds?.Contains(userId) == true)
    );

    private int WaitlistPosition => SelectedClass != null && !string.IsNullOrEmpty(userId) && SelectedClass.WaitlistUserIds != null
        ? SelectedClass.WaitlistUserIds.IndexOf(userId) + 1
        : 0;

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }
        jwt = await TokenService.GetTokenAsync() ?? string.Empty;

        var friendsResp = await SocialService.GetAllFriendsAsync(userId);
        if (friendsResp.IsSuccessStatusCode)
        {
            FriendIds = await friendsResp.Content.ReadFromJsonAsync<List<Friendship>>() ?? new();

            foreach (var friendship in FriendIds)
            {
                var friendId = friendship.SenderId == userId ? friendship.ReceiverId : friendship.SenderId;
                if (string.IsNullOrEmpty(friendId)) continue;

                var userResponse = await UserService.GetUserByIdAsync(friendId);
                if (userResponse.IsSuccessStatusCode)
                {
                    var user = await userResponse.Content.ReadFromJsonAsync<UserDto>();
                    if (user != null) FriendList.Add(user);
                }
            }
        }

        var response = await ClassService.GetClassByIdAsync(Id!, jwt!);
        if (response.IsSuccessStatusCode)
        {
            SelectedClass = await response.Content.ReadFromJsonAsync<FitnessClass>();
            if (SelectedClass == null)
            {
                ClassName = "Ukendt hold";
                return;
            }

            ClassName = SelectedClass.Name ?? "Ukendt hold";
            ClassDescription = SelectedClass.Description ?? "Ukendt hold beskrivelse";
            Intensity = SelectedClass.Intensity;

            BuildFriendsAlreadyInClass();
        }
        else
        {
            ClassName = "Ukendt hold";
        }
    }

    private void BuildFriendsAlreadyInClass()
    {
        FriendsAlreadyInClass = new();

        if (SelectedClass?.BookingList == null || FriendList.Count == 0) return;

        var friendIds = FriendList
            .Select(f => f.Id)
            .Where(id => !string.IsNullOrWhiteSpace(id))
            .ToHashSet();

        var bookedFriendIds = SelectedClass.BookingList
            .Select(b => b.UserId)
            .Where(id => !string.IsNullOrWhiteSpace(id))
            .ToHashSet();

        var inClass = bookedFriendIds.Intersect(friendIds).ToHashSet();

        FriendsAlreadyInClass = FriendList
            .Where(f => !string.IsNullOrWhiteSpace(f.Id) && inClass.Contains(f.Id))
            .ToList();
    }

    private string GetIntensityClass()
    {
        return Intensity switch
        {
            Intensity.Easy => "easy",
            Intensity.Medium => "medium",
            Intensity.Hard => "hard",
            _ => "medium"
        };
    }

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, 1).ToUpperInvariant();
        return (parts[0].Substring(0, 1) + parts[^1].Substring(0, 1)).ToUpperInvariant();
    }

    private async Task ConfirmSeat()
    {
        if (!CanConfirmBooking || SelectedClass == null) return;

        if (!HasSelectedFriends)
        {
            var classResponse = await ClassService.BookClassForUserAsync(SelectedClass.Id!.ToString(), userId!,jwt);
            if (classResponse.IsSuccessStatusCode)
            {
                BookingMessage = "Din booking er nu registreret! Du sendes tilbage til oversigten.";
                StateHasChanged();
                await Task.Delay(1400);
                Nav.NavigateTo("/classes");
            }
            else
            {
                BookingMessage = "Der opstod en fejl ved booking af holdet.";
            }
            return;
        }

        var friends = SelectedFriends.Select(f => f.Id!).ToList();
        var response = await ClassService.BookClassForUserWithFriendsAsync(SelectedClass.Id!.ToString(), userId!, friends, jwt!);

        if (response.IsSuccessStatusCode)
        {
            BookingMessage = "Booking for gruppen er nu registreret! Du sendes tilbage til oversigten.";
            StateHasChanged();
            await Task.Delay(1400);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved booking af gruppen.";
        }
    }

    private async Task CancelBooking()
    {
        if (SelectedClass == null || string.IsNullOrEmpty(userId)) return;

        var resp = await ClassService.CancelClassBookingForUserAsync(SelectedClass.Id!.ToString(), userId!, jwt!);
        if (resp.IsSuccessStatusCode)
        {
            BookingMessage = "Din booking er annulleret.";

            var fresh = await ClassService.GetClassByIdAsync(Id, jwt!);
            if (fresh.IsSuccessStatusCode)
            {
                SelectedClass = await fresh.Content.ReadFromJsonAsync<FitnessClass>();
                BuildFriendsAlreadyInClass();
            }

            StateHasChanged();
            await Task.Delay(1200);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved annullering.";
        }
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("eval", "if(history.length>1) history.back(); else window.location.href='/dashboard';");
    }

    private void ToggleFriendsMenu()
    {
        if (IsUserBooked)
        {
            BookingMessage = "Du er allerede booket eller p√• venteliste. Du kan ikke tilf√∏je venner.";
            return;
        }

        BookingMessage = string.Empty;
        ShowFriendsMenu = !ShowFriendsMenu;

        if (!ShowFriendsMenu)
        {
            FriendSearchTerm = string.Empty;
            SearchResults = new();
        }
    }

    private async Task OnFriendSearch(ChangeEventArgs e)
    {
        FriendSearchTerm = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(FriendSearchTerm))
        {
            SearchResults = new();
        }
        else
        {
            SearchResults = FriendList
                .Where(f =>
                    (f.FirstName ?? "").Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (f.LastName ?? "").Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        await Task.Yield();
        StateHasChanged();
    }

    private void ToggleFriendSelection(UserDto friend)
    {
        if (IsUserBooked)
        {
            BookingMessage = "Du er allerede booket eller p√• venteliste. Du kan ikke tilf√∏je venner.";
            StateHasChanged();
            return;
        }

        BookingMessage = string.Empty;

        if (SelectedClass != null && !string.IsNullOrEmpty(friend.Id))
        {
            var alreadyBooked = SelectedClass.BookingList?.Any(b => b.UserId == friend.Id) == true;
            var onWaitlist = SelectedClass.WaitlistUserIds?.Contains(friend.Id) == true;

            if (alreadyBooked)
            {
                BookingMessage = $"{friend.FirstName} er allerede booket p√• dette hold";
                StateHasChanged();
                return;
            }

            if (onWaitlist)
            {
                BookingMessage = $"{friend.FirstName} er p√• venteliste for dette hold";
                StateHasChanged();
                return;
            }
        }

        if (SelectedFriends.Any(f => f.Id == friend.Id))
        {
            SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        }
        else if (CanAddMoreFriends)
        {
            SelectedFriends.Add(friend);
            FriendSearchTerm = string.Empty;
            SearchResults = new();
        }
    }

    private async Task OnFriendSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && SearchResults.Count == 1)
        {
            ToggleFriendSelection(SearchResults[0]);
            await Task.Yield();
            StateHasChanged();
        }
    }

    private void RemoveFriend(UserDto friend)
    {
        SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        BookingMessage = string.Empty;
    }

    private string GetCapacityColor(double ratio)
    {
        if (ratio >= 1.0) return "rgb(235, 72, 72)";
        if (ratio >= 0.8) return "rgb(255, 193, 7)";
        return "rgb(36, 195, 106)";
    }
}
