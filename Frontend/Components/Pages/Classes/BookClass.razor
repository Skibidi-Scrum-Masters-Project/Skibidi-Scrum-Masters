@page "/classes/book"
@layout EmptyLayout
@inject FitLifeFitness.Services.AuthService AuthService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.ClassService ClassService
@using System.ComponentModel.DataAnnotations
@using FitLifeFitness.Components.Layout
@using System.Net.Http.Json
@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components
<div class="book-screen">
    <button class="secondary-btn book-back" @onclick="GoBack">Tilbage</button>
    <h2 class="book-title">Book hold</h2>
    <p class="book-subtitle">Vælg et hold du vil booke.</p>

    <div class="book-list">
        @foreach (FitnessClass c in AvailableClasses)
        {
            @if (c.SeatBookingEnabled == false)
            {
                var isFull = c.BookingList.Count >= c.MaxCapacity;
                <button class="book-card @(isFull ? "full" : "available")" @onclick="() => GoToBooking(c.Id)">
                    <div class="book-main">
                        <p class="book-name">@c.Name</p>
                        <p class="book-meta">@c.Date.ToString("dd/MM") • @c.Time</p>
                    </div>
                    <div class="book-extra">
                        <p class="book-type">@c.Category</p>
                        <p class="book-spots">@c.BookingList.Count/@c.MaxCapacity pladser</p>
                        <p class="book-location">@c.Intensity</p>
                    </div>
                </button>
            }
            var isFullSeat = c.BookingList.Count >= c.MaxCapacity;
            <button class="book-card @(isFullSeat ? "full" : "available")" @onclick="() => ChooseSeat(c.Id)">
                <div class="book-main">
                    <p class="book-name">@c.Name</p>
                    <p class="book-meta">@c.Date.ToString("dd/MM") • @c.Time</p>
                </div>
                <div class="book-extra">
                    <p class="book-type">@c.Category</p>
                    <p class="book-spots">@c.BookingList.Count/@c.MaxCapacity pladser</p>
                    <p class="book-location">@c.Intensity</p>
                </div>
            </button>

        }
    </div>
</div>

<style>
.book-card.available {
    background: #e8f5e9 !important;
}
.book-card.full {
    background: #ffebee !important;
}
</style>

@code {
    private string? userId;
    private List<FitnessClass> AvailableClasses = new List<FitnessClass> ();
    [Inject] private NavigationManager Nav { get; set; } = default!;
    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            // Not logged in, redirect to login
            Nav.NavigateTo("/login");
            return;
        }

        var response = await ClassService.GetAllAvailableClassesAsync();
        if (response.IsSuccessStatusCode)
        {
            AvailableClasses = await response.Content.ReadFromJsonAsync<List<FitnessClass>>() ?? new List<FitnessClass>();
        }
    }

    
    private void ChooseSeat(string? ClassId)
    {
        if (ClassId == null) return;
            Nav.NavigateTo($"/classes/seat/{ClassId}");
    }
    private void GoBack()
    {
        Nav.NavigateTo("/classes");
    }
    private void GoToBooking(string? ClassId)
    {
        if (ClassId == null) return;
            Nav.NavigateTo($"/classes/book/{ClassId}/confirm");
    }


    public class ClassOption
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public DateOnly Date { get; set; }
        public string Time { get; set; } = "";
        public string Location { get; set; } = "";
        public int SpotsTaken { get; set; }
        public int SpotsTotal { get; set; }
    }
}