@page "/classes/coach/{classId}"
@layout PhoneLayout
@using System.Net.Http.Json
@using System.Linq
@using FitLifeFitness.Components.Layout
@using FitlifeFitness.Models
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components

@inject FitLifeFitness.Services.ClassService ClassService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.UserService UserService
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS

<div class="coachclass" @onclick="CloseAllMenus">

    <main class="coach-body">
        <section class="coach-shell">

            <div class="page-head">
                <div class="page-left">
                    <button class="back-btn" type="button" @onclick:stopPropagation="true" @onclick="GoToClasses" aria-label="Tilbage">
                        <span class="back-ico">←</span>
                    </button>

                    <div class="page-text">
                        <h1 class="page-title">Coach</h1>
                        <p class="page-sub">@TopSubtitle</p>
                    </div>
                </div>

                @if (!isLoading && !loadError && fitnessClass != null)
                {
                    <div class="page-right" style="position:relative;">
                        <button class="icon-btn"
                                type="button"
                                aria-label="Menu"
                                @onclick:stopPropagation="true"
                                @onclick="ToggleMenu">
                            ⋯
                        </button>

                        @if (openMenu)
                        {
                            <div class="menu-dropdown" @onclick:stopPropagation="true">
                                <button class="menu-item" type="button" @onclick="GoToEdit">Rediger hold</button>
                                <button class="menu-item delete" type="button" @onclick="ConfirmDelete" disabled="@isActing">
                                    Slet hold
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>

            @if (isLoading)
            {
                <div class="state-card">
                    <div class="state-title">Indlæser hold</div>
                    <div class="state-sub">Et øjeblik</div>
                </div>
            }
            else if (loadError)
            {
                <div class="state-card error">
                    <div class="state-title">Kunne ikke indlæse holdet</div>
                    <div class="state-sub">@error</div>
                </div>
            }
            else if (fitnessClass == null)
            {
                <div class="state-card">
                    <div class="state-title">Hold ikke fundet</div>
                    <div class="state-sub">Det hold findes ikke længere</div>
                </div>
            }
            else
            {
                <section class="hero">

                    <div class="hero-top">
                        <div class="hero-left">
                            <h2 class="title">@fitnessClass.Name</h2>

                            <div class="meta-line">
                                <span class="meta-item">@FormatDate(fitnessClass.StartTime) · @fitnessClass.Time</span>
                                <span class="meta-dot">•</span>
                                <span class="meta-item">@fitnessClass.Location</span>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(fitnessClass.Description))
                            {
                                <div class="desc">@fitnessClass.Description</div>
                            }
                        </div>

                        <div class="hero-right">
                            <span class="pill green">@fitnessClass.Category</span>
                            <span class="pill yellow">@fitnessClass.Intensity</span>
                        </div>
                    </div>

                    <div class="capacity-card">
                        <div class="cap-row">
                            <span class="cap-label">Kapacitet</span>
                            <span class="cap-value" style="color:@CapacityColor">@BookedCount / @fitnessClass.MaxCapacity</span>
                        </div>

                        <div class="cap-bar">
                            <div class="cap-fill" style="width:@CapacityPercent%; background:@CapacityColor;"></div>
                        </div>

                        <div class="cap-hint">@CapacityHint</div>
                    </div>

                    <div class="quick-stats">
                        <div class="stat stat-green">
                            <div class="stat-value">@BookedCount</div>
                            <div class="stat-label">Bookinger</div>
                        </div>
                        <div class="stat stat-yellow">
                            <div class="stat-value">@WaitlistCount</div>
                            <div class="stat-label">Venteliste</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">@fitnessClass.MaxCapacity</div>
                            <div class="stat-label">Pladser</div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(statusMessage))
                    {
                        <div class="message ok">@statusMessage</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(actionError))
                    {
                        <div class="message error">@actionError</div>
                    }

                    <div class="actions">
                        <button class="secondary-btn" type="button" @onclick="GoToSeatMap">
                            Sædeoversigt
                        </button>
                        <button class="primary-btn" type="button" @onclick="FinishClass" disabled="@isActing">
                            @(isActing ? "Arbejder..." : "Afslut træning")
                        </button>
                    </div>
                </section>

                <section class="panel">
                    <div class="tabs" role="tablist" aria-label="Bookings tabs">
                        <button class="tab @(activeTab == "bookings" ? "active" : "")"
                                type="button"
                                role="tab"
                                aria-selected="@(activeTab == "bookings")"
                                @onclick='() => SwitchTab("bookings")'>
                            Bookinger
                            <span class="tab-count">@BookedCount</span>
                        </button>

                        <button class="tab @(activeTab == "waitlist" ? "active" : "")"
                                type="button"
                                role="tab"
                                aria-selected="@(activeTab == "waitlist")"
                                @onclick='() => SwitchTab("waitlist")'>
                            Venteliste
                            <span class="tab-count">@WaitlistCount</span>
                        </button>
                    </div>

                    <div class="toolbar">
                        <div class="search">
                            <span class="search-ico">⌕</span>
                            <input class="search-input"
                                   placeholder="Søg navn..."
                                   @bind="search"
                                   @bind:event="oninput" />
                        </div>

                        <button class="ghost-btn"
                                type="button"
                                @onclick="CopyVisibleNames"
                                disabled="@(!HasAnythingVisible)">
                            Kopier navne
                        </button>
                    </div>

                    @if (activeTab == "bookings")
                    {
                        @if (FilteredBookings.Count == 0)
                        {
                            <div class="empty">Ingen bookinger fundet</div>
                        }
                        else
                        {
                            <div class="list">
                                @foreach (var b in FilteredBookings)
                                {
                                    var name = GetDisplayName(b.UserId);

                                    <article class="row">
                                        <div class="row-left">
                                            <div class="row-title">@name</div>

                                            <div class="row-sub">
                                                Plads: @SeatText(b)
                                            </div>
                                        </div>

                                        <div class="row-right">
                                            <button class="mini-btn"
                                                    type="button"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="() => CopyOne(name)">
                                                Kopier
                                            </button>
                                        </div>
                                    </article>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        @if (FilteredWaitlist.Count == 0)
                        {
                            <div class="empty">Ingen på venteliste</div>
                        }
                        else
                        {
                            <div class="list">
                                @foreach (var uid in FilteredWaitlist)
                                {
                                    var name = GetDisplayName(uid);

                                    <article class="row">
                                        <div class="row-left">
                                            <div class="row-title">@name</div>
                                            <div class="row-sub">Venteliste</div>
                                        </div>

                                        <div class="row-right">
                                            <button class="mini-btn"
                                                    type="button"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="() => CopyOne(name)">
                                                Kopier
                                            </button>
                                        </div>
                                    </article>
                                }
                            </div>
                        }
                    }
                </section>
            }

        </section>
    </main>

    @if (showDeleteConfirm)
    {
        <div class="confirm-backdrop" role="presentation" @onclick="CancelDelete">
            <div class="confirm-dialog" role="dialog" aria-modal="true" @onclick:stopPropagation="true">
                <div class="confirm-title">Slet hold?</div>
                <div class="confirm-text">
                    Er du sikker på at du vil slette dette hold? Dette kan ikke fortrydes.
                </div>

                <div class="confirm-actions">
                    <button class="confirm-btn cancel" type="button" @onclick="CancelDelete" disabled="@isActing">
                        Annuller
                    </button>
                    <button class="confirm-btn delete" type="button" @onclick="DeleteClass" disabled="@isActing">
                        @(isActing ? "Arbejder..." : "Slet")
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string? classId { get; set; }

    private FitnessClass? fitnessClass;

    private bool isLoading = true;
    private bool loadError;
    private string error = string.Empty;

    private bool isActing;
    private string statusMessage = string.Empty;
    private string actionError = string.Empty;

    private string activeTab = "bookings";
    private string search = string.Empty;

    private bool openMenu;
    private bool showDeleteConfirm;

    private Dictionary<string, UserDto> usersById = new(StringComparer.OrdinalIgnoreCase);

    private string TopSubtitle =>
        fitnessClass == null
            ? "Hold detaljer"
            : $"{FormatDate(fitnessClass.StartTime)} · {fitnessClass.Time}";

    private int BookedCount => fitnessClass?.BookingList?.Count ?? 0;
    private int WaitlistCount => fitnessClass?.WaitlistUserIds?.Count ?? 0;

    private int CapacityPercent
    {
        get
        {
            if (fitnessClass == null) return 0;
            if (fitnessClass.MaxCapacity <= 0) return 0;
            var pct = (BookedCount / (double)fitnessClass.MaxCapacity) * 100.0;
            return (int)Math.Clamp(pct, 0, 100);
        }
    }

    private string CapacityColor
    {
        get
        {
            if (fitnessClass == null) return "rgba(36,195,106,1)";
            if (CapacityPercent >= 100) return "rgba(235,72,72,1)";
            if (CapacityPercent >= 75) return "rgba(242,181,15,1)";
            return "rgba(36,195,106,1)";
        }
    }

    private string CapacityHint
    {
        get
        {
            if (fitnessClass == null) return "";
            if (CapacityPercent >= 100) return "Holdet er fyldt";
            if (CapacityPercent >= 75) return "Tæt på fyldt";
            return "Der er stadig pladser";
        }
    }

    private List<Booking> FilteredBookings =>
        fitnessClass?.BookingList?
            .Where(b => MatchesSearch(GetDisplayName(b.UserId), search))
            .OrderBy(b => GetDisplayName(b.UserId))
            .ToList()
        ?? new List<Booking>();

    private List<string> FilteredWaitlist =>
        fitnessClass?.WaitlistUserIds?
            .Where(uid => MatchesSearch(GetDisplayName(uid), search))
            .OrderBy(uid => GetDisplayName(uid))
            .ToList()
        ?? new List<string>();

    private bool HasAnythingVisible =>
        activeTab == "bookings" ? FilteredBookings.Count > 0 : FilteredWaitlist.Count > 0;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(classId))
        {
            loadError = true;
            error = "Mangler class id.";
            isLoading = false;
            return;
        }

        await LoadUsers();
        await LoadClass();
    }

    private async Task LoadUsers()
    {
        try
        {
            var res = await UserService.GetAllUsersAsync();
            if (!res.IsSuccessStatusCode) return;

            var users = await res.Content.ReadFromJsonAsync<List<UserDto>>() ?? new List<UserDto>();
            usersById = users
                .Where(u => !string.IsNullOrWhiteSpace(u.Id))
                .GroupBy(u => u.Id!, StringComparer.OrdinalIgnoreCase)
                .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);
        }
        catch
        {
            // ignore, fallback til id
        }
    }

    private async Task LoadClass()
    {
        isLoading = true;
        loadError = false;
        error = string.Empty;
        statusMessage = string.Empty;
        actionError = string.Empty;

        try
        {
            var resp = await ClassService.GetClassByIdAsync(classId!);
            if (!resp.IsSuccessStatusCode)
            {
                loadError = true;
                error = $"Kunne ikke hente hold. Status: {(int)resp.StatusCode}";
                return;
            }

            fitnessClass = await resp.Content.ReadFromJsonAsync<FitnessClass>();
        }
        catch (Exception ex)
        {
            loadError = true;
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToClasses() => Nav.NavigateTo("/classes");

    private void GoToEdit()
    {
        if (string.IsNullOrWhiteSpace(classId)) return;
        Nav.NavigateTo($"/classes/coach/{classId}/edit");
        openMenu = false;
    }
    
    private void GoToSeatMap()
    {
        if (string.IsNullOrWhiteSpace(classId)) return;
        Nav.NavigateTo($"/classes/seat/coach/{classId}");
        openMenu = false;
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        statusMessage = string.Empty;
        actionError = string.Empty;
    }

    private void ToggleMenu()
    {
        openMenu = !openMenu;
        showDeleteConfirm = false;
    }

    private void CloseAllMenus()
    {
        openMenu = false;
    }

    private void ConfirmDelete()
    {
        showDeleteConfirm = true;
        openMenu = false;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
    }

    private async Task FinishClass()
    {
        if (fitnessClass == null || string.IsNullOrWhiteSpace(fitnessClass.Id)) return;

        isActing = true;
        actionError = string.Empty;
        statusMessage = string.Empty;

        try
        {
            var resp = await ClassService.FinishClassAsync(fitnessClass.Id);
            if (resp.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/classes");
                return;
            }

            actionError = $"Kunne ikke afslutte træning. Status: {(int)resp.StatusCode}";
        }
        catch (Exception ex)
        {
            actionError = ex.Message;
        }
        finally
        {
            isActing = false;
        }
    }

    private async Task DeleteClass()
    {
        if (fitnessClass == null || string.IsNullOrWhiteSpace(fitnessClass.Id)) return;

        isActing = true;
        actionError = string.Empty;
        statusMessage = string.Empty;

        try
        {
            var resp = await ClassService.DeleteClassAsync(fitnessClass.Id);
            if (resp.IsSuccessStatusCode)
            {
                showDeleteConfirm = false;
                Nav.NavigateTo("/classes");
                return;
            }

            actionError = $"Kunne ikke slette hold. Status: {(int)resp.StatusCode}";
        }
        catch (Exception ex)
        {
            actionError = ex.Message;
        }
        finally
        {
            isActing = false;
        }
    }

    private string GetDisplayName(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return "Bruger";

        if (usersById.TryGetValue(userId, out var u))
        {
            if (!string.IsNullOrWhiteSpace(u.Username)) return u.Username.Trim();

            var full = $"{u.FirstName} {u.LastName}".Trim();
            if (!string.IsNullOrWhiteSpace(full)) return full;
        }

        return userId.Length <= 10 ? userId : userId[..10];
    }

    private static bool MatchesSearch(string haystack, string needle)
    {
        if (string.IsNullOrWhiteSpace(needle)) return true;
        return (haystack ?? "").Contains(needle.Trim(), StringComparison.OrdinalIgnoreCase);
    }

    private static string SeatText(Booking b)
    {
        if (b.SeatNumber <= 0) return "n/a";
        return b.SeatNumber.ToString();
    }

    private static string FormatDate(DateTime dt)
    {
        if (dt == default) return "";
        return dt.ToString("dd/MM");
    }

    private async Task CopyOne(string? text)
    {
        if (string.IsNullOrWhiteSpace(text)) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            statusMessage = "Kopieret";
        }
        catch
        {
            statusMessage = "Kunne ikke kopiere";
        }
    }

    private async Task CopyVisibleNames()
    {
        try
        {
            string content;

            if (activeTab == "bookings")
            {
                content = string.Join(
                    "\n",
                    FilteredBookings.Select(b =>
                    {
                        var name = GetDisplayName(b.UserId);
                        return $"{name} ({b.UserId})";
                    })
                );
            }
            else
            {
                content = string.Join(
                    "\n",
                    FilteredWaitlist.Select(uid =>
                    {
                        var name = GetDisplayName(uid);
                        return $"{name} ({uid})";
                    })
                );
            }

            if (string.IsNullOrWhiteSpace(content))
            {
                statusMessage = "Ingen navne at kopiere";
                return;
            }

            await JS.InvokeVoidAsync("navigator.clipboard.writeText", content);
            statusMessage = "Navne kopieret";
        }
        catch
        {
            statusMessage = "Kunne ikke kopiere navne";
        }
    }
}
