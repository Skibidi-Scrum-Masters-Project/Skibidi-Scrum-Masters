@page "/classes/coach/{classId}"
@layout PhoneLayout
@inject FitLifeFitness.Services.ClassService ClassService
@inject FitLifeFitness.Services.TokenService TokenService
@inject FitLifeFitness.Services.AuthService _authservice
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout

@using FitlifeFitness.Models
@using Microsoft.AspNetCore.Components

<div class="coach-class-screen">
    <button class="secondary-btn classes-back" @onclick="GoToClasses">Tilbage</button>
    @if (isLoading)
    {
        <p>Indlæser hold...</p>
    }
    else if (loadError)
    {
        <p class="error">Kunne ikke indlæse holdet.</p>
    }
    else if (fitnessClass != null)
    {
        <h2 class="classes-title">Coach view — @fitnessClass.Name</h2>
        <p>@fitnessClass.Date.ToString("dd/MM") • @fitnessClass.Time</p>
        <p>Location: @fitnessClass.Location</p>
        <p>Category: @fitnessClass.Category.ToString()</p>
        <p>Capacity: @fitnessClass.MaxCapacity</p>

        <h3>Bookings</h3>
        @if (!fitnessClass.BookingList.Any())
        {
            <p>Ingen bookinger endnu.</p>
        }
        else
        {
            <ul>
                @foreach (var b in fitnessClass.BookingList)
                {
                    <li>@b.UserId — Seat: @(b.SeatNumber!.ToString() ?? "n/a")</li>
                }
            </ul>
        }


        <h3>Waitlist</h3>
        @if (!fitnessClass.WaitlistUserIds.Any())
        {
            <p>Ingen på venteliste.</p>
        }
        else
        {
            <ol>
                @foreach (var uid in fitnessClass.WaitlistUserIds)
                {
                    <li>@uid</li>
                }
            </ol>
        }

        <div class="coach-actions">
            <button class="primary-btn" @onclick="FinishClass">Finish class</button>
            <button class="danger-btn" @onclick="DeleteClass">Delete class</button>
        </div>
    }
</div>

<style>
    .coach-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px
    }

    .danger-btn {
        background: #d9534f;
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 6px
    }
</style>

@code {
    [Parameter]
    public string? classId { get; set; }

    private FitnessClass? fitnessClass;
    private bool isLoading = true;
    private bool loadError = false;
    private string? jwt;
    private string? username;
    private bool _loaded;

    protected override async Task OnInitializedAsync()
    {

    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        jwt = await TokenService.GetTokenAsync();
        username = await TokenService.GetUsernameAsync();
        if(jwt == null)
        {
            await _authservice.LogoutAsync(username!);
            Nav.NavigateTo("/login");
        }
        if (string.IsNullOrEmpty(classId))
        {
            loadError = true;
            isLoading = false;
            return;
        }

        try
        {
            var resp = await ClassService.GetClassByIdAsync(classId!, jwt!);
            if (resp.IsSuccessStatusCode)
            {
                fitnessClass = await resp.Content.ReadFromJsonAsync<FitnessClass>();
            }
            else
            {
                loadError = true;
            }
        }
        catch
        {
            loadError = true;
        }
        finally
        {
            isLoading = false;
        }

        StateHasChanged();
    }

    private void GoToClasses() => Nav.NavigateTo("/classes");

    private void GoToEdit()
    {
        // Placeholder — edit page not implemented
        Nav.NavigateTo($"/classes/coach/{classId}/edit");
    }

    private async Task FinishClass()
    {
        if (fitnessClass == null || string.IsNullOrEmpty(fitnessClass.Id)) return;
        try
        {
            var resp = await ClassService.FinishClassAsync(fitnessClass.Id, jwt!);
            if (resp.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/classes");
            }
            else
            {
                loadError = true;
            }
        }
        catch
        {
            loadError = true;
        }
    }

    private async Task DeleteClass()
    {
        if (fitnessClass == null || string.IsNullOrEmpty(fitnessClass.Id)) return;
        try
        {
            var confirmed = true;
            // Use browser confirm if available
            try
            {
                confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this class? This cannot be undone.");
            }
            catch
            {
                // ignore and proceed if JS interop unavailable
            }

            if (!confirmed) return;

            var resp = await ClassService.DeleteClassAsync(fitnessClass.Id, jwt!);
            if (resp.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/classes");
            }
            else
            {
                loadError = true;
            }
        }
        catch
        {
            loadError = true;
        }
    }
}