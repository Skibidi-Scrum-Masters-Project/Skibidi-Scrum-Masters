@page "/classes/seat/{Id}"
@layout PhoneLayout
@inject FitLifeFitness.Services.ClassService ClassService
@inject FitLifeFitness.Services.SocialService SocialService
@inject FitLifeFitness.Services.UserService UserService
@inject FitLifeFitness.Services.TokenService TokenService
@inject NavigationManager Nav
@inject IJSRuntime JS
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Frontend.Models
@using Microsoft.AspNetCore.Components.Web

<div class="seat-selection">

    <div class="seat-header">
        <button class="back-btn" @onclick="GoBack" type="button">Tilbage</button>

        <div class="header-right">
            <div class="coach-pill">S√¶devalg</div>

            <button class="friends-btn"
                    @onclick="ToggleFriendsMenu"
                    disabled="@IsUserBooked"
                    type="button">
                <span class="btn-icon">üë•</span>
                Book med venner
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(BookingMessage))
    {
        <div class="coach-error warn">@BookingMessage</div>
    }

    @if (WaitlistPosition > 0)
    {
        <div class="coach-error warn">Du er p√• venteliste #@WaitlistPosition</div>
    }

    @if (ShowFriendsMenu)
    {
        <div class="friends-panel">
            <div class="friends-head">
                <div class="friends-title">Book med venner</div>
                <button class="mini-close"
                        type="button"
                        @onclick="ToggleFriendsMenu"
                        disabled="@IsUserBooked">‚úï</button>
            </div>

            <input class="friend-search"
                   placeholder="S√∏g efter venner..."
                   @oninput="OnFriendSearch"
                   @onkeydown="OnFriendSearchKeyDown"
                   value="@FriendSearchTerm"
                   disabled="@IsUserBooked" />

            <div class="friends-grid">
                <div class="friends-col">
                    <div class="section-label">S√∏geresultater</div>

                    @if (SearchResults.Count == 0 && !string.IsNullOrWhiteSpace(FriendSearchTerm))
                    {
                        <div class="friends-empty">Ingen resultater</div>
                    }
                    else
                    {
                        <div class="friend-list">
                            @foreach (var friend in SearchResults)
                            {
                                bool isSelected = SelectedFriends.Any(f => f.Id == friend.Id);

                                <button class="friend-item @(isSelected ? "selected" : "")"
                                        type="button"
                                        @onclick="() => ToggleFriendSelection(friend)"
                                        disabled="@(IsUserBooked || (!isSelected && !CanAddMoreFriends))">
                                    <span class="friend-icon">@(isSelected ? "‚úì" : "üë§")</span>
                                    <span class="friend-name">@friend.FirstName @friend.LastName</span>
                                </button>
                            }
                        </div>
                    }
                </div>

                <div class="friends-col">
                    <div class="section-label">Valgte</div>

                    @if (SelectedFriends.Count == 0)
                    {
                        <div class="friends-empty">V√¶lg en eller flere venner</div>
                    }
                    else
                    {
                        <div class="selected-friends">
                            @foreach (var friend in SelectedFriends)
                            {
                                <div class="friend-chip">
                                    <span>@friend.FirstName</span>
                                    <button type="button"
                                            class="chip-x"
                                            @onclick="() => RemoveFriend(friend)"
                                            disabled="@IsUserBooked">√ó</button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (!CanAddMoreFriends)
            {
                <div class="warning-msg">Du har n√•et det maksimale antal deltagere for dette hold.</div>
            }
        </div>
    }

    <div class="class-info-card">
        <h2 class="class-name">@ClassName</h2>

        <div class="class-details">
            <div class="detail-item">
                <span class="detail-icon">üïê</span>
                <span class="detail-text">@ClassTime</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">‚ö°</span>
                <span class="detail-text">Intensitet: @Intensity</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üë§</span>
                <span class="detail-text">Instrukt√∏r: @InstructorName</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üìç</span>
                <span class="detail-text">@(TotalSeats - @AvailableSeats)/@TotalSeats Booket</span>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box available"></div>
            <span>Ledig</span>
        </div>
        <div class="legend-item">
            <div class="legend-box selected"></div>
            <span>Valgt</span>
        </div>
        <div class="legend-item">
            <div class="legend-box taken"></div>
            <span>Optaget</span>
        </div>
    </div>

    <div class="coach-empty instructor-line">INSTRUKT√òR</div>

    <div class="seat-grid">
        @foreach (var row in SeatRows)
        {
            <div class="seat-row">
                @foreach (var seat in row.Seats)
                {
                    var isUserSeat = UserBookedSeatNumber.HasValue && UserBookedSeatNumber.Value == seat.Number;

                    string seatClass =
                        isUserSeat ? "selected" :
                        seat.IsTaken ? "taken" :
                        SelectedSeats.Contains(seat.Number) ? "selected" : "available";

                    <button class="seat @seatClass"
                            type="button"
                            @onclick="() => SelectSeat(seat)"
                            disabled="@(IsUserBooked || (seat.IsTaken && !isUserSeat))">
                        @(seat.Number + 1)
                    </button>
                }
            </div>
        }
    </div>

    @if (SelectedSeats.Count > 0)
    {
        <div class="pick-summary">
            <div class="pick-title">
                Du har valgt @SelectedSeats.Count @(SelectedSeats.Count == 1 ? "plads" : "pladser")
            </div>
            <div class="pick-sub">
                S√¶de nr. @string.Join(", ", SelectedSeats.Select(s => s + 1))
                @if (SelectedFriends.Count > 0)
                {
                    <span class="pick-plus">+ @SelectedFriends.Count @(SelectedFriends.Count == 1 ? "ven" : "venner")</span>
                }
            </div>
        </div>
    }

    <div class="bottom-actions">
        @if (IsUserBooked)
        {
            <button class="danger-btn" type="button" @onclick="CancelBooking">
                Annuller booking
            </button>
        }
        else
        {
            <button class="primary-btn"
                    type="button"
                    @onclick="ConfirmSeat"
                    disabled="@(!CanConfirmBooking)">
                Bekr√¶ft booking
            </button>
        }
    </div>

</div>

@code {
    [Parameter] public string? Id { get; set; }

    private FitnessClass? SelectedClass { get; set; }
    private string ClassName { get; set; } = "Indl√¶ser...";
    private string ClassTime { get; set; } = "Indl√¶ser...";
    private string InstructorName { get; set; } = "Indl√¶ser...";
    private Intensity Intensity { get; set; } = Intensity.Medium;
    private int TotalSeats { get; set; }
    private int AvailableSeats { get; set; }

    private List<SeatRow> SeatRows { get; set; } = new();
    private List<int> SelectedSeats { get; set; } = new();
    private string? userId { get; set; }
    private string? jwt { get; set; }
    private string BookingMessage { get; set; } = string.Empty;

    private bool ShowFriendsMenu { get; set; }
    private List<UserDto> FriendList { get; set; } = new();
    private List<UserDto> SelectedFriends { get; set; } = new();
    private string FriendSearchTerm { get; set; } = string.Empty;
    private List<UserDto> SearchResults { get; set; } = new();

    private int RemainingSpots => SelectedClass == null ? 0 :
        SelectedClass.MaxCapacity - (SelectedClass.BookingList?.Count ?? 0);
    private int TotalBookingCount => SelectedFriends.Count + 1;
    private bool CanConfirmBooking => SelectedSeats.Count == TotalBookingCount;
    private bool CanAddMoreFriends => TotalBookingCount < RemainingSpots;

    private bool IsUserBooked => SelectedClass != null && !string.IsNullOrEmpty(userId) && (
        (SelectedClass.BookingList?.Any(b => b.UserId == userId) == true) ||
        (SelectedClass.WaitlistUserIds?.Contains(userId) == true));

    private int WaitlistPosition => SelectedClass != null && !string.IsNullOrEmpty(userId) &&
        SelectedClass.WaitlistUserIds != null
        ? SelectedClass.WaitlistUserIds.IndexOf(userId) + 1
        : 0;

    private int? UserBookedSeatNumber => SelectedClass != null && !string.IsNullOrEmpty(userId) &&
        SelectedClass.BookingList != null
        ? SelectedClass.BookingList.FirstOrDefault(b => b.UserId == userId)?.SeatNumber
        : null;

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }
        jwt = await TokenService.GetTokenAsync();
        await LoadFriendsAsync();
        await LoadClassAsync();
    }

    private async Task LoadFriendsAsync()
    {
        var response = await SocialService.GetAllFriendsAsync(userId!, jwt!);
        if (response.IsSuccessStatusCode)
        {
            var friendships = await response.Content.ReadFromJsonAsync<List<Friendship>>() ?? new();
            foreach (var friendship in friendships)
            {
                var friendId = friendship.SenderId == userId ? friendship.ReceiverId : friendship.SenderId;
                if (string.IsNullOrEmpty(friendId)) continue;

                var userResponse = await UserService.GetUserByIdAsync(friendId);
                if (userResponse.IsSuccessStatusCode)
                {
                    var user = await userResponse.Content.ReadFromJsonAsync<UserDto>();
                    if (user != null) FriendList.Add(user);
                }
            }
        }
    }

    private async Task LoadClassAsync()
    {
        var response = await ClassService.GetClassByIdAsync(Id!, jwt!);
        if (response.IsSuccessStatusCode)
        {
            SelectedClass = await response.Content.ReadFromJsonAsync<FitnessClass>();
            if (SelectedClass == null) return;

            ClassName = SelectedClass.Name ?? "Ukendt hold";
            ClassTime = SelectedClass.StartTime.ToString("HH:mm") + " - " +
                        SelectedClass.Duration.ToString("HH:mm");
            InstructorName = await ResolveInstructorNameAsync(SelectedClass.InstructorId);
            Intensity = SelectedClass.Intensity;
            TotalSeats = SelectedClass.MaxCapacity;
            AvailableSeats = TotalSeats - (SelectedClass.BookingList?.Count ?? 0);

            SeatRows = GenerateSeats(SelectedClass);
        }
    }

    private List<SeatRow> GenerateSeats(FitnessClass selectedClass)
    {
        int seatsPerRow = 4;
        if (selectedClass.MaxCapacity <= 0 || selectedClass.SeatMap == null ||
            selectedClass.SeatMap.Length < selectedClass.MaxCapacity)
        {
            return new();
        }

        int numberOfRows = (int)Math.Ceiling((double)selectedClass.MaxCapacity / seatsPerRow);
        bool[] bookedSeats = selectedClass.SeatMap;
        List<SeatRow> seatRows = new();

        for (int i = 0; i < numberOfRows; i++)
        {
            var seatRow = new SeatRow();
            int seatsInRow = (i == numberOfRows - 1)
                ? (selectedClass.MaxCapacity % seatsPerRow == 0 ? seatsPerRow : selectedClass.MaxCapacity % seatsPerRow)
                : seatsPerRow;

            for (int j = 0; j < seatsInRow; j++)
            {
                int seatIndex = i * seatsPerRow + j;
                if (seatIndex >= selectedClass.MaxCapacity) break;

                seatRow.Seats.Add(new Seat
                {
                    Number = seatIndex,
                    IsTaken = bookedSeats[seatIndex]
                });
            }
            seatRows.Add(seatRow);
        }
        return seatRows;
    }

    private void SelectSeat(Seat seat)
    {
        if (IsUserBooked || seat.IsTaken) return;

        if (SelectedSeats.Contains(seat.Number))
            SelectedSeats.Remove(seat.Number);
        else if (SelectedSeats.Count < TotalBookingCount)
            SelectedSeats.Add(seat.Number);
    }

    private async Task ConfirmSeat()
    {
        if (!CanConfirmBooking || SelectedClass == null) return;

        if (SelectedFriends.Count == 0)
        {
            var response = await ClassService.BookSeatForClassAsync(
                SelectedClass.Id!.ToString(), userId!, SelectedSeats[0], jwt!);
            
            if (response.IsSuccessStatusCode)
            {
                BookingMessage = $"Din plads {SelectedSeats[0] + 1} er nu booket!";
                StateHasChanged();
                await Task.Delay(1800);
                Nav.NavigateTo("/classes");
            }
            else
            {
                BookingMessage = "Der opstod en fejl ved booking.";
            }
            return;
        }

        var request = new BookClassWithFriendsRequestDTO
        {
            Friends = SelectedFriends.Select(f => f.Id!).ToList(),
            Seats = new List<int>(SelectedSeats)
        };

        var groupResponse = await ClassService.BookSeatForClassWithFriendsAsync(
            SelectedClass.Id!.ToString(), userId!, request, jwt!);

        if (groupResponse.IsSuccessStatusCode)
        {
            BookingMessage = "Pladserne er nu booket!";
            StateHasChanged();
            await Task.Delay(1800);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved gruppebooking.";
        }
    }

    private async Task CancelBooking()
    {
        if (SelectedClass == null || string.IsNullOrEmpty(userId)) return;

        var response = await ClassService.CancelClassBookingForUserAsync(
            SelectedClass.Id!.ToString(), userId!, jwt!);
        
        if (response.IsSuccessStatusCode)
        {
            BookingMessage = "Din booking er annulleret.";
            await LoadClassAsync();
            StateHasChanged();
            await Task.Delay(1200);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved annullering.";
        }
    }

    private void ToggleFriendsMenu()
    {
        if (IsUserBooked)
        {
            BookingMessage = "Du er allerede booket, du kan ikke tilf√∏je venner.";
            return;
        }
        ShowFriendsMenu = !ShowFriendsMenu;
    }

    private async Task OnFriendSearch(ChangeEventArgs e)
    {
        FriendSearchTerm = e.Value?.ToString() ?? string.Empty;
        SearchResults = string.IsNullOrWhiteSpace(FriendSearchTerm)
            ? new()
            : FriendList.Where(f =>
                f.FirstName.Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase) ||
                f.LastName.Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase)
              ).ToList();
        StateHasChanged();
    }

    private void ToggleFriendSelection(UserDto friend)
    {
        if (IsUserBooked) return;

        BookingMessage = string.Empty;

        if (SelectedClass != null && !string.IsNullOrEmpty(friend.Id))
        {
            if (SelectedClass.BookingList?.Any(b => b.UserId == friend.Id) == true)
            {
                BookingMessage = $"{friend.FirstName} er allerede booket p√• dette hold";
                StateHasChanged();
                return;
            }
            if (SelectedClass.WaitlistUserIds?.Contains(friend.Id) == true)
            {
                BookingMessage = $"{friend.FirstName} er p√• venteliste";
                StateHasChanged();
                return;
            }
        }

        if (SelectedFriends.Any(f => f.Id == friend.Id))
        {
            SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        }
        else if (CanAddMoreFriends)
        {
            SelectedFriends.Add(friend);
            FriendSearchTerm = string.Empty;
            SearchResults = new();
        }

        SelectedSeats.Clear();
    }

    private async Task OnFriendSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && SearchResults.Count == 1)
        {
            ToggleFriendSelection(SearchResults[0]);
            await Task.Yield();
            StateHasChanged();
        }
    }

    private void RemoveFriend(UserDto friend)
    {
        SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        SelectedSeats.Clear();
        BookingMessage = string.Empty;
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("eval",
            "if(history.length>1) history.back(); else window.location.href='/dashboard';");
    }

    public class Seat
    {
        public int Number { get; set; }
        public bool IsTaken { get; set; }
    }
    
    private async Task<string> ResolveInstructorNameAsync(string? instructorUserId)
    {
        if (string.IsNullOrWhiteSpace(instructorUserId))
            return "Ukendt";

        try
        {
            var userResponse = await UserService.GetUserByIdAsync(instructorUserId);
            if (!userResponse.IsSuccessStatusCode)
                return "Ukendt";

            var user = await userResponse.Content.ReadFromJsonAsync<UserDto>();
            if (user == null)
                return "Ukendt";

            var fullName = $"{user.FirstName} {user.LastName}".Trim();
            return string.IsNullOrWhiteSpace(fullName) ? "Ukendt" : fullName;
        }
        catch
        {
            return "Ukendt";
        }
    }


    public class SeatRow
    {
        public List<Seat> Seats { get; set; } = new();
    }
}
