@page "/classes/seat/{Id}"
@layout PhoneLayout
@inject FitLifeFitness.Services.ClassService ClassService
@inject FitLifeFitness.Services.SocialService SocialService
@inject FitLifeFitness.Services.UserService UserService
@inject FitLifeFitness.Services.TokenService TokenService
@inject NavigationManager Nav
@inject IJSRuntime JS
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitlifeFitness.Models
@using Frontend.Models

<div class="seat-selection">
    <div class="seat-header">
        <button class="back-btn" @onclick="GoBack">‚Üê Tilbage</button>
        <button class="friends-btn" @onclick="ToggleFriendsMenu" disabled="@IsUserBooked">
            <span class="btn-icon">üë•</span>
            Book med venner
        </button>
    </div>

    @if (ShowFriendsMenu)
    {
        <div class="friends-panel">
            <input 
                class="friend-search" 
                placeholder="S√∏g efter venner..." 
                @oninput="OnFriendSearch"
                @onkeydown="OnFriendSearchKeyDown"
                value="@FriendSearchTerm" 
                disabled="@IsUserBooked" />
            
            <div class="search-section">
                <div class="section-label">S√∏geresultater:</div>
                <div class="friend-list">
                    @foreach (var friend in SearchResults)
                    {
                        bool isSelected = SelectedFriends.Any(f => f.Id == friend.Id);
                        <button 
                            class="friend-item @(isSelected ? "selected" : "")"
                            @onclick="() => ToggleFriendSelection(friend)" 
                            disabled="@(IsUserBooked || (!isSelected && !CanAddMoreFriends))">
                            <span class="friend-icon">@(isSelected ? "‚úì" : "üë§")</span>
                            @friend.FirstName @friend.LastName
                        </button>
                    }
                </div>
            </div>

            @if (SelectedFriends.Count > 0)
            {
                <div class="selected-section">
                    <div class="section-label">Valgte venner:</div>
                    <div class="selected-friends">
                        @foreach (var friend in SelectedFriends)
                        {
                            <div class="friend-chip">
                                @friend.FirstName
                                <button @onclick="() => RemoveFriend(friend)">√ó</button>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (!CanAddMoreFriends)
            {
                <div class="warning-msg">Du har n√•et det maksimale antal deltagere for dette hold.</div>
            }
        </div>
    }

    <div class="class-info-card">
        <h2 class="class-name">@ClassName</h2>
        
        <div class="class-details">
            <div class="detail-item">
                <span class="detail-icon">üïê</span>
                <span class="detail-text">@ClassTime</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">‚ö°</span>
                <span class="detail-text">Intensitet: @Intensity</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üë§</span>
                <span class="detail-text">Instrukt√∏r: @InstructorName</span>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üìç</span>
                <span class="detail-text">@AvailableSeats/@TotalSeats ledige</span>
            </div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box available"></div>
            <span>Ledig</span>
        </div>
        <div class="legend-item">
            <div class="legend-box selected"></div>
            <span>Valgt</span>
        </div>
        <div class="legend-item">
            <div class="legend-box taken"></div>
            <span>Optaget</span>
        </div>
    </div>

    <div class="instructor-label">
        <span>üéØ INSTRUKT√òR</span>
    </div>

    <div class="seat-grid">
        @foreach (var row in SeatRows)
        {
            <div class="seat-row">
                @foreach (var seat in row.Seats)
                {
                    var isUserSeat = UserBookedSeatNumber.HasValue && UserBookedSeatNumber.Value == seat.Number;
                    string seatClass = isUserSeat ? "selected" : 
                                       seat.IsTaken ? "taken" : 
                                       SelectedSeats.Contains(seat.Number) ? "selected" : "available";

                    <button
                        class="seat @seatClass"
                        @onclick="() => SelectSeat(seat)"
                        disabled="@(IsUserBooked || (seat.IsTaken && !isUserSeat))">
                        @(seat.Number + 1)
                    </button>
                }
            </div>
        }
    </div>

    @if (SelectedSeats.Count > 0)
    {
        <div class="selection-info">
            <div class="info-title">
                Du har valgt @SelectedSeats.Count @(SelectedSeats.Count == 1 ? "plads" : "pladser")
            </div>
            <div class="info-details">
                S√¶de nr. @string.Join(", ", SelectedSeats.Select(s => s + 1))
            </div>
            @if (SelectedFriends.Count > 0)
            {
                <div class="info-sub">
                    + @SelectedFriends.Count @(SelectedFriends.Count == 1 ? "ven" : "venner")
                </div>
            }
        </div>
    }

    @if (WaitlistPosition > 0)
    {
        <div class="waitlist-msg">Du er p√• venteliste #@WaitlistPosition</div>
    }

    @if (!string.IsNullOrEmpty(BookingMessage))
    {
        <div class="booking-msg">@BookingMessage</div>
    }

    <div class="bottom-actions">
        @if (IsUserBooked)
        {
            <button class="cancel-btn" @onclick="CancelBooking">
                Annuller Booking
            </button>
        }
        else
        {
            <button 
                class="confirm-btn" 
                @onclick="ConfirmSeat" 
                disabled="@(!CanConfirmBooking)">
                Bekr√¶ft Booking
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public string? Id { get; set; }
    
    private FitnessClass? SelectedClass { get; set; }
    private string ClassName { get; set; } = "Indl√¶ser...";
    private string ClassTime { get; set; } = "Indl√¶ser...";
    private string InstructorName { get; set; } = "Indl√¶ser...";
    private Intensity Intensity { get; set; } = Intensity.Medium;
    private int TotalSeats { get; set; }
    private int AvailableSeats { get; set; }
    
    private List<SeatRow> SeatRows { get; set; } = new();
    private List<int> SelectedSeats { get; set; } = new();
    private string? userId { get; set; }
    private string? jwt { get; set; }
    private string BookingMessage { get; set; } = string.Empty;
    
    private bool ShowFriendsMenu { get; set; }
    private List<UserDto> FriendList { get; set; } = new();
    private List<UserDto> SelectedFriends { get; set; } = new();
    private string FriendSearchTerm { get; set; } = string.Empty;
    private List<UserDto> SearchResults { get; set; } = new();
    
    private int RemainingSpots => SelectedClass == null ? 0 : 
        SelectedClass.MaxCapacity - (SelectedClass.BookingList?.Count ?? 0);
    private int TotalBookingCount => SelectedFriends.Count + 1;
    private bool CanConfirmBooking => SelectedSeats.Count == TotalBookingCount;
    private bool CanAddMoreFriends => TotalBookingCount < RemainingSpots;
    
    private bool IsUserBooked => SelectedClass != null && !string.IsNullOrEmpty(userId) && (
        (SelectedClass.BookingList?.Any(b => b.UserId == userId) == true) ||
        (SelectedClass.WaitlistUserIds?.Contains(userId) == true));
    
    private int WaitlistPosition => SelectedClass != null && !string.IsNullOrEmpty(userId) && 
        SelectedClass.WaitlistUserIds != null
        ? SelectedClass.WaitlistUserIds.IndexOf(userId) + 1
        : 0;
    
    private int? UserBookedSeatNumber => SelectedClass != null && !string.IsNullOrEmpty(userId) && 
        SelectedClass.BookingList != null
        ? SelectedClass.BookingList.FirstOrDefault(b => b.UserId == userId)?.SeatNumber
        : null;

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }
        jwt = await TokenService.GetTokenAsync();
        await LoadFriendsAsync();
        await LoadClassAsync();
    }

    private async Task LoadFriendsAsync()
    {
        var response = await SocialService.GetAllFriendsAsync(userId!, jwt!);
        if (response.IsSuccessStatusCode)
        {
            var friendships = await response.Content.ReadFromJsonAsync<List<Friendship>>() ?? new();
            foreach (var friendship in friendships)
            {
                var friendId = friendship.SenderId == userId ? friendship.ReceiverId : friendship.SenderId;
                if (string.IsNullOrEmpty(friendId)) continue;
                
                var userResponse = await UserService.GetUserByIdAsync(friendId);
                if (userResponse.IsSuccessStatusCode)
                {
                    var user = await userResponse.Content.ReadFromJsonAsync<UserDto>();
                    if (user != null) FriendList.Add(user);
                }
            }
        }
    }

    private async Task LoadClassAsync()
    {
        var response = await ClassService.GetClassByIdAsync(Id!, jwt!);
        if (response.IsSuccessStatusCode)
        {
            SelectedClass = await response.Content.ReadFromJsonAsync<FitnessClass>();
            if (SelectedClass == null) return;
            
            ClassName = SelectedClass.Name ?? "Ukendt hold";
            ClassTime = SelectedClass.StartTime.ToString("HH:mm") + " - " + 
                       SelectedClass.Duration.ToString("HH:mm");
            InstructorName = SelectedClass.InstructorId ?? "Ukendt";
            Intensity = SelectedClass.Intensity;
            TotalSeats = SelectedClass.MaxCapacity;
            AvailableSeats = TotalSeats - (SelectedClass.BookingList?.Count ?? 0);
            
            SeatRows = GenerateSeats(SelectedClass);
        }
    }

    private List<SeatRow> GenerateSeats(FitnessClass selectedClass)
    {
        int seatsPerRow = 4;
        if (selectedClass.MaxCapacity <= 0 || selectedClass.SeatMap == null || 
            selectedClass.SeatMap.Length < selectedClass.MaxCapacity)
        {
            return new();
        }

        int numberOfRows = (int)Math.Ceiling((double)selectedClass.MaxCapacity / seatsPerRow);
        bool[] bookedSeats = selectedClass.SeatMap;
        List<SeatRow> seatRows = new();

        for (int i = 0; i < numberOfRows; i++)
        {
            var seatRow = new SeatRow();
            int seatsInRow = (i == numberOfRows - 1) 
                ? (selectedClass.MaxCapacity % seatsPerRow == 0 ? seatsPerRow : selectedClass.MaxCapacity % seatsPerRow)
                : seatsPerRow;

            for (int j = 0; j < seatsInRow; j++)
            {
                int seatIndex = i * seatsPerRow + j;
                if (seatIndex >= selectedClass.MaxCapacity) break;
                
                seatRow.Seats.Add(new Seat
                {
                    Number = seatIndex,
                    IsTaken = bookedSeats[seatIndex]
                });
            }
            seatRows.Add(seatRow);
        }
        return seatRows;
    }

    private void SelectSeat(Seat seat)
    {
        if (IsUserBooked || seat.IsTaken) return;

        if (SelectedSeats.Contains(seat.Number))
            SelectedSeats.Remove(seat.Number);
        else if (SelectedSeats.Count < TotalBookingCount)
            SelectedSeats.Add(seat.Number);
    }

    private async Task ConfirmSeat()
    {
        if (!CanConfirmBooking || SelectedClass == null) return;

        if (SelectedFriends.Count == 0)
        {
            var response = await ClassService.BookSeatForClassAsync(
                SelectedClass.Id!.ToString(), userId!, SelectedSeats[0], jwt!);
            
            if (response.IsSuccessStatusCode)
            {
                BookingMessage = $"Din plads {SelectedSeats[0] + 1} er nu booket!";
                StateHasChanged();
                await Task.Delay(1800);
                Nav.NavigateTo("/classes");
            }
            else
            {
                BookingMessage = "Der opstod en fejl ved booking.";
            }
            return;
        }

        var request = new BookClassWithFriendsRequestDTO
        {
            Friends = SelectedFriends.Select(f => f.Id!).ToList(),
            Seats = new List<int>(SelectedSeats)
        };

        var groupResponse = await ClassService.BookSeatForClassWithFriendsAsync(
            SelectedClass.Id!.ToString(), userId!, request, jwt!);

        if (groupResponse.IsSuccessStatusCode)
        {
            BookingMessage = "Pladserne er nu booket!";
            StateHasChanged();
            await Task.Delay(1800);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved gruppebooking.";
        }
    }

    private async Task CancelBooking()
    {
        if (SelectedClass == null || string.IsNullOrEmpty(userId)) return;

        var response = await ClassService.CancelClassBookingForUserAsync(
            SelectedClass.Id!.ToString(), userId!, jwt!);
        
        if (response.IsSuccessStatusCode)
        {
            BookingMessage = "Din booking er annulleret.";
            await LoadClassAsync();
            StateHasChanged();
            await Task.Delay(1200);
            Nav.NavigateTo("/classes");
        }
        else
        {
            BookingMessage = "Der opstod en fejl ved annullering.";
        }
    }

    private void ToggleFriendsMenu()
    {
        if (IsUserBooked)
        {
            BookingMessage = "Du er allerede booket ‚Äî du kan ikke tilf√∏je venner.";
            return;
        }
        ShowFriendsMenu = !ShowFriendsMenu;
    }

    private async Task OnFriendSearch(ChangeEventArgs e)
    {
        FriendSearchTerm = e.Value?.ToString() ?? string.Empty;
        SearchResults = string.IsNullOrWhiteSpace(FriendSearchTerm) 
            ? new() 
            : FriendList.Where(f => 
                f.FirstName.Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase) ||
                f.LastName.Contains(FriendSearchTerm, StringComparison.OrdinalIgnoreCase)
              ).ToList();
        StateHasChanged();
    }

    private void ToggleFriendSelection(UserDto friend)
    {
        if (IsUserBooked) return;

        BookingMessage = string.Empty;

        if (SelectedClass != null && !string.IsNullOrEmpty(friend.Id))
        {
            if (SelectedClass.BookingList?.Any(b => b.UserId == friend.Id) == true)
            {
                BookingMessage = $"{friend.FirstName} er allerede booket p√• dette hold";
                StateHasChanged();
                return;
            }
            if (SelectedClass.WaitlistUserIds?.Contains(friend.Id) == true)
            {
                BookingMessage = $"{friend.FirstName} er p√• venteliste";
                StateHasChanged();
                return;
            }
        }

        if (SelectedFriends.Any(f => f.Id == friend.Id))
        {
            SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        }
        else if (CanAddMoreFriends)
        {
            SelectedFriends.Add(friend);
            FriendSearchTerm = string.Empty;
            SearchResults = new();
        }
        
        SelectedSeats.Clear();
    }

    private async Task OnFriendSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && SearchResults.Count == 1)
        {
            ToggleFriendSelection(SearchResults[0]);
            await Task.Yield();
            StateHasChanged();
        }
    }

    private void RemoveFriend(UserDto friend)
    {
        SelectedFriends.RemoveAll(f => f.Id == friend.Id);
        SelectedSeats.Clear();
        BookingMessage = string.Empty;
    }

    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("eval", 
            "if(history.length>1) history.back(); else window.location.href='/dashboard';");
    }

    public class Seat
    {
        public int Number { get; set; }
        public bool IsTaken { get; set; }
    }

    public class SeatRow
    {
        public List<Seat> Seats { get; set; } = new();
    }
}