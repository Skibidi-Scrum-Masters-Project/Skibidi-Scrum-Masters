@page "/workouts/{Id}"
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@layout EmptyLayout

<div class="detail-screen">

    @if (Workout is null)
    {
        <p>Loader...</p>
    }
    else
    {
        <h2 class="detail-title">@Workout.Name</h2>
        <p class="detail-desc">@Workout.Description</p>

        <h3 class="exercise-title">Ã˜velser</h3>

        <div class="exercise-list">
            @foreach (var exercise in Exercises)
            {
                <div class="exercise-item">
                    <strong>@exercise.ExerciseType</strong>
                    <div>Sets: @exercise.Sets.Count</div>
                    <button class="btn btn-sm" @onclick="() => AddSet(exercise)">Add set</button>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string Id { get; set; } = "";

    private WorkoutProgramDTO? Workout { get; set; }

    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    public List<ExerciseDTO> PreviousExercises { get; set; } = new List<ExerciseDTO>();
    private List<ExerciseDTO> Exercises { get; set; } = new List<ExerciseDTO>();
    protected override async Task OnInitializedAsync()
    {
        var response = await SoloTrainingService.GetWorkoutProgramByIdAsync(Id);
        if (response.IsSuccessStatusCode)
        {
            var program = await response.Content.ReadFromJsonAsync<WorkoutProgramDTO>();
            if (program != null)
            {
                Workout = new WorkoutProgramDTO
                {
                    Id = program.Id!,
                    Name = program.Name,
                    Description = program.Description,
                    ExerciseTypes = program.ExerciseTypes.Select(et => et).ToList(),
                };

                // create ExerciseDTO instances based on the program's exercise types
                Exercises = Workout.ExerciseTypes
                    .Select(et => new ExerciseDTO
                    {
                        ExerciseType = et,
                        Volume = 0,
                        Sets = new List<Set>
                        {
                            new Set { Repetitions = 0, Weight = 0 },
                            new Set { Repetitions = 0, Weight = 0 },
                            new Set { Repetitions = 0, Weight = 0 }
                        }
                    })
                    .ToList();
            }
        }
        var response2 = await SoloTrainingService.GetMostRecentSoloTrainingForUserAndProgramAsync("userId", Id);
        if (response2.IsSuccessStatusCode)
        {
            var session = await response2.Content.ReadFromJsonAsync<SoloTrainingSessionDTO>();
            if (session != null && session.Exercises.Any())
            {
                PreviousExercises = session.Exercises;
            }
        }
    }

    private void AddSet(ExerciseDTO exercise)
    {
        exercise.Sets.Add(new Set { Repetitions = 0, Weight = 0 });
    }


}