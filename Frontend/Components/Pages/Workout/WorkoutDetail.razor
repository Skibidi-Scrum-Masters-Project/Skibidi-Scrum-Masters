@page "/workouts/{Id}"
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using System.Net.Http.Json
@layout PhoneLayout

<div class="workout-logger">
    @if (Workout is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-label">Volume</div>
                <div class="stat-value">@($"{totalVolume} kg")</div>
            </div>
            <div class="stat">
                <div class="stat-label">Sets</div>
                <div class="stat-value">@totalSets</div>
            </div>
        </div>

        <div class="workout-scroll">
            <section class="workout-hero">
                <div class="hero-top">
                    <div class="hero-ico" aria-hidden="true">üèãÔ∏è</div>
                    <div class="hero-text">
                        <h2 class="hero-title">@Workout.Name</h2>
                        @if (!string.IsNullOrWhiteSpace(Workout.Description))
                        {
                            <p class="hero-sub">@Workout.Description</p>
                        }
                        else
                        {
                            <p class="hero-sub">Log dine sets og gem din tr√¶ning</p>
                        }
                    </div>
                </div>
            </section>

            <div class="exercises-container">
                @foreach (var exercise in Exercises)
                {
                    <div class="exercise-card">
                        <div class="exercise-header">

                            <div class="exercise-headtext">
                                <h3 class="exercise-name">@exercise.ExerciseType</h3>
                                <p class="exercise-sub">@($"{exercise.Sets.Count} sets")</p>
                            </div>
                        </div>

                        <div class="notes-section">
                            <input type="text" placeholder="Tilf√∏j noter her" class="notes-input" />
                        </div>

                        <div class="sets-container">
                            <div class="sets-header">
                                <div class="col-set">SET</div>
                                <div class="col-weight">KG</div>
                                <div class="col-reps">REPS</div>
                                <div class="col-check"></div>
                            </div>

                            @for (int i = 0; i < exercise.Sets.Count; i++)
                            {
                                var setIndex = i;
                                var set = exercise.Sets[setIndex];

                                <div class="set-row @(set.IsFinished ? "finished" : "") @(set.IsPlaceholder ? "prefilled" : "")">
                                    <div class="col-set set-number">@(setIndex + 1)</div>

                                    <div class="col-weight">
                                        <input
                                            type="number"
                                            class="set-input"
                                            value="@(set.HasUserValue ? set.Weight.ToString() : string.Empty)"
                                            placeholder="@set.Weight"
                                            onfocus="this.select();"
                                            @oninput="(ChangeEventArgs e) => OnSetInput(exercise, setIndex, e, true)"
                                            @onchange="(ChangeEventArgs e) => OnSetValueChanged(exercise, setIndex, e, true)" />
                                    </div>

                                    <div class="col-reps">
                                        <input
                                            type="number"
                                            class="set-input"
                                            value="@(set.HasUserValue ? set.Repetitions.ToString() : string.Empty)"
                                            placeholder="@set.Repetitions"
                                            onfocus="this.select();"
                                            @oninput="(ChangeEventArgs e) => OnSetInput(exercise, setIndex, e, false)"
                                            @onchange="(ChangeEventArgs e) => OnSetValueChanged(exercise, setIndex, e, false)" />
                                    </div>

                                    <div class="col-check">
                                        <button class="check-button" type="button" @onclick="() => FinishSet(exercise, setIndex)" aria-label="Finish set">‚úì</button>
                                        <button class="remove-button" type="button" @onclick="() => RemoveSet(exercise, setIndex)" aria-label="Remove set">‚úï</button>
                                    </div>
                                </div>
                            }
                        </div>

                        <button class="add-set-button" type="button" @onclick="() => AddSet(exercise)">
                            <span class="plus-icon">+</span>
                            <span>Tilf√∏j Set</span>
                        </button>
                    </div>
                }
            </div>

            <!-- sticky action bar, f√∏lger med sk√¶rmen -->
            <div class="footer-actions">
                <button class="footer-button finish" type="button" @onclick="FinishWorkout">Afslut tr√¶ning</button>
                <button class="footer-button delete" type="button" @onclick="DeleteWorkout">Slet tr√¶ning</button>
            </div>
        </div>
    }
</div>

@if (showToast)
{
    <div class="toast">@toastMessage</div>
}

@if (showDeleteConfirm)
{
    <div class="modal-overlay" @onclick="CloseDeleteConfirm" role="presentation">
        <div class="modal-card" role="dialog" aria-modal="true" aria-label="Delete workout confirmation" @onclick:stopPropagation="true">
            <div class="modal-title">Slet tr√¶ning</div>
            <div class="modal-text">Er du sikker p√•, at du vil slette denne tr√¶ning</div>

            <div class="modal-actions">
                <button class="modal-btn ghost" type="button" @onclick="CloseDeleteConfirm">Annuller</button>
                <button class="modal-btn danger" type="button" @onclick="ConfirmDeleteWorkout">Slet</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string Id { get; set; } = "";

    private WorkoutProgramDTO? Workout { get; set; }

    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    [Inject] private FitLifeFitness.Services.TokenService TokenService { get; set; } = default!;
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    private string? jwt;
    public List<ExerciseDTO> PreviousExercises { get; set; } = new List<ExerciseDTO>();
    private List<ExerciseDTO> Exercises { get; set; } = new List<ExerciseDTO>();
    private SoloTrainingSessionDTO? Session { get; set; } = new SoloTrainingSessionDTO();
    private List<ExerciseDTO> FinishedExercises { get; set; } = new List<ExerciseDTO>();

    private int duration = 16;
    private int totalVolume = 0;
    private int totalSets = 0;

    private bool showToast = false;
    private string toastMessage = string.Empty;

    private bool showDeleteConfirm = false;

    protected override async Task OnInitializedAsync()
    {
        jwt = await TokenService.GetTokenAsync();
        string? userId = await TokenService.GetUserIdAsync();
        HttpResponseMessage? response = await SoloTrainingService.GetWorkoutProgramByIdAsync(Id, jwt ?? "");
        if (response.IsSuccessStatusCode)
        {
            WorkoutProgramDTO? program = await response.Content.ReadFromJsonAsync<WorkoutProgramDTO>();
            if (program != null)
            {
                Workout = new WorkoutProgramDTO
                {
                    Id = program.Id!,
                    Name = program.Name,
                    Description = program.Description,
                    ExerciseTypes = program.ExerciseTypes.Select(et => et).ToList(),
                };

                Exercises = Workout.ExerciseTypes
                    .Select(et => new ExerciseDTO
                    {
                        ExerciseType = et,
                        Volume = 0,
                        Sets = new List<Set>
                        {
                            new Set { Repetitions = 0, Weight = 0 },
                            new Set { Repetitions = 0, Weight = 0 },
                            new Set { Repetitions = 0, Weight = 0 }
                        }
                    })
                    .ToList();
            }
        }

        HttpResponseMessage? response2 = await SoloTrainingService.GetMostRecentSoloTrainingForUserAndProgramAsync(userId ?? "",
        Id, jwt ?? "");
        if (response2.IsSuccessStatusCode)
        {
            SoloTrainingSessionDTO? session = await response2.Content.ReadFromJsonAsync<SoloTrainingSessionDTO>();
            if (session != null && session.Exercises.Any())
            {
                PreviousExercises = session.Exercises;

                foreach (var exercise in Exercises)
                {
                    var prev = PreviousExercises.FirstOrDefault(pe => pe.ExerciseType == exercise.ExerciseType);
                    if (prev != null && prev.Sets != null)
                    {
                        if (prev.Sets.Count > exercise.Sets.Count)
                        {
                            var toAdd = prev.Sets.Count - exercise.Sets.Count;
                            for (int k = 0; k < toAdd; k++)
                            {
                                exercise.Sets.Add(new Set());
                            }
                        }

                        for (int si = 0; si < prev.Sets.Count && si < exercise.Sets.Count; si++)
                        {
                            exercise.Sets[si].Weight = prev.Sets[si].Weight;
                            exercise.Sets[si].Repetitions = prev.Sets[si].Repetitions;
                            exercise.Sets[si].IsPlaceholder = true;
                            exercise.Sets[si].IsFinished = false;
                            exercise.Sets[si].HasUserValue = false;
                        }
                    }
                }
            }
        }

        Session = new SoloTrainingSessionDTO
        {
            UserId = userId ?? "",
            Date = DateTime.UtcNow,
            DurationMinutes = 0,
            WorkoutProgramId = Id,
            WorkoutProgramName = Workout?.Name ?? "",
        };
    }

    private void AddSet(ExerciseDTO exercise)
    {
        var prev = PreviousExercises.FirstOrDefault(pe => pe.ExerciseType == exercise.ExerciseType);
        var userUpdatedAny = exercise.Sets.Any(s => s.HasUserValue);

        if (prev != null && prev.Sets.Any() && !userUpdatedAny)
        {
            var last = prev.Sets.Last();
            exercise.Sets.Add(new Set { Repetitions = last.Repetitions, Weight = last.Weight, IsPlaceholder = true, HasUserValue = false });
        }
        else
        {
            exercise.Sets.Add(new Set { Repetitions = 0, Weight = 0 });
        }
    }

    private void RemoveSet(ExerciseDTO exercise, int index)
    {
        if (index >= 0 && index < exercise.Sets.Count)
        {
            var finished = FinishedExercises.FirstOrDefault(fe => fe.ExerciseType == exercise.ExerciseType);
            if (finished != null && index >= 0 && index < finished.Sets.Count)
            {
                finished.Sets.RemoveAt(index);
                finished.Volume = (finished.Sets?.Sum(s => s.Repetitions * s.Weight)) ?? 0;

                if (finished.Sets.Count == 0)
                {
                    FinishedExercises.Remove(finished);
                }
            }

            exercise.Sets.RemoveAt(index);
            UpdateStats();
        }
    }

    private void UpdateStats()
    {
        totalSets = FinishedExercises.Sum(e => e.Sets?.Count ?? 0);
        totalVolume = (int)FinishedExercises.Sum(e => (e.Sets?.Sum(s => s.Repetitions * s.Weight) ?? 0));
    }

    private void FinishSet(ExerciseDTO exercise, int index)
    {
        if (index < 0 || index >= exercise.Sets.Count) return;

        var set = exercise.Sets[index];
        set.IsFinished = true;

        var finished = FinishedExercises.FirstOrDefault(fe => fe.ExerciseType == exercise.ExerciseType);
        if (finished == null)
        {
            finished = new ExerciseDTO { ExerciseType = exercise.ExerciseType, Volume = 0, Sets = new List<Set>() };
            FinishedExercises.Add(finished);
        }

        while (finished.Sets.Count <= index)
        {
            finished.Sets.Add(new Set { Repetitions = 0, Weight = 0 });
        }

        finished.Sets[index].Repetitions = set.Repetitions;
        finished.Sets[index].Weight = set.Weight;
        finished.Volume = (finished.Sets?.Sum(s => s.Repetitions * s.Weight)) ?? 0;

        UpdateStats();
    }

    private void OnSetChanged(ExerciseDTO exercise, int index)
    {
        if (index < 0 || index >= exercise.Sets.Count) return;

        var set = exercise.Sets[index];
        if (!set.IsFinished) return;

        var finished = FinishedExercises.FirstOrDefault(fe => fe.ExerciseType == exercise.ExerciseType);
        if (finished == null) return;

        while (finished.Sets.Count <= index)
        {
            finished.Sets.Add(new Set { Repetitions = 0, Weight = 0 });
        }

        finished.Sets[index].Repetitions = set.Repetitions;
        finished.Sets[index].Weight = set.Weight;
        finished.Volume = (finished.Sets?.Sum(s => s.Repetitions * s.Weight)) ?? 0;

        UpdateStats();
    }

    private void OnSetValueChanged(ExerciseDTO exercise, int index, ChangeEventArgs e, bool isWeight)
    {
        if (index < 0 || index >= exercise.Sets.Count) return;

        var set = exercise.Sets[index];
        if (e.Value == null) return;

        if (isWeight)
        {
            if (double.TryParse(e.Value.ToString(), out var w))
            {
                set.Weight = w;
            }
        }
        else
        {
            if (int.TryParse(e.Value.ToString(), out var r))
            {
                set.Repetitions = r;
            }
        }

        set.HasUserValue = true;

        if (set.IsFinished)
        {
            OnSetChanged(exercise, index);
        }
    }

    private void OnSetInput(ExerciseDTO exercise, int index, ChangeEventArgs e, bool isWeight)
    {
        if (index < 0 || index >= exercise.Sets.Count) return;

        var set = exercise.Sets[index];
        if (e.Value == null) return;

        if (isWeight)
        {
            if (double.TryParse(e.Value.ToString(), out var w))
            {
                set.Weight = w;
            }
        }
        else
        {
            if (int.TryParse(e.Value.ToString(), out var r))
            {
                set.Repetitions = r;
            }
        }

        set.HasUserValue = true;

        if (set.IsFinished)
        {
            OnSetChanged(exercise, index);
        }
    }

    private Task DeleteWorkout()
    {
        showDeleteConfirm = true;
        return Task.CompletedTask;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
    }

    private void ConfirmDeleteWorkout()
    {
        showDeleteConfirm = false;
        NavigationManager.NavigateTo("/dashboard");
    }

    private async Task FinishWorkout()
    {
        if (Session == null) return;

        Session.DurationMinutes = Math.Max(0, (int)(DateTime.UtcNow - Session.Date).TotalMinutes);
        Session.Exercises = FinishedExercises;

        HttpResponseMessage? response = await SoloTrainingService.CreateSoloTrainingSessionAsync(Session.UserId,
        Session.WorkoutProgramId!, Session, jwt ?? "");
        if (response.IsSuccessStatusCode)
        {
            toastMessage = "Workout saved";
            showToast = true;
            StateHasChanged();
            await Task.Delay(1200);
            showToast = false;
            NavigationManager.NavigateTo("/dashboard");
        }
        else
        {
            toastMessage = "Failed to save workout";
            showToast = true;
            StateHasChanged();
            await Task.Delay(1400);
            showToast = false;
        }
    }
}
