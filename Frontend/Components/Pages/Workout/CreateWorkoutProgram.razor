@page "/create-workout-program"
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@layout EmptyLayout

<div class="create-program-header">
    <h2>Create Workout Program</h2>
</div>

<div class="create-program-form">
    <label>Name</label>
    <input @bind="Name" />

    <label>Description</label>
    <input @bind="Description" />

        <label>Exercise types</label>
        <div class="search-row">
            <input list="exercises-datalist" class="exercise-search" placeholder="Search or select exercises..." @bind="SearchText" @oninput="OnSearchInput" @onkeydown="OnSearchKeyDown" />
            <button class="search-add-btn" @onclick="AddExerciseType">Add</button>
        </div>

        <datalist id="exercises-datalist">
            @foreach (var et in FilteredExerciseTypes)
            {
                <option value="@et.ToString()"></option>
            }
        </datalist>

        <div class="selected-chips" style="margin-top:0.75rem;">
            @foreach (var et in SelectedExerciseTypes)
            {
                <div class="chip">@et.ToString() <button @onclick="() => RemoveExerciseType(et)">x</button></div>
            }
        </div>

    <div style="margin-top:1rem;display:flex;gap:0.5rem;">
        <button @onclick="CreateProgram">Create</button>
        <button @onclick="Cancel">Cancel</button>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="message">@Message</div>
    }
</div>

@code {
    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private string Name { get; set; } = string.Empty;
    private string Description { get; set; } = string.Empty;
    private string ExerciseTypesText { get; set; } = string.Empty;
    private List<ExerciseType> AllExerciseTypes { get; set; } = new List<ExerciseType>();
    private List<ExerciseType> SelectedExerciseTypes { get; set; } = new List<ExerciseType>();
    private string SearchText { get; set; } = string.Empty;
    private IEnumerable<ExerciseType> FilteredExerciseTypes =>
        string.IsNullOrWhiteSpace(SearchText)
            ? AllExerciseTypes
            : AllExerciseTypes.Where(et => et.ToString().Contains(SearchText, StringComparison.OrdinalIgnoreCase));
    private string Message { get; set; } = string.Empty;

    private async Task CreateProgram()
    {

        var program = new WorkoutProgramDTO
        {
            Name = Name,
            Description = Description,
            ExerciseTypes = SelectedExerciseTypes
        };

        var response = await SoloTrainingService.CreateWorkoutProgramAsync(program);
        if (response.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/workouts");
        }
        else
        {
            Message = "Failed to create program";
        }
    }

    protected override void OnInitialized()
    {
        AllExerciseTypes = Enum.GetValues(typeof(ExerciseType)).Cast<ExerciseType>().ToList();
    }

    private void AddExerciseType()
    {
        var value = SearchText?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(value)) return;
        if (Enum.TryParse<ExerciseType>(value, true, out var et))
        {
            if (!SelectedExerciseTypes.Contains(et)) SelectedExerciseTypes.Add(et);
            SearchText = string.Empty;
        }
    }

    private void RemoveExerciseType(ExerciseType et)
    {
        if (SelectedExerciseTypes.Contains(et)) SelectedExerciseTypes.Remove(et);
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        SearchText = e?.Value?.ToString() ?? string.Empty;
    }

    private void OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e?.Key == "Enter")
        {
            // pick the top filtered result if any
            var filtered = FilteredExerciseTypes;
            if (filtered.Any())
            {
                var first = filtered.First();
                if (!SelectedExerciseTypes.Contains(first))
                {
                    SelectedExerciseTypes.Add(first);
                }
                SearchText = string.Empty;
            }
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/workouts");
    }
}
