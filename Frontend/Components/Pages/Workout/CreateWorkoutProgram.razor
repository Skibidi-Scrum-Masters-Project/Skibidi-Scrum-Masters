@page "/create-workout-program"
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using FitLifeFitness.Components.Layout
@layout PhoneLayout

<div class="create-program-page">
    <div class="create-program-body">
        <div class="create-program-shell">

            <header class="create-hero">
                <div class="hero-top">
                    <button class="ghost-icon" type="button" @onclick="Cancel" aria-label="Tilbage">
                        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                            <path d="M15 18l-6-6 6-6"></path>
                        </svg>
                    </button>

                    <div class="hero-text">
                        <h2 class="hero-title">Opret træningsprogram</h2>
                        <p class="hero-subtitle">Byg et program med dine foretrukne øvelsestyper.</p>
                    </div>
                </div>
                
            </header>

            <section class="form-card">
                <div class="field">
                    <label class="label">Navn</label>
                    <input class="input"
                           placeholder="Fx Push day"
                           @bind="Name"
                           @bind:event="oninput" />
                </div>

                <div class="field">
                    <label class="label">Beskrivelse</label>
                    <textarea class="textarea"
                              placeholder="Kort beskrivelse af programmet..."
                              @bind="Description"
                              @bind:event="oninput"></textarea>
                </div>

                <div class="divider"></div>

                <div class="field">
                    <label class="label">Øvelsestyper</label>
                    <p class="hint">Søg og tilføj. Tryk Enter for at vælge første forslag.</p>

                    <div class="search-row">
                        <input list="exercises-datalist"
                               class="input search"
                               placeholder="Søg eller vælg..."
                               @bind="SearchText"
                               @bind:event="oninput"
                               @onkeydown="OnSearchKeyDown" />

                        <button class="pill-btn"
                                type="button"
                                @onclick="AddExerciseType"
                                disabled="@(!CanAddExercise)">
                            Tilføj
                        </button>
                    </div>

                    <datalist id="exercises-datalist">
                        @foreach (var et in FilteredExerciseTypes)
                        {
                            <option value="@et.ToString()"></option>
                        }
                    </datalist>

                    @if (!string.IsNullOrWhiteSpace(Message))
                    {
                        <div class="callout error">@Message</div>
                    }

                    @if (SelectedExerciseTypes.Count == 0)
                    {
                        <div class="empty-box">
                            Ingen øvelsestyper valgt endnu.
                        </div>
                    }
                    else
                    {
                        <div class="chips">
                            @foreach (var et in SelectedExerciseTypes)
                            {
                                <div class="chip">
                                    <span class="chip-text">@et.ToString()</span>
                                    <button class="chip-x"
                                            type="button"
                                            @onclick="() => RemoveExerciseType(et)"
                                            aria-label="Fjern">
                                        ✕
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </section>

            <div class="actions">
                <button class="btn ghost" type="button" @onclick="Cancel">
                    Annuller
                </button>
                <button class="btn primary" type="button" @onclick="CreateProgram">
                    Opret program
                </button>
            </div>

            <div class="spacer"></div>
        </div>
    </div>
</div>

@code {
    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private string Name = string.Empty;
    private string Description = string.Empty;

    private List<ExerciseType> AllExerciseTypes = new();
    private List<ExerciseType> SelectedExerciseTypes = new();

    private string SearchText = string.Empty;
    private string Message = string.Empty;

    private IEnumerable<ExerciseType> FilteredExerciseTypes =>
        string.IsNullOrWhiteSpace(SearchText)
            ? AllExerciseTypes
            : AllExerciseTypes.Where(et =>
                et.ToString().Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    private bool CanAddExercise =>
        !string.IsNullOrWhiteSpace(SearchText)
        && Enum.TryParse<ExerciseType>(SearchText, true, out _);
    

    protected override void OnInitialized()
    {
        AllExerciseTypes = Enum.GetValues(typeof(ExerciseType))
            .Cast<ExerciseType>()
            .ToList();
    }

    private async Task CreateProgram()
    {
        Message = string.Empty;

        if (SelectedExerciseTypes.Count == 0)
        {
            Message = "Du skal vælge mindst 1 øvelsestype før du kan oprette programmet.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Name))
        {
            Message = "Navn mangler.";
            return;
        }

        var program = new WorkoutProgramDTO
        {
            Name = Name.Trim(),
            Description = Description.Trim(),
            ExerciseTypes = SelectedExerciseTypes.ToList()
        };

        var response = await SoloTrainingService.CreateWorkoutProgramAsync(program);

        if (response.IsSuccessStatusCode)
            Nav.NavigateTo("/workouts");
        else
            Message = "Kunne ikke oprette programmet.";
    }

    private void AddExerciseType()
    {
        Message = string.Empty;

        if (Enum.TryParse<ExerciseType>(SearchText, true, out var et))
        {
            if (!SelectedExerciseTypes.Contains(et))
                SelectedExerciseTypes.Add(et);

            SearchText = string.Empty;
        }
    }

    private void RemoveExerciseType(ExerciseType et)
    {
        Message = string.Empty;
        SelectedExerciseTypes.Remove(et);
    }

    private void OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        var first = FilteredExerciseTypes.FirstOrDefault();
        if (EqualityComparer<ExerciseType>.Default.Equals(first, default)) return;

        if (!SelectedExerciseTypes.Contains(first))
            SelectedExerciseTypes.Add(first);

        SearchText = string.Empty;
        Message = string.Empty;
    }

    private void Cancel() => Nav.NavigateTo("/workouts");
}
