@page "/workouts"
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@layout PhoneLayout

<div class="workout-screen">

    <h2 class="workout-title">Træningsprogrammer</h2>
    <p class="workout-subtitle">Vælg et program for at se øvelser</p>

    <div class="workout-grid">
        @foreach (var workout in Workouts)
        {
            <button class="workout-card" type="button" @onclick="() => OpenWorkout(workout.Id)">
                <div class="workout-card-header">
                    <h3>@workout.Name</h3>
                </div>

                <p class="workout-focus">@workout.Description</p>

                <p class="workout-meta">
                    @workout.ExerciseTypes.Count øvelser
                </p>
            </button>
        }
    </div>

    @if (ShowCreateProgramButton)
    {
        <div class="create-program-bar">
            <button class="create-program-button" type="button" @onclick="GoToCreateProgram">
                Opret Program
            </button>
        </div>
    }

</div>

@code {
    [Inject] private NavigationManager Nav { get; set; } = default!;
    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    [Inject] private FitLifeFitness.Services.TokenService TokenService { get; set; } = default!;

    private List<WorkoutProgramDTO> Workouts { get; set; } = new();
    private bool ShowCreateProgramButton { get; set; } = false;
    private string? jwt;

    protected override async Task OnInitializedAsync()
    {
        jwt = await TokenService.GetTokenAsync();
        var response = await SoloTrainingService.GetWorkoutProgramsAsync(jwt ?? "");
        if (response.IsSuccessStatusCode)
        {
            List<WorkoutProgramDTO>? programs = await response.Content.ReadFromJsonAsync<List<WorkoutProgramDTO>>();
            if (programs != null)
            {
                Workouts = programs.Select(p => new WorkoutProgramDTO
                {
                    Id = p.Id!,
                    Name = p.Name,
                    Description = p.Description,
                    ExerciseTypes = p.ExerciseTypes,
                }).ToList();
            }
        }

        try
        {
            var role = await TokenService.GetUserRoleAsync();
            if (role == UserRole.Coach || role == UserRole.Admin)
            {
                ShowCreateProgramButton = true;
            }
        }
        catch
        {
            ShowCreateProgramButton = false;
        }
    }

    private void OpenWorkout(string id) => Nav.NavigateTo($"/workouts/{id}");

    private void GoToCreateProgram() => Nav.NavigateTo("/create-workout-program");
}
