@page "/workouts"
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@layout PhoneLayout

<div class="workout-screen">

    <h2 class="workout-title">Træningsprogrammer</h2>
    <p class="workout-subtitle">Vælg et program for at se øvelser</p>

    <div class="workout-grid">
        @foreach (var workout in Workouts)
        {
            <button class="workout-card" @onclick="() => OpenWorkout(workout.Id)">
                <div class="workout-card-header">
                    <h3>@workout.Name</h3>
                </div>

                <p class="workout-focus">@workout.Description</p>

                <p class="workout-meta">
                    @workout.ExerciseTypes.Count øvelser 
                </p>
            </button>
        }

        @if (ShowCreateProgramButton)
        {
            <div class="create-program-button-container">
                <button class="create-program-button" @onclick="GoToCreateProgram">Create Program</button>
            </div>
        }
    </div>
</div>

@code {
    [Inject] private NavigationManager Nav { get; set; } = default!;
    [Inject] private FitLifeFitness.Services.SoloTrainingService SoloTrainingService { get; set; } = default!;
    [Inject] private FitLifeFitness.Services.TokenService TokenService { get; set; } = default!;

    private List<WorkoutProgramDTO> Workouts { get; set; } = new List<WorkoutProgramDTO>();
    private bool ShowCreateProgramButton { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        var response = await SoloTrainingService.GetWorkoutPrograms();
        if (response.IsSuccessStatusCode)
        {
            List<WorkoutProgramDTO>? programs = await response.Content.ReadFromJsonAsync<List<WorkoutProgramDTO>>();
            if (programs != null)
            {
                Workouts = programs.Select(p => new WorkoutProgramDTO
                {
                    Id = p.Id!,
                    Name = p.Name,
                    Description = p.Description,
                    ExerciseTypes = p.ExerciseTypes,
                }).ToList();
            }
        }

        // Determine if the logged-in user can create programs
        try
        {
            var role = await TokenService.GetUserRoleAsync();
            if (role == UserRole.Coach || role == UserRole.Admin)
            {
                ShowCreateProgramButton = true;
            }
        }
        catch
        {
            ShowCreateProgramButton = false;
        }
    }

    private void OpenWorkout(string id)
    {
        Nav.NavigateTo($"/workouts/{id}");
    }

    private void GoToCreateProgram()
    {
        Nav.NavigateTo("/create-workout-program");
    }
}