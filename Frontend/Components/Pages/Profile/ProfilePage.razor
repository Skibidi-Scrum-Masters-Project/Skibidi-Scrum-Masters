@page "/profile"
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using System.Net.Http.Json
@using System.Text.Json
@layout PhoneLayout
@inject NavigationManager Nav

@inject TokenService TokenService
@inject UserService UserService
@inject SocialService SocialService
@inject ClassService ClassService
@inject AnalyticsService AnalyticsService

<div class="profile-page">
    @if (isLoading)
    {
        <section class="profile-hero-card">
            <div class="profile-avatar-large">..</div>
            <h2 class="profile-name">Indlæser</h2>
            <p class="profile-meta">Henter dine data</p>
            <div class="membership-badge">
                <span>Vent et øjeblik</span>
            </div>
        </section>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <section class="profile-hero-card">
            <div class="profile-avatar-large">!</div>
            <h2 class="profile-name">Noget gik galt</h2>
            <p class="profile-meta">@error</p>

            <button class="action-card" type="button" @onclick="Reload">
                <div class="action-text">
                    <div class="action-title">Prøv igen</div>
                    <div class="action-subtitle">Genindlæs profilen</div>
                </div>
                <div class="action-arrow">›</div>
            </button>
        </section>
    }
    else
    {
        <section class="profile-hero-card">
            <div class="profile-avatar-large">
                @Initials
            </div>

            <h2 class="profile-name">@DisplayName</h2>

            @if (!string.IsNullOrWhiteSpace(MembershipLabel))
            {
                <div class="membership-badge">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    <span>@MembershipLabel</span>
                </div>
            }
        </section>

        <section class="quick-stats">
            <div class="stat-tile">
                <div class="stat-number">@StatsTrainings</div>
                <div class="stat-label">Træninger</div>
            </div>
            <div class="stat-tile">
                <div class="stat-number">@StatsClasses</div>
                <div class="stat-label">Hold</div>
            </div>
            <div class="stat-tile">
                <div class="stat-number">@StatsFriends</div>
                <div class="stat-label">Venner</div>
            </div>
        </section>

        <div class="section-header">
            <div class="section-title">Oversigt</div>
        </div>

        <section class="nav-grid">
            <button class="nav-card" type="button" @onclick="GoMyClasses">
                <div class="nav-card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                </div>
                <div class="nav-card-title">Mine Hold</div>
                <div class="nav-card-subtitle">@MyClassesSubtitle</div>
                <div class="nav-card-arrow">›</div>
            </button>

            <button class="nav-card" type="button" @onclick="GoAppointments">
                <div class="nav-card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                </div>
                <div class="nav-card-title">Aftaler</div>
                <div class="nav-card-subtitle">@AppointmentsSubtitle</div>
                <div class="nav-card-arrow">›</div>
            </button>

            <button class="nav-card" type="button" @onclick="GoWorkouts">
                <div class="nav-card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 7h2v10H6z"></path>
                        <path d="M16 7h2v10h-2z"></path>
                        <path d="M8 10h8"></path>
                        <path d="M8 14h8"></path>
                    </svg>
                </div>
                <div class="nav-card-title">Træninger</div>
                <div class="nav-card-subtitle">@WorkoutsSubtitle</div>
                <div class="nav-card-arrow">›</div>
            </button>

            <button class="nav-card" type="button" @onclick="GoStatistics">
                <div class="nav-card-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10" />
                        <line x1="18" y1="20" x2="18" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="16" />
                    </svg>
                </div>
                <div class="nav-card-title">Statistik</div>
                <div class="nav-card-subtitle">Se udvikling</div>
                <div class="nav-card-arrow">›</div>
            </button>
        </section>

        <div class="section-header">
            <div class="section-title">Indstillinger</div>
        </div>

        <section class="action-stack">
            <button class="action-card special" type="button" @onclick="OpenLocker">
                <div class="action-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>
                </div>
                <div class="action-text">
                    <div class="action-title">Åbn mit skab</div>
                    <div class="action-subtitle">@LockerSubtitle</div>
                </div>
                <div class="bluetooth-indicator">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l4 4-4 4v-8zm0 12l4 4-4 4v-8zm-2-1l-4-4 4-4v8zm0 8l-4-4 4-4v8z" />
                    </svg>
                </div>
                <div class="action-arrow">›</div>
            </button>

            <button class="action-card" type="button" @onclick="EditProfile">
                <div class="action-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                </div>
                <div class="action-text">
                    <div class="action-title">Redigér profil</div>
                    <div class="action-subtitle">Opdater oplysninger</div>
                </div>
                <div class="action-arrow">›</div>
            </button>

            <button class="action-card danger" type="button" @onclick="Logout">
                <div class="action-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </div>
                <div class="action-text">
                    <div class="action-title">Log ud</div>
                    <div class="action-subtitle">Afslut din session</div>
                </div>
                <div class="action-arrow">›</div>
            </button>
        </section>
    }
</div>

@code {
    private string? userId;

    private ProfileUser? User;
    private ProfileStats Stats = new();

    private bool isLoading = true;
    private string? error;
    private string? jwt;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        error = null;

        try
        {
            jwt = await TokenService.GetTokenAsync();

            userId = await TokenService.GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            await LoadUserFromUsersListAsync(userId);
            await LoadStatsAsync(userId);
        }
        catch (Exception ex)
        {
            error = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Reload()
    {
        await LoadAsync();
        StateHasChanged();
    }

    private async Task LoadUserFromUsersListAsync(string uid)
    {
        var fallbackName = await TokenService.GetUsernameAsync();

        var resp = await UserService.GetAllUsersAsync();
        if (!resp.IsSuccessStatusCode)
        {
            User = new ProfileUser
            {
                Name = fallbackName ?? uid,
                MemberId = uid,
                MemberSinceUtc = null,
                MembershipLabel = ""
            };
            return;
        }

        await using var stream = await resp.Content.ReadAsStreamAsync();
        using var doc = await JsonDocument.ParseAsync(stream);

        string? nameFromApi = null;

        if (doc.RootElement.ValueKind == JsonValueKind.Array)
        {
            foreach (var u in doc.RootElement.EnumerateArray())
            {
                var id = GetString(u, "id") ?? GetString(u, "Id");
                if (!string.Equals(id, uid, StringComparison.OrdinalIgnoreCase)) continue;

                nameFromApi =
                    GetString(u, "name") ??
                    GetString(u, "Name") ??
                    GetString(u, "username") ??
                    GetString(u, "Username");

                break;
            }
        }

        User = new ProfileUser
        {
            Name = nameFromApi ?? fallbackName ?? uid,
            MemberId = uid,
            MemberSinceUtc = null,
            MembershipLabel = ""
        };
    }

    private async Task LoadStatsAsync(string uid)
    {
        var stats = new ProfileStats();

        stats.Friends = await CountArrayFromResponseAsync(() => SocialService.GetAllFriendsAsync(uid, jwt));
        stats.Classes = await CountArrayFromResponseAsync(() => ClassService.GetClassesByUserIdAsync(uid, jwt));
        stats.Trainings = await CountTrainingsThisMonthAsync(uid);

        Stats = stats;
    }

    private async Task<int> CountTrainingsThisMonthAsync(string uid)
    {
        var now = DateTime.Now;
        var month = now.Month;
        var year = now.Year;

        var classCount = 0;
        var soloCount = 0;

        try
        {
            var res = await AnalyticsService.GetClassResultsAsync(uid, jwt);
            if (res.IsSuccessStatusCode)
            {
                var items = await res.Content.ReadFromJsonAsync<List<ClassResultDTO>>() ?? new List<ClassResultDTO>();
                classCount = items.Count(x => x.Date.Month == month && x.Date.Year == year);
            }
        }
        catch { }

        try
        {
            var res = await AnalyticsService.GetSoloTrainingResultsAsync(uid, jwt);
            if (res.IsSuccessStatusCode)
            {
                var items = await res.Content.ReadFromJsonAsync<List<SoloTrainingResultsDTO>>() ?? new List<SoloTrainingResultsDTO>();
                soloCount = items.Count(x => x.Date.Month == month && x.Date.Year == year);
            }
        }
        catch { }

        return classCount + soloCount;
    }

    private static async Task<int> CountArrayFromResponseAsync(Func<Task<HttpResponseMessage>> call)
    {
        try
        {
            var res = await call();
            if (!res.IsSuccessStatusCode) return 0;

            await using var stream = await res.Content.ReadAsStreamAsync();
            using var doc = await JsonDocument.ParseAsync(stream);

            return doc.RootElement.ValueKind == JsonValueKind.Array
                ? doc.RootElement.GetArrayLength()
                : 0;
        }
        catch
        {
            return 0;
        }
    }

    private string DisplayName => string.IsNullOrWhiteSpace(User?.Name) ? "Profil" : User!.Name!;
    private string Initials => BuildInitials(User?.Name) ?? "ME";

    private string ProfileMeta
    {
        get
        {
            var member = string.IsNullOrWhiteSpace(User?.MemberId) ? null : $"Medlem #{User!.MemberId}";
            var since = User?.MemberSinceUtc.HasValue == true ? $"Siden {User!.MemberSinceUtc.Value:MMM yyyy}" : null;
            return JoinMeta(member, since) ?? " ";
        }
    }

    private string MembershipLabel => string.IsNullOrWhiteSpace(User?.MembershipLabel) ? "" : User!.MembershipLabel!;

    private int StatsTrainings => Stats.Trainings;
    private int StatsClasses => Stats.Classes;
    private int StatsFriends => Stats.Friends;

    private string MyClassesSubtitle => Stats.Classes == 1 ? "1 aktivt hold" : $"{Stats.Classes} aktive hold";
    private string AppointmentsSubtitle => "Se dine tider";
    private string WorkoutsSubtitle => Stats.Trainings == 1 ? "1 i denne måned" : $"{Stats.Trainings} i denne måned";
    private string LockerSubtitle => "Bluetooth skabslås";

    private void GoMyClasses() => Nav.NavigateTo("/classes");
    private void GoAppointments() => Nav.NavigateTo("/appointments");
    private void GoWorkouts() => Nav.NavigateTo("/workouts");
    private void GoStatistics() => Nav.NavigateTo("/statistics");

    private void OpenLocker() => Nav.NavigateTo("/locker");
    private void EditProfile() => Nav.NavigateTo("/profile/edit");

    private async Task Logout()
    {
        await TokenService.ClearAsync();
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private static string? BuildInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return null;

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 0) return null;

        var first = parts[0].Length > 0 ? parts[0][0].ToString() : "";
        var last = parts.Length > 1 && parts[^1].Length > 0 ? parts[^1][0].ToString() : "";

        var initials = (first + last).ToUpperInvariant();
        return string.IsNullOrWhiteSpace(initials) ? null : initials;
    }

    private static string? JoinMeta(string? a, string? b)
    {
        if (string.IsNullOrWhiteSpace(a) && string.IsNullOrWhiteSpace(b)) return null;
        if (string.IsNullOrWhiteSpace(a)) return b;
        if (string.IsNullOrWhiteSpace(b)) return a;
        return $"{a} · {b}";
    }

    private static string? GetString(JsonElement obj, string prop)
    {
        if (obj.ValueKind != JsonValueKind.Object) return null;
        if (!obj.TryGetProperty(prop, out var el)) return null;
        if (el.ValueKind == JsonValueKind.String) return el.GetString();
        return null;
    }

    private sealed class ProfileStats
    {
        public int Trainings { get; set; }
        public int Classes { get; set; }
        public int Friends { get; set; }
    }

    private sealed class ProfileUser
    {
        public string? Name { get; set; }
        public string? MemberId { get; set; }
        public DateTime? MemberSinceUtc { get; set; }
        public string? MembershipLabel { get; set; }
    }
}
