@page "/profile"
@using FitLifeFitness.Components.Layout
@using Microsoft.AspNetCore.Components.Routing
@layout PhoneLayout
@inject NavigationManager Nav

<div class="mehub">

    <header class="mehub-header">
        <div class="mehub-avatar">@Initials</div>
        <div class="mehub-header-text">
            <h2 class="mehub-title">Min side</h2>
            <p class="mehub-sub">@User.Name · @User.MemberId</p>
        </div>
    </header>

    <section class="mehub-quick">
        <button class="quick-tile" @onclick="@(()=>Go("/friends"))">
            <div class="qt-title">Venner</div>
            <div class="qt-meta">@Friends.Count personer</div>
        </button>

        <button class="quick-tile" @onclick="@(()=>Go("/my-classes"))">
            <div class="qt-title">Mine hold</div>
            <div class="qt-meta">@MyClasses.Count hold</div>
        </button>

        <button class="quick-tile" @onclick="@(()=>Go("/appointments"))">
            <div class="qt-title">Aftaler</div>
            <div class="qt-meta">@Appointments.Count kommende</div>
        </button>

        @if (IsCoach)
        {
            <button class="quick-tile coach" @onclick="@(()=>Go("/coach-appointments"))">
                <div class="qt-title">Træningsaftaler</div>
                <div class="qt-meta">@CoachAppointments.Count bookinger</div>
            </button>
        }
    </section>

    <section class="mehub-card">
        <div class="card-head">
            <div class="card-title">Kommende</div>

            <button class="chip" @onclick="ToggleView">
                @if (CalendarView == "List")
                {
                    <span>Kalender</span>
                }
                else
                {
                    <span>Liste</span>
                }
            </button>
        </div>

        @if (CalendarView == "List")
        {
            <div class="event-list">
                @foreach (var e in UpcomingSorted.Take(6))
                {
                    <div class="event-row" @onclick="@(()=>OpenEvent(e))">
                        <div class="event-date">
                            <div class="ed-day">@e.Start.ToString("dd")</div>
                            <div class="ed-mon">@e.Start.ToString("MMM")</div>
                        </div>
                        <div class="event-info">
                            <div class="ei-title">@e.Title</div>
                            <div class="ei-meta">@e.Start.ToString("ddd HH:mm") · @e.Location</div>
                        </div>
                        <div class="event-tag @TagClass(e.Kind)">@KindLabel(e.Kind)</div>
                    </div>
                }

                @if (!UpcomingSorted.Any())
                {
                    <div class="empty">Ingen kommende aktiviteter endnu</div>
                }
            </div>
        }
        else
        {
            <div class="mini-calendar">
                <div class="mc-head">
                    <button class="mc-nav" @onclick="PrevWeek">‹</button>
                    <div class="mc-title">@WeekStart.ToString("dd MMM") til @WeekStart.AddDays(6).ToString("dd MMM")</div>
                    <button class="mc-nav" @onclick="NextWeek">›</button>
                </div>

                <div class="mc-grid">
                    @for (int i = 0; i < 7; i++)
                    {
                        var d = WeekStart.AddDays(i);
                        var count = UpcomingSorted.Count(x => x.Start.Date == d.Date);
                        <div class="mc-day @(d.Date == Today ? "today" : "")" @onclick="@(()=>OpenDay(d))">
                            <div class="mc-dow">@d.ToString("ddd")</div>
                            <div class="mc-num">@d.ToString("dd")</div>
                            <div class="mc-dot @(count > 0 ? "on" : "")"></div>
                            <div class="mc-count">@((count > 0) ? $"{count}" : "")</div>
                        </div>
                    }
                </div>

                <div class="mc-hint">Tryk på en dag for at se aktiviteter</div>
            </div>
        }
    </section>

    <section class="mehub-card">
        <div class="card-head">
            <div class="card-title">Genveje</div>
        </div>

        <div class="shortcut-list">
            <NavLink class="shortcut" href="/settings" Match="NavLinkMatch.Prefix">Indstillinger</NavLink>
            <NavLink class="shortcut" href="/profile" Match="NavLinkMatch.Prefix">Profil</NavLink>
            <NavLink class="shortcut" href="/support" Match="NavLinkMatch.Prefix">Support</NavLink>
        </div>
    </section>

    <section class="mehub-card">
        <div class="card-head">
            <div class="card-title">Coach mode</div>
        </div>

        <div class="coach-row">
            <div class="coach-text">
                <div class="coach-title">Jeg er coach</div>
                <div class="coach-sub">Vis coach genveje og bookinger</div>
            </div>
            <button class="toggle @(IsCoach ? "on" : "")" @onclick="ToggleCoach">
                <div class="knob"></div>
            </button>
        </div>
    </section>

</div>

@code {
    private string CalendarView = "List";

    private DateTime Today => DateTime.Today;
    private DateTime WeekStart;

    private bool IsCoach = true;

    private UserModel User = new()
    {
        Name = "Bruger Eksempel",
        Email = "bruger@fitlife.dk",
        MemberId = "FLF-2048"
    };

    private List<FriendModel> Friends = new()
    {
        new() { Name = "Sara Jensen" },
        new() { Name = "Mikkel Holm" },
        new() { Name = "Nanna Larsen" },
        new() { Name = "Jonas Madsen" }
    };

    private List<ClassModel> MyClasses = new()
    {
        new() { Title = "Pilates", Day = "Tirsdag", Time = "17:00" },
        new() { Title = "HIIT", Day = "Torsdag", Time = "18:30" }
    };

    private List<EventModel> Appointments = new()
    {
        new() { Kind = EventKind.Appointment, Title = "Fysioterapi", Location = "Aarhus", Start = DateTime.Today.AddDays(1).AddHours(10) },
        new() { Kind = EventKind.Class, Title = "Pilates", Location = "Studio 2", Start = DateTime.Today.AddDays(2).AddHours(17) },
        new() { Kind = EventKind.Class, Title = "HIIT", Location = "Studio 1", Start = DateTime.Today.AddDays(4).AddHours(18).AddMinutes(30) }
    };

    private List<EventModel> CoachAppointments = new()
    {
        new() { Kind = EventKind.Coach, Title = "PT session", Location = "Gym floor", Start = DateTime.Today.AddDays(1).AddHours(14) },
        new() { Kind = EventKind.Coach, Title = "Hold intro", Location = "Studio 3", Start = DateTime.Today.AddDays(3).AddHours(16) }
    };

    private IEnumerable<EventModel> UpcomingSorted =>
        (IsCoach ? Appointments.Concat(CoachAppointments) : Appointments)
        .Where(x => x.Start >= DateTime.Now.AddMinutes(-10))
        .OrderBy(x => x.Start);

    protected override void OnInitialized()
    {
        WeekStart = StartOfWeek(DateTime.Today, DayOfWeek.Monday);
    }

    private void Go(string url) => Nav.NavigateTo(url);

    private void ToggleView()
    {
        CalendarView = CalendarView == "List" ? "Calendar" : "List";
    }

    private void ToggleCoach()
    {
        IsCoach = !IsCoach;
    }

    private void PrevWeek() => WeekStart = WeekStart.AddDays(-7);
    private void NextWeek() => WeekStart = WeekStart.AddDays(7);

    private void OpenDay(DateTime day)
    {
        // Her kan du navigere til en filtreret aftale side
        // Nav.NavigateTo($"/appointments?date={day:yyyy-MM-dd}");
    }

    private void OpenEvent(EventModel e)
    {
        // Her kan du navigere til event details
        // Nav.NavigateTo($"/appointments/{e.Id}");
    }

    private string Initials =>
        string.Join("", User.Name.Split(" ", StringSplitOptions.RemoveEmptyEntries).Select(x => x[0])).ToUpper();

    private static DateTime StartOfWeek(DateTime date, DayOfWeek startDay)
    {
        int diff = (7 + (date.DayOfWeek - startDay)) % 7;
        return date.AddDays(-1 * diff).Date;
    }

    private static string KindLabel(EventKind kind) => kind switch
    {
        EventKind.Class => "Hold",
        EventKind.Coach => "Coach",
        _ => "Aftale"
    };

    private static string TagClass(EventKind kind) => kind switch
    {
        EventKind.Class => "tag-class",
        EventKind.Coach => "tag-coach",
        _ => "tag-apt"
    };

    public class UserModel
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string MemberId { get; set; } = "";
    }

    public class FriendModel
    {
        public string Name { get; set; } = "";
    }

    public class ClassModel
    {
        public string Title { get; set; } = "";
        public string Day { get; set; } = "";
        public string Time { get; set; } = "";
    }

    public enum EventKind
    {
        Appointment,
        Class,
        Coach
    }

    public class EventModel
    {
        public string Id { get; set; } = Guid.NewGuid().ToString("N");
        public EventKind Kind { get; set; }
        public string Title { get; set; } = "";
        public string Location { get; set; } = "";
        public DateTime Start { get; set; }
    }
}
