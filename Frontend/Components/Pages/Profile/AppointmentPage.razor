@page "/appointments"
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Services
@using System.Text.Json
@layout PhoneLayout
@inject NavigationManager Nav
@inject TokenService TokenService
@inject ClassService ClassService
@inject CoachingService CoachingService

<div class="appointments-page">
    @if (isLoading)
    {
        <section class="page-header">
            <h1 class="page-title">Aftaler</h1>
            <p class="page-subtitle">Indlæser dine tider...</p>
        </section>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <section class="page-header">
            <h1 class="page-title">Aftaler</h1>
            <p class="page-subtitle">@error</p>
        </section>

        <button class="retry-card" type="button" @onclick="LoadAsync">
            <div class="retry-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
            </div>
            <div class="retry-text">
                <div class="retry-title">Prøv igen</div>
                <div class="retry-subtitle">Genindlæs aftaler</div>
            </div>
        </button>
    }
    else
    {
        <section class="page-header">
            <h1 class="page-title">@PageTitle</h1>
            <p class="page-subtitle">@GetSubtitle()</p>
        </section>

        @if (IsCoachView)
        {
            @if (coachUpcoming.Count > 0)
            {
                <div class="section-header">
                    <div class="section-title">Kommende</div>
                    <div class="section-badge">@coachUpcoming.Count</div>
                </div>

                <section class="appointments-list">
                    @foreach (var apt in coachUpcoming)
                    {
                        <button class="appointment-card upcoming" type="button" @onclick="() => ViewDetails(apt)">
                            <div class="apt-date-badge">
                                <div class="apt-day">@apt.Date.Day</div>
                                <div class="apt-month">@apt.Date.ToString("MMM").ToUpperInvariant()</div>
                            </div>

                            <div class="apt-content">
                                <div class="apt-title">@apt.Title</div>
                                <div class="apt-time">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    @apt.Date.ToString("HH:mm") - @apt.EndTime.ToString("HH:mm")
                                </div>

                                @if (!string.IsNullOrWhiteSpace(apt.ClientName))
                                {
                                    <div class="apt-instructor">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                            <circle cx="12" cy="7" r="4" />
                                        </svg>
                                        @apt.ClientName
                                    </div>
                                }
                            </div>

                            <div class="apt-arrow">›</div>
                        </button>
                    }
                </section>
            }

            @if (coachPast.Count > 0)
            {
                <div class="section-header">
                    <div class="section-title">Tidligere</div>
                    <div class="section-badge">@coachPast.Count</div>
                </div>

                <section class="appointments-list">
                    @foreach (var apt in coachPast)
                    {
                        <button class="appointment-card past" type="button" @onclick="() => ViewDetails(apt)">
                            <div class="apt-date-badge past">
                                <div class="apt-day">@apt.Date.Day</div>
                                <div class="apt-month">@apt.Date.ToString("MMM").ToUpperInvariant()</div>
                            </div>

                            <div class="apt-content">
                                <div class="apt-title">@apt.Title</div>
                                <div class="apt-time">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    @apt.Date.ToString("HH:mm") - @apt.EndTime.ToString("HH:mm")
                                </div>

                                @if (!string.IsNullOrWhiteSpace(apt.ClientName))
                                {
                                    <div class="apt-instructor">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                            <circle cx="12" cy="7" r="4" />
                                        </svg>
                                        @apt.ClientName
                                    </div>
                                }

                                @if (apt.Completed)
                                {
                                    <div class="apt-completed">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12" />
                                        </svg>
                                        Gennemført
                                    </div>
                                }
                            </div>

                            <div class="apt-arrow">›</div>
                        </button>
                    }
                </section>
            }

            @if (coachUpcoming.Count == 0 && coachPast.Count == 0)
            {
                <section class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                    </div>
                    <h3 class="empty-title">Ingen aftaler</h3>
                    <p class="empty-text">Du har ingen bookede sessioner endnu.</p>
                    <button class="empty-action" type="button" @onclick="GoToCoachHome">
                        <span>Gå til coach oversigt</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12" />
                            <polyline points="12 5 19 12 12 19" />
                        </svg>
                    </button>
                </section>
            }

            <button class="fab" type="button" @onclick="CreateCoachSession">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
        }
        else
        {
            @if (upcomingAppointments.Count > 0)
            {
                <div class="section-header">
                    <div class="section-title">Kommende</div>
                    <div class="section-badge">@upcomingAppointments.Count</div>
                </div>

                <section class="appointments-list">
                    @foreach (var apt in upcomingAppointments)
                    {
                        <button class="appointment-card upcoming" type="button" @onclick="() => ViewDetails(apt)">
                            <div class="apt-date-badge">
                                <div class="apt-day">@apt.Date.Day</div>
                                <div class="apt-month">@apt.Date.ToString("MMM").ToUpperInvariant()</div>
                            </div>

                            <div class="apt-content">
                                <div class="apt-title">@apt.Title</div>
                                <div class="apt-time">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    @apt.Date.ToString("HH:mm") - @apt.EndTime.ToString("HH:mm")
                                </div>

                                @if (!string.IsNullOrWhiteSpace(apt.Instructor))
                                {
                                    <div class="apt-instructor">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                            <circle cx="12" cy="7" r="4" />
                                        </svg>
                                        @apt.Instructor
                                    </div>
                                }
                            </div>

                            <div class="apt-arrow">›</div>
                        </button>
                    }
                </section>
            }

            @if (pastAppointments.Count > 0)
            {
                <div class="section-header">
                    <div class="section-title">Tidligere</div>
                    <div class="section-badge">@pastAppointments.Count</div>
                </div>

                <section class="appointments-list">
                    @foreach (var apt in pastAppointments)
                    {
                        <button class="appointment-card past" type="button" @onclick="() => ViewDetails(apt)">
                            <div class="apt-date-badge past">
                                <div class="apt-day">@apt.Date.Day</div>
                                <div class="apt-month">@apt.Date.ToString("MMM").ToUpperInvariant()</div>
                            </div>

                            <div class="apt-content">
                                <div class="apt-title">@apt.Title</div>
                                <div class="apt-time">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    @apt.Date.ToString("HH:mm") - @apt.EndTime.ToString("HH:mm")
                                </div>

                                @if (apt.Completed)
                                {
                                    <div class="apt-completed">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12" />
                                        </svg>
                                        Gennemført
                                    </div>
                                }
                            </div>

                            <div class="apt-arrow">›</div>
                        </button>
                    }
                </section>
            }

            @if (upcomingAppointments.Count == 0 && pastAppointments.Count == 0)
            {
                <section class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                    </div>
                    <h3 class="empty-title">Ingen aftaler</h3>
                    <p class="empty-text">Du har ingen bookede aftaler endnu. Book et hold eller træning for at komme i gang!</p>
                    <button class="empty-action" type="button" @onclick="GoToClasses">
                        <span>Se tilgængelige hold</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12" />
                            <polyline points="12 5 19 12 12 19" />
                        </svg>
                    </button>
                </section>
            }

            <button class="fab" type="button" @onclick="CreateAppointment">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
        }
    }
</div>

@code {
    private string? userId;
    private string? jwt; 
    private bool IsCoachView;

    private List<AppointmentDto> upcomingAppointments = new();
    private List<AppointmentDto> pastAppointments = new();

    private List<CoachAppointmentDto> coachUpcoming = new();
    private List<CoachAppointmentDto> coachPast = new();

    private bool isLoading = true;
    private string? error;

    private string PageTitle => IsCoachView ? "Coach aftaler" : "Aftaler";

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        error = null;

        try
        {

            jwt = await TokenService.GetTokenAsync();
            userId = await TokenService.GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            var role = await TokenService.GetUserRoleAsync();
            IsCoachView = role?.ToString().Equals("Coach", StringComparison.OrdinalIgnoreCase) == true;

            if (IsCoachView)
            {
                await LoadCoachAppointmentsAsync(userId);
            }
            else
            {
                await LoadMemberAppointmentsAsync(userId);
            }
        }
        catch (Exception ex)
        {
            error = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadMemberAppointmentsAsync(string uid)
    {
        var all = new List<AppointmentDto>();

        all.AddRange(await LoadAppointmentsFromClassesAsync(uid));
        all.AddRange(await LoadAppointmentsFromCoachingAsMemberAsync(uid));

        var now = DateTime.Now;
        upcomingAppointments = all.Where(a => a.Date >= now).OrderBy(a => a.Date).ToList();
        pastAppointments = all.Where(a => a.Date < now).OrderByDescending(a => a.Date).Take(10).ToList();
    }

    private async Task LoadCoachAppointmentsAsync(string coachId)
    {
        var all = await LoadAppointmentsFromCoachingAsCoachAsync(coachId);

        var now = DateTime.Now;
        coachUpcoming = all.Where(a => a.Date >= now).OrderBy(a => a.Date).ToList();
        coachPast = all.Where(a => a.Date < now).OrderByDescending(a => a.Date).Take(20).ToList();
    }

    private async Task<List<AppointmentDto>> LoadAppointmentsFromClassesAsync(string uid)
    {
        var list = new List<AppointmentDto>();

        var resp = await ClassService.GetClassesByUserIdAsync(uid, jwt);
        if (!resp.IsSuccessStatusCode) return list;

        await using var stream = await resp.Content.ReadAsStreamAsync();
        using var doc = await JsonDocument.ParseAsync(stream);

        if (doc.RootElement.ValueKind != JsonValueKind.Array) return list;

        foreach (var item in doc.RootElement.EnumerateArray())
        {
            var id = GetString(item, "id") ?? GetString(item, "Id") ?? "";
            if (string.IsNullOrWhiteSpace(id)) continue;

            var title =
                GetString(item, "title") ??
                GetString(item, "Title") ??
                GetString(item, "name") ??
                GetString(item, "Name") ??
                GetString(item, "category") ??
                "Hold";

            var date =
                GetDateTime(item, "date") ??
                GetDateTime(item, "Date") ??
                GetDateTime(item, "startTime") ??
                GetDateTime(item, "StartTime") ??
                default;

            if (date == default) continue;

            var end =
                GetDateTime(item, "endTime") ??
                GetDateTime(item, "EndTime");

            var durationMin =
                GetInt(item, "durationMin") ??
                GetInt(item, "DurationMin") ??
                GetInt(item, "durationMinutes") ??
                GetInt(item, "DurationMinutes");

            if (end == null)
            {
                end = durationMin.HasValue ? date.AddMinutes(durationMin.Value) : date.AddMinutes(60);
            }

            var instructor =
                GetString(item, "coachName") ??
                GetString(item, "CoachName") ??
                GetString(item, "instructor") ??
                GetString(item, "Instructor");

            var completed =
                GetBool(item, "completed") ??
                GetBool(item, "Completed") ??
                (date < DateTime.Now);

            list.Add(new AppointmentDto
            {
                Id = id,
                Source = "class",
                Title = title,
                Date = date,
                EndTime = end.Value,
                Instructor = instructor,
                Completed = completed
            });
        }

        return list;
    }

    private async Task<List<AppointmentDto>> LoadAppointmentsFromCoachingAsMemberAsync(string uid)
    {
        var list = new List<AppointmentDto>();

        var resp = await CoachingService.GetAllSessionsAsync(jwt);
        if (!resp.IsSuccessStatusCode) return list;

        await using var stream = await resp.Content.ReadAsStreamAsync();
        using var doc = await JsonDocument.ParseAsync(stream);

        if (doc.RootElement.ValueKind != JsonValueKind.Array) return list;

        foreach (var item in doc.RootElement.EnumerateArray())
        {
            var bookedUserId =
                GetString(item, "userId") ??
                GetString(item, "UserId") ??
                GetString(item, "bookedUserId") ??
                GetString(item, "BookedUserId");

            if (!string.Equals(bookedUserId, uid, StringComparison.OrdinalIgnoreCase)) continue;

            var id = GetString(item, "id") ?? GetString(item, "Id") ?? "";
            if (string.IsNullOrWhiteSpace(id)) continue;

            var title =
                GetString(item, "title") ??
                GetString(item, "Title") ??
                GetString(item, "sessionTitle") ??
                GetString(item, "SessionTitle") ??
                "Personlig træning";

            var date =
                GetDateTime(item, "date") ??
                GetDateTime(item, "Date") ??
                GetDateTime(item, "startTime") ??
                GetDateTime(item, "StartTime") ??
                default;

            if (date == default) continue;

            var end =
                GetDateTime(item, "endTime") ??
                GetDateTime(item, "EndTime") ??
                date.AddMinutes(GetInt(item, "durationMinutes") ?? GetInt(item, "DurationMinutes") ?? 60);

            var instructor =
                GetString(item, "coachName") ??
                GetString(item, "CoachName") ??
                GetString(item, "instructor") ??
                GetString(item, "Instructor");

            var completed =
                GetBool(item, "completed") ??
                GetBool(item, "Completed") ??
                (date < DateTime.Now);

            list.Add(new AppointmentDto
            {
                Id = id,
                Source = "coaching",
                Title = title,
                Date = date,
                EndTime = end,
                Instructor = instructor,
                Completed = completed
            });
        }

        return list;
    }

    private async Task<List<CoachAppointmentDto>> LoadAppointmentsFromCoachingAsCoachAsync(string coachId)
    {
        var list = new List<CoachAppointmentDto>();

        var resp = await CoachingService.GetAllSessionsAsync(jwt);
        if (!resp.IsSuccessStatusCode) return list;

        await using var stream = await resp.Content.ReadAsStreamAsync();
        using var doc = await JsonDocument.ParseAsync(stream);

        if (doc.RootElement.ValueKind != JsonValueKind.Array) return list;

        foreach (var item in doc.RootElement.EnumerateArray())
        {
            var sessionCoachId =
                GetString(item, "coachId") ??
                GetString(item, "CoachId") ??
                GetString(item, "trainerId") ??
                GetString(item, "TrainerId") ??
                GetString(item, "coachUserId") ??
                GetString(item, "CoachUserId");

            if (!string.Equals(sessionCoachId, coachId, StringComparison.OrdinalIgnoreCase)) continue;

            var id = GetString(item, "id") ?? GetString(item, "Id") ?? "";
            if (string.IsNullOrWhiteSpace(id)) continue;

            var date =
                GetDateTime(item, "date") ??
                GetDateTime(item, "Date") ??
                GetDateTime(item, "startTime") ??
                GetDateTime(item, "StartTime") ??
                default;

            if (date == default) continue;

            var end =
                GetDateTime(item, "endTime") ??
                GetDateTime(item, "EndTime") ??
                date.AddMinutes(GetInt(item, "durationMinutes") ?? GetInt(item, "DurationMinutes") ?? 60);

            var clientName =
                GetString(item, "userName") ??
                GetString(item, "UserName") ??
                GetString(item, "clientName") ??
                GetString(item, "ClientName");

            var titleBase =
                GetString(item, "title") ??
                GetString(item, "Title") ??
                GetString(item, "sessionTitle") ??
                GetString(item, "SessionTitle") ??
                "PT session";

            var title = !string.IsNullOrWhiteSpace(clientName) ? $"{titleBase}" : titleBase;

            var completed =
                GetBool(item, "completed") ??
                GetBool(item, "Completed") ??
                (date < DateTime.Now);

            list.Add(new CoachAppointmentDto
            {
                Id = id,
                Title = title,
                Date = date,
                EndTime = end,
                ClientName = clientName,
                Completed = completed
            });
        }

        return list;
    }

    private string GetSubtitle()
    {
        if (IsCoachView)
        {
            var total = coachUpcoming.Count;
            if (total == 0) return "Ingen kommende tider";
            if (total == 1) return "1 kommende tid";
            return $"{total} kommende tider";
        }
        else
        {
            var total = upcomingAppointments.Count;
            if (total == 0) return "Ingen kommende tider";
            if (total == 1) return "1 kommende tid";
            return $"{total} kommende tider";
        }
    }

    private void ViewDetails(AppointmentDto apt)
    {
        if (apt == null || string.IsNullOrWhiteSpace(apt.Id)) return;

        if (apt.Source == "class")
        {
            Nav.NavigateTo($"/classes/");
            return;
        }

        if (apt.Source == "coaching")
        {
            Nav.NavigateTo($"/trainer");
            return;
        }

        Nav.NavigateTo($"/trainer");
    }

    private void ViewDetails(CoachAppointmentDto apt)
    {
        if (apt == null || string.IsNullOrWhiteSpace(apt.Id)) return;
        Nav.NavigateTo($"/trainer");
    }

    private void CreateAppointment()
    {
        Nav.NavigateTo("/classes");
    }

    private void CreateCoachSession()
    {
        Nav.NavigateTo("/trainer");
    }

    private void GoToClasses()
    {
        Nav.NavigateTo("/classes");
    }

    private void GoToCoachHome()
    {
        Nav.NavigateTo("/trainer");
    }

    private static string? GetString(JsonElement obj, string prop)
    {
        if (obj.ValueKind != JsonValueKind.Object) return null;
        if (!obj.TryGetProperty(prop, out var el)) return null;
        return el.ValueKind == JsonValueKind.String ? el.GetString() : null;
    }

    private static int? GetInt(JsonElement obj, string prop)
    {
        if (obj.ValueKind != JsonValueKind.Object) return null;
        if (!obj.TryGetProperty(prop, out var el)) return null;

        if (el.ValueKind == JsonValueKind.Number && el.TryGetInt32(out var n)) return n;
        if (el.ValueKind == JsonValueKind.String && int.TryParse(el.GetString(), out var s)) return s;

        return null;
    }

    private static bool? GetBool(JsonElement obj, string prop)
    {
        if (obj.ValueKind != JsonValueKind.Object) return null;
        if (!obj.TryGetProperty(prop, out var el)) return null;

        if (el.ValueKind == JsonValueKind.True) return true;
        if (el.ValueKind == JsonValueKind.False) return false;
        if (el.ValueKind == JsonValueKind.String && bool.TryParse(el.GetString(), out var b)) return b;

        return null;
    }

    private static DateTime? GetDateTime(JsonElement obj, string prop)
    {
        if (obj.ValueKind != JsonValueKind.Object) return null;
        if (!obj.TryGetProperty(prop, out var el)) return null;

        if (el.ValueKind == JsonValueKind.String && DateTime.TryParse(el.GetString(), out var dt)) return dt;
        return null;
    }

    private sealed class AppointmentDto
    {
        public string Id { get; set; } = "";
        public string Source { get; set; } = "";
        public string Title { get; set; } = "";
        public DateTime Date { get; set; }
        public DateTime EndTime { get; set; }
        public string? Instructor { get; set; }
        public bool Completed { get; set; }
    }

    private sealed class CoachAppointmentDto
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public DateTime Date { get; set; }
        public DateTime EndTime { get; set; }
        public string? ClientName { get; set; }
        public bool Completed { get; set; }
    }
}
