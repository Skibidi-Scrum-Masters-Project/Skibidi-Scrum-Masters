@page "/profile/edit"
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using System.Net.Http.Json
@layout PhoneLayout
@inject NavigationManager Nav
@inject TokenService TokenService
@inject UserService UserService

<div class="edit-profile-page">
    @if (isLoading)
    {
        <section class="edit-hero-card">
            <div class="edit-avatar-large">...</div>
            <h2 class="edit-title">Indlæser</h2>
            <p class="edit-subtitle">Henter dine oplysninger</p>
        </section>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <section class="edit-hero-card">
            <div class="edit-avatar-large">!</div>
            <h2 class="edit-title">Noget gik galt</h2>
            <p class="edit-subtitle">@error</p>
            <button class="retry-btn" type="button" @onclick="LoadAsync">
                Prøv igen
            </button>
        </section>
    }
    else
    {
        <section class="edit-hero-card">
            <div class="edit-avatar-large">
                @Initials
            </div>
            <h2 class="edit-title">Redigér profil</h2>
            <p class="edit-subtitle">Opdater dine oplysninger</p>
        </section>

        <section class="edit-form">
            <div class="form-group">
                <label class="form-label">Navn</label>
                <input
                    type="text"
                    class="form-input"
                    placeholder="Dit fulde navn"
                    @bind="name"
                    @bind:event="oninput" />
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input
                    type="email"
                    class="form-input"
                    placeholder="din@email.dk"
                    @bind="email"
                    @bind:event="oninput"
                    disabled />
                <p class="form-hint">Email kan ikke ændres</p>
            </div>

            <div class="form-group">
                <label class="form-label">Nummerplade</label>
                <input
                    type="text"
                    class="form-input"
                    placeholder="AB 12 345"
                    @bind="licensePlate"
                    @bind:event="oninput" />
                <p class="form-hint">Bruges til check ind og parkering</p>
            </div>

            @if (!string.IsNullOrWhiteSpace(membershipLabel))
            {
                <div class="membership-display">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    <span>@membershipLabel</span>
                </div>
            }
        </section>

        @if (!string.IsNullOrWhiteSpace(saveMessage))
        {
            <div class="save-message @(saveSuccess ? "success" : "error")">
                @saveMessage
            </div>
        }

        <section class="action-buttons">
            <button
                class="save-btn"
                type="button"
                @onclick="SaveChanges"
                disabled="@isSaving">
                @if (isSaving)
                {
                    <span>Gemmer...</span>
                }
                else
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    <span>Gem ændringer</span>
                }
            </button>

            <button
                class="cancel-btn"
                type="button"
                @onclick="Cancel"
                disabled="@isSaving">
                Annuller
            </button>
        </section>
    }
</div>

@code {
    private string? userId;
    private string? name;
    private string? email;
    private string? licensePlate;
    private string? membershipLabel;

    private bool isLoading = true;
    private bool isSaving = false;
    private string? error;
    private string? saveMessage;
    private bool saveSuccess;
    private string? jwt;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        jwt = await TokenService.GetTokenAsync();
        isLoading = true;
        error = null;
        saveMessage = null;

        try
        {


            userId = await TokenService.GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            var resp = await UserService.GetUserByIdAsync(userId);
            if (!resp.IsSuccessStatusCode)
            {
                error = $"Kunne ikke hente bruger: {(int)resp.StatusCode}";
                return;
            }

            var dto = await resp.Content.ReadFromJsonAsync<UserProfileDto>();
            if (dto == null)
            {
                error = "Kunne ikke læse brugerdata";
                return;
            }

            name = dto.Name;
            email = dto.Email;
            licensePlate = dto.LicensePlate;
            membershipLabel = dto.MembershipLabel;
        }
        catch (Exception ex)
        {
            error = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveChanges()
    {
        if (isSaving) return;

        isSaving = true;
        saveMessage = null;

        try
        {
            var updateDto = new UpdateUserDto
            {
                Name = name,
                LicensePlate = licensePlate
            };

            var resp = await UserService.UpdateUserAsync(userId!, updateDto, jwt);

            if (resp.IsSuccessStatusCode)
            {
                saveSuccess = true;
                saveMessage = "Dine ændringer er gemt";
                await Task.Delay(1500);
                Nav.NavigateTo("/profile");
            }
            else
            {
                saveSuccess = false;
                saveMessage = $"Kunne ikke gemme: {(int)resp.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            saveSuccess = false;
            saveMessage = $"Fejl: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/profile");
    }

    private string Initials => BuildInitials(name) ?? "ME";

    private static string? BuildInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return null;

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 0) return null;

        var first = parts[0].Length > 0 ? parts[0][0].ToString() : "";
        var last = parts.Length > 1 && parts[^1].Length > 0 ? parts[^1][0].ToString() : "";

        var initials = (first + last).ToUpperInvariant();
        return string.IsNullOrWhiteSpace(initials) ? null : initials;
    }

    private sealed class UserProfileDto
    {
        public string? Id { get; set; }
        public string? Name { get; set; }
        public string? Email { get; set; }
        public string? LicensePlate { get; set; }
        public string? MembershipLabel { get; set; }
    }

    private sealed class UpdateUserDto
    {
        public string? Name { get; set; }
        public string? LicensePlate { get; set; }
    }
}
