@page "/dashboard"
@layout PhoneLayout
@using FitLifeFitness.Services
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components
@using System.Net.Http.Json
@using System.Globalization
@using FitLifeFitness.Components.Layout

@inject SocialService SocialService
@inject TokenService TokenService
@inject NavigationManager Nav
@inject AnalyticsService AnalyticsService

<div class="dashboard">
    <main class="dashboard-body">

        @if (isAnalyticsLoading)
        {
            <section class="welcome-card">
                <div class="welcome-top">
                    <div class="welcome-left">
                        <p class="welcome-small">Din status</p>
                        <h2 class="welcome-title">@Username</h2>

                        <div class="streak-row">
                            <span class="streak-badge">üî• Indl√¶ser streak...</span>
                            <span class="streak-sub">Henter dine data</span>
                        </div>
                    </div>
                </div>

                <p class="welcome-message">Indl√¶ser...</p>

                <button class="primary-cta" disabled type="button">
                    Start dagens tr√¶ning
                </button>
            </section>

            <section class="crowd-card">
                <div class="crowd-head">
                    <span>Travlhed</span>
                    <span class="crowd-label">Nu</span>
                </div>

                <div class="bar">
                    <div class="bar-fill" style="width:100%"></div>
                </div>

                <div class="crowd-info-row">
                    <span>Indl√¶ser...</span>
                    <button class="link-secondary" type="button" @onclick="GoToCrowd">Se Travlhed</button>
                </div>

                <button class="unlock-btn" @onclick="GoToLocker" type="button">Check ind</button>
            </section>
        }
        else if (!string.IsNullOrWhiteSpace(analyticsError))
        {
            <section class="welcome-card">
                <div class="welcome-top">
                    <div class="welcome-left">
                        <p class="welcome-small">Din status</p>
                        <h2 class="welcome-title">@Username</h2>

                        <div class="streak-row">
                            <span class="streak-badge">‚ö†Ô∏è Kunne ikke hente data</span>
                            <span class="streak-sub">@analyticsError</span>
                        </div>
                    </div>
                </div>

                <p class="welcome-message">
                    Vi kunne ikke hente dine streak og travlhed lige nu.
                </p>

                <button class="primary-cta" @onclick="GoToTrainingPrograms" type="button">
                    Start dagens tr√¶ning
                </button>
            </section>

            <section class="crowd-card">
                <div class="crowd-head">
                    <span>Travlhed</span>
                    <span class="crowd-label">Nu</span>
                </div>

                <div class="bar">
                    <div class="bar-fill" style="width:100%"></div>
                </div>

                <div class="crowd-info-row">
                    <span>Ingen data</span>
                    <button class="link-secondary" type="button" @onclick="GoToCrowd">Se Travlhed</button>
                </div>

                <button class="unlock-btn" @onclick="GoToLocker" type="button">Check ind</button>
            </section>
        }
        else
        {
            <section class="welcome-card">
                <div class="welcome-top">
                    <div class="welcome-left">
                        <p class="welcome-small">Din status</p>
                        <h2 class="welcome-title">@Username</h2>

                        <div class="streak-row">
                            <span class="streak-badge">üî• @StreakWeeks ugers streak</span>
                            <span class="streak-sub">@StreakSubtitle</span>
                        </div>
                    </div>
                </div>

                <p class="welcome-message">
                    @WelcomeMessage
                </p>

                <button class="primary-cta" @onclick="GoToTrainingPrograms" type="button">
                    Start dagens tr√¶ning
                </button>
            </section>

            <section class="crowd-card">
                <div class="crowd-head">
                    <span>Travlhed</span>
                    <span class="crowd-label">Nu</span>
                </div>

                <div class="bar">
                    <div class="bar-fill" style="width:100%; background:@CrowdColor"></div>
                </div>

                <div class="crowd-info-row">
                    <span>@CrowdInfoText</span>
                    <button class="link-secondary" type="button" @onclick="GoToCrowd">Se Travlhed</button>
                </div>

                <button class="unlock-btn" @onclick="GoToLocker" type="button">Check ind</button>
            </section>
        }

        <section class="action-stack">
            <button class="stack-card" @onclick="GoToPersonalTraining" type="button">
                <div class="stack-ico">üßë‚Äçüè´</div>
                <div class="stack-text">
                    <div class="stack-title">Book personlig tr√¶ner</div>
                    <div class="stack-sub">F√• et skr√¶ddersyet forl√∏b</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>

            <button class="stack-card" @onclick="GoToTrainingPrograms" type="button">
                <div class="stack-ico">üèãÔ∏è</div>
                <div class="stack-text">
                    <div class="stack-title">Tr√¶ningsplaner</div>
                    <div class="stack-sub">Se alle programmer</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>

            <button class="stack-card" @onclick="GoToClasses" type="button">
                <div class="stack-ico">üóìÔ∏è</div>
                <div class="stack-text">
                    <div class="stack-title">Holdbooking</div>
                    <div class="stack-sub">Book n√¶ste hold</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>
        </section>

        <section class="feed-preview">
            <div class="feed-head">
                <h2>Feed</h2>
                <button class="link" @onclick="GoToFeed" type="button">√Öbn feed</button>
            </div>

            <div class="feed-tabs">
                <button class="tab @(activeFeedTab == "all" ? "active" : "")"
                        @onclick='() => SwitchTab("all")' type="button">
                    Alle
                </button>

                <button class="tab @(activeFeedTab == "ready" ? "active" : "")"
                        @onclick='() => SwitchTab("ready")' type="button">
                    Klar til deling
                </button>
            </div>

            @if (isFeedLoading)
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>Loader feed...</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(feedError))
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>@feedError</span>
                    </div>
                </div>
            }
            else if (feedItems.Count == 0)
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>@(activeFeedTab == "ready" ? "Ingen tr√¶ninger klar til deling endnu." : "Ingen opslag endnu.")</span>
                    </div>
                </div>
            }
            else
            {
                @foreach (var post in feedItems.Take(1))
                {
                    <article class="post-card"
                             role="button"
                             tabindex="0"
                             @onclick="() => GoToPost(post.Id)">
                        <div class="post-content-line">
                            <span>@(string.IsNullOrWhiteSpace(post.PostContent) ? "Nyt opslag" : post.PostContent)</span>
                            <span class="trophy-icon">üèÜ</span>
                        </div>

                        <div class="post-head">
                            <div class="post-avatar">@GetInitial(GetDisplayName(post))</div>
                            <div>
                                <div class="post-name">@GetDisplayName(post)</div>
                                <div class="post-sub">@FormatWhen(post.PostDate)</div>
                            </div>
                        </div>
                    </article>
                }
            }
        </section>

    </main>
</div>

@code {
    private string? LoggedInUserId { get; set; }
    private string? Username { get; set; }

    private string activeFeedTab = "all";
    private bool isFeedLoading;
    private string feedError = string.Empty;
    private List<Post> feedItems = new();

    private bool isAnalyticsLoading;
    private string analyticsError = string.Empty;

    private List<ClassResultDTO> ClassResults = new();
    private List<SoloTrainingResultsDTO> SoloTrainingResults = new();
    private int CrowdCount;

    private const int MaxPeopleCapacity = 2;

    private int StreakWeeks { get; set; }
    private int StreakWorkouts { get; set; }

    private bool HasAnyWorkouts => (ClassResults?.Count ?? 0) > 0 || (SoloTrainingResults?.Count ?? 0) > 0;

    private string StreakSubtitle =>
        HasAnyWorkouts
            ? "Forts√¶t for at sl√• din rekord"
            : "Gennemf√∏r din f√∏rste tr√¶ning for at starte en streak";

    private string WelcomeMessage =>
        HasAnyWorkouts
            ? $"Fantastisk arbejde. Du har tr√¶net {StreakWeeks} uger i streg. Klar til n√¶ste session?"
            : "Du har ingen tr√¶ninger endnu. Start din f√∏rste tr√¶ning og byg en streak op.";

    private int CrowdPercent
    {
        get
        {
            if (MaxPeopleCapacity <= 0) return 0;
            var p = (int)Math.Round((CrowdCount / (double)MaxPeopleCapacity) * 100.0);
            return Math.Clamp(p, 0, 100);
        }
    }

    private string CrowdLabel => GetLevelLabel(CrowdPercent);
    private string CrowdColor => GetLevelColor(CrowdPercent);

    private string CrowdInfoText => CrowdLabel switch
    {
        "Roligt" => "Roligt: Forvent ingen ventetid.",
        "Mellem" => "Moderat: Forvent kort ventetid.",
        "Travlt" => "Travlt: Forvent ventetid ved popul√¶re maskiner.",
        _ => "Meget travlt: Overvej at komme senere."
    };

    protected override async Task OnInitializedAsync()
    {
        LoggedInUserId = await TokenService.GetUserIdAsync();
        Username = await TokenService.GetUsernameAsync();

        await Task.WhenAll(
            LoadAnalyticsAsync(),
            LoadFeedAsync()
        );
    }

    private async Task SwitchTab(string tab)
    {
        if (activeFeedTab == tab) return;
        activeFeedTab = tab;
        await LoadFeedAsync();
    }

    private async Task LoadAnalyticsAsync()
    {
        isAnalyticsLoading = true;
        analyticsError = string.Empty;

        try
        {
            if (string.IsNullOrWhiteSpace(LoggedInUserId))
            {
                analyticsError = "Kunne ikke finde bruger id. Log ind igen.";
                return;
            }

            var res = await AnalyticsService.GetDashboardAsync(LoggedInUserId);

            if (!res.IsSuccessStatusCode)
            {
                analyticsError = $"Analytics fejlede: {(int)res.StatusCode} {res.ReasonPhrase}";
                return;
            }

            var dashboard = await res.Content.ReadFromJsonAsync<AnalyticsDashboardDTO>();

            ClassResults = dashboard?.ClassResults ?? new();
            SoloTrainingResults = dashboard?.SoloTrainingResults ?? new();
            CrowdCount = dashboard?.CrowdCount ?? 0;

            ComputeStreakFromResults();
        }
        catch (Exception ex)
        {
            analyticsError = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isAnalyticsLoading = false;
        }
    }

    private void ComputeStreakFromResults()
    {
        var allWorkoutDates = new List<DateTime>();
        allWorkoutDates.AddRange(ClassResults.Select(x => x.Date));
        allWorkoutDates.AddRange(SoloTrainingResults.Select(x => x.Date));

        if (allWorkoutDates.Count == 0)
        {
            StreakWeeks = 0;
            StreakWorkouts = 0;
            return;
        }

        var weekCounts = allWorkoutDates
            .GroupBy(d => (Year: ISOWeek.GetYear(d), Week: ISOWeek.GetWeekOfYear(d)))
            .ToDictionary(g => g.Key, g => g.Count());

        var today = DateTime.Today;
        var curYear = ISOWeek.GetYear(today);
        var curWeek = ISOWeek.GetWeekOfYear(today);

        int streakWeeks = 0;
        int streakWorkouts = 0;

        var y = curYear;
        var w = curWeek;

        for (int i = 0; i < 60; i++)
        {
            var key = (Year: y, Week: w);
            if (!weekCounts.TryGetValue(key, out var cnt) || cnt <= 0)
                break;

            streakWeeks++;
            streakWorkouts += cnt;

            w--;
            if (w <= 0)
            {
                y--;
                w = ISOWeek.GetWeeksInYear(y);
            }
        }

        StreakWeeks = streakWeeks;
        StreakWorkouts = streakWorkouts;
    }

    private async Task LoadFeedAsync()
    {
        isFeedLoading = true;
        feedError = string.Empty;
        feedItems.Clear();

        try
        {
            if (string.IsNullOrWhiteSpace(LoggedInUserId))
            {
                feedError = "Kunne ikke finde bruger id. Log ind igen.";
                return;
            }

            var res =
                activeFeedTab == "ready"
                    ? await SocialService.SeeAllDraftPostsForUserAsync(LoggedInUserId)
                    : await SocialService.SeeAllFriendsPostsAsync(LoggedInUserId);

            if (!res.IsSuccessStatusCode)
            {
                feedError = $"Feed fejlede: {(int)res.StatusCode} {res.ReasonPhrase}";
                return;
            }

            feedItems = await res.Content.ReadFromJsonAsync<List<Post>>() ?? new List<Post>();
        }
        catch (Exception ex)
        {
            feedError = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isFeedLoading = false;
        }
    }

    private static string GetDisplayName(Post post)
    {
        if (!string.IsNullOrWhiteSpace(post.UserName))
            return post.UserName.Trim();

        return "Bruger";
    }

    private void GoToPost(string? postId)
    {
        if (string.IsNullOrWhiteSpace(postId)) return;
        Nav.NavigateTo($"/post/{postId}");
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }

    private static string FormatWhen(DateTime dt)
    {
        if (dt == default) return "";
        return dt.ToString("dd-MM-yyyy HH:mm");
    }

    private static string GetLevelLabel(int percent) => percent switch
    {
        <= 30 => "Roligt",
        <= 60 => "Mellem",
        <= 85 => "Travlt",
        _ => "Meget travlt"
    };

    private static string GetLevelColor(int percent) => percent switch
    {
        <= 30 => "rgb(36, 195, 106)",
        <= 60 => "rgb(255, 193, 7)",
        <= 85 => "rgb(255, 152, 0)",
        _ => "rgb(235, 72, 72)"
    };

    void GoToTrainingPrograms() => Nav.NavigateTo("/training");
    void GoToClasses() => Nav.NavigateTo("/classes");
    void GoToFeed() => Nav.NavigateTo("/feedpage");
    void GoToDashboard() => Nav.NavigateTo("/dashboard");
    void GoToLocker() => Nav.NavigateTo("/locker");
    void GoToProfile() => Nav.NavigateTo("/profile");
    void GoToPersonalTraining() => Nav.NavigateTo("/trainer/book");
    void GoToCrowd() => Nav.NavigateTo("/crowd");
}
