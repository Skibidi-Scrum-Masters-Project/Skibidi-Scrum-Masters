@* Dashboard.razor *@
@page "/dashboard"
@layout EmptyLayout
@using FitLifeFitness.Services
@using FitLifeFitness.Models
@using Microsoft.AspNetCore.Components
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@inject SocialService SocialService
@inject TokenService TokenService

<div class="dashboard">

    <header class="topbar">
        <div class="topbar-left">
            <h1 class="brand">FitLife Fitness</h1>
            <p class="welcome">Velkommen tilbage, @Username</p>
        </div>

        <div class="topbar-right">
            <div class="avatar" role="button" tabindex="0" @onclick="GoToProfile">@UserInitial</div>
        </div>
    </header>

    <main class="dashboard-body">
        <section class="welcome-card">
            <div class="welcome-top">
                <div class="welcome-left">
                    <p class="welcome-small">Din status</p>
                    <h2 class="welcome-title">@Username</h2>

                    <div class="streak-row">
                        <span class="streak-badge">üî• 5 ugers streak</span>
                        <span class="streak-sub">Forts√¶t for at sl√• din rekord</span>
                    </div>
                </div>
            </div>

            <p class="welcome-message">
                Fantastisk arbejde. Du har tr√¶net <strong>5 uger i streg</strong>. Klar til n√¶ste session?
            </p>

            <button class="primary-cta" @onclick="GoToTrainingPrograms" type="button">
                Start dagens tr√¶ning
            </button>
        </section>

        <section class="crowd-card">
            <div class="crowd-head">
                <span>Travlhed</span>
                <span class="crowd-label">Nu</span>
            </div>

            <div class="bar">
                <div class="bar-fill medium"></div>
            </div>

            <div class="crowd-info-row">
                <span>Medium: Forvent kort ventetid.</span>
                <button class="link-secondary" type="button">Se Travlhed</button>
            </div>

            <button class="unlock-btn" @onclick="GoToLocker" type="button">Check ind</button>
        </section>

        <section class="action-stack">
            <button class="stack-card" @onclick="GoToPersonalTraining" type="button">
                <div class="stack-ico">üßë‚Äçüè´</div>
                <div class="stack-text">
                    <div class="stack-title">Book personlig tr√¶ner</div>
                    <div class="stack-sub">F√• et skr√¶ddersyet forl√∏b</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>

            <button class="stack-card" @onclick="GoToTrainingPrograms" type="button">
                <div class="stack-ico">üèãÔ∏è</div>
                <div class="stack-text">
                    <div class="stack-title">Tr√¶ningsplaner</div>
                    <div class="stack-sub">Se alle programmer</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>

            <button class="stack-card" @onclick="GoToClasses" type="button">
                <div class="stack-ico">üóìÔ∏è</div>
                <div class="stack-text">
                    <div class="stack-title">Holdbooking</div>
                    <div class="stack-sub">Book n√¶ste hold</div>
                </div>
                <div class="stack-arrow">‚Ä∫</div>
            </button>
        </section>

        <section class="feed-preview">
            <div class="feed-head">
                <h2>Feed</h2>
                <button class="link" @onclick="GoToFeed" type="button">√Öbn feed</button>
            </div>

            <div class="feed-tabs">
                <button class="tab @(activeFeedTab == "all" ? "active" : "")"
                        @onclick='() => SwitchTab("all")' type="button">
                    Alle
                </button>

                <button class="tab @(activeFeedTab == "ready" ? "active" : "")"
                        @onclick='() => SwitchTab("ready")' type="button">
                    Klar til deling
                </button>

                @if (activeFeedTab != "ready")
                {
                    <span class="add-post-icon" role="button" tabindex="0">+</span>
                }
            </div>

            @if (isFeedLoading)
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>Loader feed...</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(feedError))
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>@feedError</span>
                    </div>
                </div>
            }
            else if (feedItems.Count == 0)
            {
                <div class="post-card">
                    <div class="post-content-line">
                        <span>@(activeFeedTab == "ready" ? "Ingen tr√¶ninger klar til deling endnu." : "Ingen opslag endnu.")</span>
                    </div>
                </div>
            }
            else
            {
                @foreach (var post in feedItems.Take(1))
                {
                    <article class="post-card"
                             role="button"
                             tabindex="0"
                             @onclick="() => GoToPost(post.Id)">
                        <div class="post-content-line">
                            <span>@(string.IsNullOrWhiteSpace(post.PostContent) ? "Nyt opslag" : post.PostContent)</span>
                            <span class="trophy-icon">üèÜ</span>
                        </div>

                        <div class="post-head">
                            <div class="post-avatar">@GetInitial(GetDisplayName(post))</div>
                            <div>
                                <div class="post-name">@GetDisplayName(post)</div>
                                <div class="post-sub">@FormatWhen(post.PostDate)</div>
                            </div>
                        </div>
                    </article>
                }
            }
        </section>
    </main>

    <nav class="bottom-nav" aria-label="Bund navigation">
        <button class="bn-item active" @onclick="GoToDashboard" aria-label="Hjem" type="button">
            <span class="bn-ico">‚åÇ</span>
            <span class="bn-lbl">Hjem</span>
        </button>

        <button class="bn-item" @onclick="GoToTrainingPrograms" aria-label="Tr√¶ning" type="button">
            <span class="bn-ico">üí™</span>
            <span class="bn-lbl">Tr√¶ning</span>
        </button>

        <button class="bn-item" @onclick="GoToClasses" aria-label="Hold" type="button">
            <span class="bn-ico">üóìÔ∏è</span>
            <span class="bn-lbl">Hold</span>
        </button>

        <button class="bn-item" @onclick="GoToFeed" aria-label="F√¶llesskab" type="button">
            <span class="bn-ico">üë•</span>
            <span class="bn-lbl">F√¶llesskab</span>
        </button>

        <button class="bn-item" aria-label="Skab" type="button">
            <span class="bn-ico">üö™</span>
            <span class="bn-lbl">Adgang</span>
        </button>
    </nav>

</div>

@code {
    [Inject] NavigationManager Nav { get; set; } = default!;

    private string? LoggedInUserId { get; set; }
    private string? Username { get; set; }
    private string UserInitial => GetInitial(Username);

    private string activeFeedTab = "all";
    private bool isFeedLoading;
    private string feedError = string.Empty;

    private List<Post> feedItems = new();

    protected override async Task OnInitializedAsync()
    {
        LoggedInUserId = await TokenService.GetUserIdAsync();
        Username = await TokenService.GetUsernameAsync();

        await LoadFeedAsync();
    }

    private async Task SwitchTab(string tab)
    {
        if (activeFeedTab == tab) return;
        activeFeedTab = tab;
        await LoadFeedAsync();
    }

    private async Task LoadFeedAsync()
    {
        isFeedLoading = true;
        feedError = string.Empty;
        feedItems.Clear();

        try
        {
            if (string.IsNullOrWhiteSpace(LoggedInUserId))
            {
                feedError = "Kunne ikke finde bruger id. Log ind igen.";
                return;
            }

            var res =
                activeFeedTab == "ready"
                    ? await SocialService.SeeAllDraftPostsForUserAsync(LoggedInUserId)
                    : await SocialService.SeeAllFriendsPostsAsync(LoggedInUserId);

            if (!res.IsSuccessStatusCode)
            {
                feedError = $"Feed fejlede: {(int)res.StatusCode} {res.ReasonPhrase}";
                return;
            }

            feedItems = await res.Content.ReadFromJsonAsync<List<Post>>() ?? new List<Post>();
        }
        catch (Exception ex)
        {
            feedError = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isFeedLoading = false;
        }
    }
    
    private static string GetDisplayName(Post post)
    {
        if (!string.IsNullOrWhiteSpace(post.UserName))
            return post.UserName.Trim();
        
        return "Bruger";
    }

    private void GoToPost(string? postId)
    {
        if (string.IsNullOrWhiteSpace(postId)) return;
        Nav.NavigateTo($"/post/{postId}");
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }

    private static string FormatWhen(DateTime dt)
    {
        if (dt == default) return "";
        return dt.ToString("dd-MM-yyyy HH:mm");
    }

    void GoToTrainingPrograms() => Nav.NavigateTo("/training");
    void GoToClasses() => Nav.NavigateTo("/classes");
    void GoToFeed() => Nav.NavigateTo("/feedpage");
    void GoToDashboard() => Nav.NavigateTo("/dashboard");
    void GoToLocker() => Nav.NavigateTo("/locker");
    void GoToProfile() => Nav.NavigateTo("/profile");
    void GoToPersonalTraining() => Nav.NavigateTo("/personaltraining");
}
