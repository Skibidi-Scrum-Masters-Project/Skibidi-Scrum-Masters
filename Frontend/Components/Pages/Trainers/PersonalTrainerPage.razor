@page "/trainer"

@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services

@inject CoachingService CoachingService
@inject TokenService TokenService
@inject UserService UserService

@layout PhoneLayout

<div class="trainer-screen">
    <section class="trainer-hero">
        <div class="trainer-hero-top">
            <div class="trainer-hero-text">
                <h2 class="trainer-title">Mine sessioner</h2>
                <p class="trainer-subtitle">Overblik over dine tider som personlig tr√¶ner</p>
            </div>

            <button class="fab" type="button" @onclick="OpenCreateSession" aria-label="Tilf√∏j session">
                <span class="fab-plus">+</span>
            </button>
        </div>

        <div class="trainer-hero-pills">
            <div class="hero-pill">
                <span class="pill-dot"></span>
                <span class="pill-text">@_available.Count ledige</span>
            </div>
            <div class="hero-pill blue">
                <span class="pill-dot"></span>
                <span class="pill-text">@_planned.Count planlagte</span>
            </div>
        </div>
    </section>

    <div class="trainer-body">
        @if (_isLoading)
        {
            <div class="state-card">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Indl√¶ser dine sessioner...</p>
                </div>
            </div>
        }
        else
        {
            @if (!string.IsNullOrWhiteSpace(_pageError))
            {
                <div class="todo-card">
                    <div class="todo-title">Fejl</div>
                    <div style="color:rgba(252,165,165,0.95); font-weight:800; line-height:1.4;">
                        @_pageError
                    </div>
                </div>
            }

            <div class="trainer-tabs">
                <button class="trainer-tab @(ActiveTab == Tab.Available ? "active" : "")"
                        type="button"
                        @onclick="() => ActiveTab = Tab.Available">
                    Ledige
                </button>

                <button class="trainer-tab @(ActiveTab == Tab.Planned ? "active" : "")"
                        type="button"
                        @onclick="() => ActiveTab = Tab.Planned">
                    Planlagte
                </button>
            </div>

            @if (ActiveTab == Tab.Available)
            {
                <section class="section-card">
                    <div class="section-head">
                        <div class="section-title">
                            <span class="section-dot green"></span>
                            Ledige tider
                        </div>
                        <div class="section-sub">Opret flere tider</div>
                    </div>

                    @if (!_available.Any())
                    {
                        <div class="empty-box">
                            <div class="empty-ico">üïê</div>
                            <div class="empty-title">Ingen ledige tider</div>
                            <div class="empty-sub">Opret en ny session for at g√∏re den bookbar.</div>
                        </div>
                    }
                    else
                    {
                        <div class="session-list">
                            @foreach (var s in _available)
                            {
                                @SessionCard(s, false)
                            }
                        </div>
                    }
                </section>
            }
            else
            {
                <section class="section-card">
                    <div class="section-head">
                        <div class="section-title">
                            <span class="section-dot blue"></span>
                            Planlagte sessioner
                        </div>
                        <div class="section-sub">Se hvem der har booket og l√¶s detaljer.</div>
                    </div>

                    @if (!_planned.Any())
                    {
                        <div class="empty-box">
                            <div class="empty-ico">üì≠</div>
                            <div class="empty-title">Ingen planlagte sessioner</div>
                            <div class="empty-sub">N√•r en kunde booker, vises den her.</div>
                        </div>
                    }
                    else
                    {
                        <div class="session-list">
                            @foreach (var s in _planned)
                            {
                                @SessionCard(s, true)
                            }
                        </div>
                    }
                </section>
            }
            
        }
    </div>
</div>

@if (_selectedSession is not null)
{
    <div class="modal-backdrop" @onclick="CloseDetails">
        <div class="modal-card" @onclick:stopPropagation="true">
            <div class="modal-head">
                <div class="modal-title">Bookingdetaljer</div>
                <button class="modal-x" type="button" @onclick="CloseDetails" aria-label="Luk">‚úï</button>
            </div>

            <div class="modal-row">
                <div class="modal-label">Kunde</div>
                <div class="modal-value">@_selectedCustomerName</div>
            </div>

            <div class="modal-row">
                <div class="modal-label">M√•l</div>
                <div class="modal-value multiline">@(_selectedSession.BookingForm?.Goals ?? "-")</div>
            </div>

            <div class="modal-row">
                <div class="modal-label">Noter</div>
                <div class="modal-value multiline">@(_selectedSession.BookingForm?.Notes ?? "-")</div>
            </div>

            <div class="modal-row">
                <div class="modal-label">Erfaring</div>
                <div class="modal-value">@ExperienceText(_selectedSession.BookingForm?.Experience)</div>
            </div>

            <div class="modal-meta">
                Oprettet:
                @(
                    _selectedSession.BookingForm != null
                        ? _selectedSession.BookingForm.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")
                        : "-"
                )
            </div>

            <button class="primary-btn" type="button" @onclick="CloseDetails">
                Luk
            </button>
        </div>
    </div>
}

@if (_showCreateModal)
{
    <div class="modal-backdrop" @onclick="CloseCreateSession">
        <div class="modal-card" @onclick:stopPropagation="true">
            <div class="modal-head">
                <div class="modal-title">Tilf√∏j ny session</div>
                <button class="modal-x" type="button" @onclick="CloseCreateSession" aria-label="Luk">‚úï</button>
            </div>

            <div class="field">
                <label class="field-label">Start tidspunkt</label>
                <input class="field-input" type="datetime-local" @bind="_newStartTime" />
            </div>

            <div class="field">
                <label class="field-label">Slut tidspunkt</label>
                <input class="field-input" type="datetime-local" @bind="_newEndTime" />
            </div>

            <div class="btn-row">
                <button class="ghost-btn" type="button" @onclick="CloseCreateSession">Annuller</button>
                <button class="primary-btn" type="button" @onclick="CreateSession">Tilf√∏j</button>
            </div>
        </div>
    </div>
}

@if (_deleteCandidate is not null)
{
    <div class="modal-backdrop" @onclick="CancelDelete">
        <div class="modal-card" @onclick:stopPropagation="true">
            <div class="modal-head">
                <div class="modal-title">Slet session</div>
                <button class="modal-x" type="button" @onclick="CancelDelete" aria-label="Luk">‚úï</button>
            </div>

            <div class="modal-row">
                <div class="modal-label">Tid</div>
                <div class="modal-value">
                    @FormatDate(_deleteCandidate.StartTime) @FormatTime(_deleteCandidate.StartTime) - @FormatTime(_deleteCandidate.EndTime)
                </div>
            </div>

            <div class="modal-row">
                <div class="modal-label">Status</div>
                <div class="modal-value">@(_deleteCandidate.CurrentStatus.ToString())</div>
            </div>

            <div class="modal-meta" style="margin-top:0;">
                Denne handling kan ikke fortrydes.
            </div>

            <div class="btn-row" style="margin-top:14px;">
                <button class="ghost-btn" type="button" @onclick="CancelDelete">Annuller</button>
                <button class="danger-btn" type="button" @onclick="ConfirmDelete" disabled="@_isDeleting">
                    @(_isDeleting ? "Sletter..." : "Slet")
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(_deleteError))
            {
                <div style="margin-top:12px; color:rgba(252,165,165,0.95); font-weight:800; line-height:1.35;">
                    @_deleteError
                </div>
            }
        </div>
    </div>
}

@code {
    private enum Tab { Available, Planned }

    private Tab ActiveTab = Tab.Available;

    private bool _isLoading = true;
    private string? _pageError;

    private List<CoachingSession.SessionDto> _available = new();
    private List<CoachingSession.SessionDto> _planned = new();
    private Dictionary<string, UserDto> _users = new();

    private CoachingSession.SessionDto? _selectedSession;
    private string _selectedCustomerName = "Ukendt kunde";

    private bool _showCreateModal = false;
    private DateTime _newStartTime;
    private DateTime _newEndTime;
    private string? jwt;

    private CoachingSession.SessionDto? _deleteCandidate;
    private bool _isDeleting = false;
    private string? _deleteError;

    protected override async Task OnInitializedAsync()
    {
        jwt = await TokenService.GetTokenAsync();
        await LoadSessions();
    }

    private void CloseDetails()
    {
        _selectedSession = null;
    }

    private async Task LoadSessions()
    {
        _isLoading = true;
        _pageError = null;

        try
        {
            var coachId = await TokenService.GetUserIdAsync();
            if (string.IsNullOrEmpty(coachId))
                return;

        var response = await CoachingService.GetAllSessionsByCoachIdAsync(coachId, jwt ?? "");
        response.EnsureSuccessStatusCode();

            var sessions =
                await response.Content.ReadFromJsonAsync<List<CoachingSession.SessionDto>>()
                ?? new();

            _available = sessions
                .Where(s => s.CurrentStatus == CoachingSession.Status.Available)
                .OrderBy(s => s.StartTime)
                .ToList();

            _planned = sessions
                .Where(s => s.CurrentStatus == CoachingSession.Status.Planned)
                .OrderBy(s => s.StartTime)
                .ToList();

            _users.Clear();

            var userIds = _planned
                .Where(s => !string.IsNullOrEmpty(s.UserId))
                .Select(s => s.UserId!)
                .Distinct();

            foreach (var id in userIds)
            {
                var userResponse = await UserService.GetUserByIdAsync(id);
                if (userResponse.IsSuccessStatusCode)
                {
                    var user = await userResponse.Content.ReadFromJsonAsync<UserDto>();
                    if (user != null)
                        _users[id] = user;
                }
            }
        }
        catch (Exception ex)
        {
            _pageError = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenCreateSession()
    {
        _newStartTime = DateTime.Now;
        _newEndTime = DateTime.Now.AddHours(1);
        _showCreateModal = true;
    }

    private void CloseCreateSession()
    {
        _showCreateModal = false;
    }

    private async Task CreateSession()
    {
        var coachId = await TokenService.GetUserIdAsync();
        if (string.IsNullOrEmpty(coachId))
            return;

        var payload = new
        {
            coachId = coachId,
            startTime = _newStartTime.ToUniversalTime(),
            endTime = _newEndTime.ToUniversalTime()
        };

        var response = await CoachingService.CreateSessionAsCoachAsync(payload, jwt ?? "");
        response.EnsureSuccessStatusCode();

        _showCreateModal = false;
        await LoadSessions();
    }

    private void ShowDetails(CoachingSession.SessionDto session)
    {
        _selectedSession = session;

        if (!string.IsNullOrEmpty(session.UserId) &&
            _users.TryGetValue(session.UserId, out var user))
        {
            _selectedCustomerName = !string.IsNullOrWhiteSpace(user.FirstName)
                ? user.FirstName
                : (!string.IsNullOrWhiteSpace(user.Username) ? user.Username : "Ukendt kunde");
        }
        else
        {
            _selectedCustomerName = "Ukendt kunde";
        }
    }

    private string FormatDate(DateTime dt) => dt.ToLocalTime().ToString("dd/MM");
    private string FormatTime(DateTime dt) => dt.ToLocalTime().ToString("HH:mm");

    private string GetCustomerName(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return "Ukendt kunde";
        if (_users.TryGetValue(userId, out var user))
        {
            if (!string.IsNullOrWhiteSpace(user.FirstName)) return user.FirstName;
            if (!string.IsNullOrWhiteSpace(user.Username)) return user.Username;
        }
        return "Ukendt kunde";
    }

    private static string ExperienceText(CoachingSession.Experience? exp)
    {
        if (!exp.HasValue) return "-";

        return exp.Value switch
        {
            CoachingSession.Experience.Begynder => "Begynder",
            CoachingSession.Experience.√òvet => "√òvet",
            CoachingSession.Experience.Ekspert => "Erfaren",
            _ => exp.Value.ToString()
        };
    }

    private string GetCustomerInitial(string? userId)
    {
        var name = GetCustomerName(userId);
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }

    private void AskDelete(CoachingSession.SessionDto session)
    {
        _deleteError = null;
        _isDeleting = false;
        _deleteCandidate = session;
    }

    private void CancelDelete()
    {
        _deleteCandidate = null;
        _deleteError = null;
        _isDeleting = false;
    }

    private async Task ConfirmDelete()
    {
        if (_deleteCandidate is null) return;

        _deleteError = null;
        _isDeleting = true;

        try
        {
            if (string.IsNullOrWhiteSpace(_deleteCandidate.Id))
            {
                _deleteError = "Session id mangler";
                return;
            }

            var res = await CoachingService.DeleteSessionAsCoachAsync(_deleteCandidate.Id, jwt ?? "");
            if (!res.IsSuccessStatusCode)
            {
                _deleteError = $"Kunne ikke slette: {(int)res.StatusCode} {res.ReasonPhrase}";
                return;
            }

            CancelDelete();
            await LoadSessions();
        }
        catch (Exception ex)
        {
            _deleteError = ex.Message;
        }
        finally
        {
            _isDeleting = false;
        }
    }

    RenderFragment SessionCard(CoachingSession.SessionDto session, bool showCustomer) => @<article class="session-card">
        <div class="session-left">
            <div class="session-date">@FormatDate(session.StartTime)</div>
            <div class="session-time">@FormatTime(session.StartTime) - @FormatTime(session.EndTime)</div>
        </div>

        @if (showCustomer)
        {
            <div class="session-mid">
                <div class="customer-chip">
                    <div class="customer-ava">@GetCustomerInitial(session.UserId)</div>
                    <div class="customer-name">@GetCustomerName(session.UserId)</div>
                </div>
            </div>

            <div class="session-actions">
                <button class="small-btn" type="button" @onclick="() => ShowDetails(session)">Se detaljer</button>
            </div>
        }
        else
        {
            <div class="session-mid">
                <div class="session-tag">Bookbar</div>
            </div>

            <div class="session-actions">
                <button class="small-btn danger" type="button" @onclick="() => AskDelete(session)">
                    Slet
                </button>
            </div>
        }
    </article>;
}
