@page "/trainer/session/book/{SessionId}"

@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services

@inject CoachingService CoachingService
@inject TokenService TokenService
@inject UserService UserService
@inject NavigationManager Nav

@layout PhoneLayout

<div class="session-booking">
    <div class="page-scroll">
        <section class="hero">
            <div class="hero-top">
                <button class="ghost-icon" type="button" @onclick="GoBack" aria-label="Tilbage">
                    <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                </button>

                <div class="hero-text">
                    <h2 class="title">Bekr√¶ft booking</h2>
                    <p class="sub">Gennemg√• tiden og udfyld bookingoplysninger</p>
                </div>
            </div>
        </section>

        <div class="body">
            @if (_isLoading)
            {
                <div class="card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Indl√¶ser session...</p>
                    </div>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(_error))
            {
                <div class="card">
                    <div class="empty">
                        <div class="empty-ico">‚ö†Ô∏è</div>
                        <div class="empty-title">Noget gik galt</div>
                        <div class="empty-sub">@_error</div>

                        <div class="btn-row" style="margin-top:14px;">
                            <button class="ghost-btn" type="button" @onclick="GoBack">Tilbage</button>
                            <button class="primary-btn" type="button" @onclick="Reload">Pr√∏v igen</button>
                        </div>
                    </div>
                </div>
            }
            else if (_session is null)
            {
                <div class="card">
                    <div class="empty">
                        <div class="empty-ico">üì≠</div>
                        <div class="empty-title">Session ikke fundet</div>
                        <div class="empty-sub">Den valgte session findes ikke l√¶ngere.</div>

                        <button class="ghost-btn" type="button" style="margin-top:14px;" @onclick="GoBack">
                            Tilbage
                        </button>
                    </div>
                </div>
            }
            else
            {
                <section class="card">
                    <div class="section-head">
                        <div class="section-title">
                            <span class="dot green"></span>
                            <span class="section-title-text">Session</span>
                        </div>
                        <div class="section-sub">Tjek tid og udfyld formularen.</div>
                    </div>

                    <div class="session-summary">
                        <div class="summary-left">
                            <div class="summary-date">@FormatDate(_session.StartTime)</div>
                            <div class="summary-time">@FormatTime(_session.StartTime) - @FormatTime(_session.EndTime)</div>
                        </div>
                        <div class="summary-right">
                            <div class="chip">
                                <span class="chip-dot"></span>
                                <span class="chip-text">@_coachDisplayName</span>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_confirmation))
                    {
                        <div class="confirm">@_confirmation</div>
                    }

                    <div class="field">
                        <label class="field-label" for="goals">M√•l</label>
                        <label class="input-shell shell-click" for="goals">
                            <input id="goals"
                                   class="field-input"
                                   @bind="_booking.Goals"
                                   autocomplete="off"
                                   placeholder="Fx v√¶gttab, muskelopbygning, teknik"
                                   disabled="@_isSubmitting" />
                        </label>
                    </div>

                    <div class="field">
                        <label class="field-label" for="notes">Noter</label>
                        <label class="input-shell textarea-shell shell-click" for="notes">
                            <textarea id="notes"
                                      class="field-input textarea"
                                      @bind="_booking.Notes"
                                      placeholder="Skriv evt. skader, √∏nsker, fokusomr√•der"
                                      disabled="@_isSubmitting"></textarea>
                        </label>
                    </div>

                    <div class="field">
                        <label class="field-label" for="exp">Erfaring</label>
                        <label class="input-shell shell-click" for="exp">
                            <select id="exp"
                                    class="field-input"
                                    @bind="_booking.Experience"
                                    disabled="@_isSubmitting">
                                <option value="@CoachingSession.Experience.Begynder">Begynder</option>
                                <option value="@CoachingSession.Experience.√òvet">√òvet</option>
                                <option value="@CoachingSession.Experience.Ekspert">Ekspert</option>
                            </select>
                        </label>
                    </div>

                    <button class="primary-btn full"
                            type="button"
                            @onclick="ConfirmBooking"
                            disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span>Bekr√¶fter...</span>
                        }
                        else
                        {
                            <span>Bekr√¶ft booking</span>
                        }
                    </button>
                </section>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string SessionId { get; set; } = "";

    private CoachingSession.SessionDto? _session;
    private bool _isLoading = true;
    private bool _isSubmitting = false;

    private string? _error;
    private string _confirmation = "";

    private UserDto? _coachUser;
    private string _coachDisplayName = "Tr√¶ner";
    private string? jwt;

    private CoachingSession.BookingForm _booking = new()
    {
        CreatedAt = DateTime.UtcNow,
        Goals = "",
        Notes = "",
        Experience = CoachingSession.Experience.Begynder
    };

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _error = null;
        _confirmation = "";

        try
        {
            var response = await CoachingService.GetSessionByIdAsync(SessionId, jwt ?? "");
            if (!response.IsSuccessStatusCode)
            {
                _session = null;
                _error = $"Kunne ikke hente session ({(int)response.StatusCode})";
                return;
            }

            _session = await response.Content.ReadFromJsonAsync<CoachingSession.SessionDto>();

            if (_session?.CoachId is not null)
                await LoadCoachAsync(_session.CoachId);
            else
                _coachDisplayName = "Tr√¶ner";
        }
        catch (Exception ex)
        {
            _session = null;
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadCoachAsync(string coachId)
    {
        try
        {
            var res = await UserService.GetUserByIdAsync(coachId);
            if (res.IsSuccessStatusCode)
                _coachUser = await res.Content.ReadFromJsonAsync<UserDto>();
            else
                _coachUser = null;
        }
        catch
        {
            _coachUser = null;
        }

        _coachDisplayName = GetDisplayName(_coachUser, coachId);
    }

    private async Task Reload() => await LoadAsync();

    private void GoBack() => Nav.NavigateTo("/trainer/book");

    private async Task ConfirmBooking()
    {
        if (_session is null || _isSubmitting)
            return;

        _isSubmitting = true;
        _error = null;
        _confirmation = "";

        try
        {
            var userId = await TokenService.GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                _error = "Du er ikke logget ind.";
                return;
            }

            _session.UserId = userId;
            _session.BookingForm = _booking;
            _session.BookingForm.CreatedAt = DateTime.UtcNow;

            var response = await CoachingService.BookSessionAsync(_session, jwt ?? "");
            if (!response.IsSuccessStatusCode)
            {
                _error = $"Kunne ikke booke ({(int)response.StatusCode})";
                return;
            }

            _confirmation = "Booking bekr√¶ftet";
            await Task.Delay(800);
            Nav.NavigateTo("/dashboard", forceLoad: false);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private string FormatDate(DateTime dt) => dt.ToLocalTime().ToString("dd/MM");
    private string FormatTime(DateTime dt) => dt.ToLocalTime().ToString("HH:mm");

    private static string GetDisplayName(UserDto? user, string? fallbackId)
    {
        if (user != null)
        {
            if (!string.IsNullOrWhiteSpace(user.FirstName))
                return user.FirstName.Trim();

            if (!string.IsNullOrWhiteSpace(user.Username))
                return user.Username.Trim();
        }

        if (!string.IsNullOrWhiteSpace(fallbackId))
            return $"Tr√¶ner {fallbackId[..Math.Min(6, fallbackId.Length)]}";

        return "Tr√¶ner";
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }
}
