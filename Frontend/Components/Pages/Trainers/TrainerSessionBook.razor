@page "/trainer/session/book/{SessionId}"
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using Microsoft.AspNetCore.Components.Forms
@inject CoachingService CoachingService
@inject TokenService TokenService
@inject NavigationManager Nav
@layout PhoneLayout

<div class="booking-screen"
     style="padding:24px; max-width:520px; margin:0 auto;">

    <h2 style="font-size:24px; font-weight:700; margin-bottom:6px;">
        Bekr√¶ft booking
    </h2>
    <p style="color:#6b7280; margin-bottom:24px;">
        Gennemg√• tiden og udfyld bookingoplysninger
    </p>

    @if (_isLoading)
    {
        <p>Indl√¶ser session...</p>
    }
    else if (_session is null)
    {
        <p>Session ikke fundet.</p>
    }
    else
    {
        <!-- SESSION CARD -->
        <div style="
            background:white;
            border-radius:16px;
            padding:16px;
            margin-bottom:24px;
            box-shadow:0 8px 24px rgba(0,0,0,0.08);">

            <p style="margin:0; font-weight:600;">
                @_session.StartTime.ToLocalTime().ToString("dd/MM")
            </p>
            <p style="margin:6px 0 0 0; color:#6b7280;">
                @_session.StartTime.ToLocalTime().ToString("HH:mm")
                ‚Äì
                @_session.EndTime.ToLocalTime().ToString("HH:mm")
            </p>
            <p style="margin:10px 0 0 0; font-size:14px;">
                <strong>Tr√¶ner:</strong> @_session.CoachId
            </p>
        </div>

        <!-- BOOKING FORM -->
        <EditForm Model="_booking" OnValidSubmit="ConfirmBooking">
            <div style="margin-bottom:16px;">
                <label style="font-weight:600;">M√•l</label>
                <InputText @bind-Value="_booking.Goals"
                           style="width:100%; padding:10px;
                           border-radius:10px; border:1px solid #e5e7eb;" />
            </div>

            <div style="margin-bottom:16px;">
                <label style="font-weight:600;">Noter</label>
                <InputTextArea @bind-Value="_booking.Notes"
                               style="width:100%; padding:10px;
                               border-radius:10px; border:1px solid #e5e7eb;
                               min-height:80px;" />
            </div>

            <div style="margin-bottom:24px;">
                <label style="font-weight:600;">Erfaring</label>
                <InputSelect @bind-Value="_booking.Experience"
                             style="width:100%; padding:10px;
                             border-radius:10px; border:1px solid #e5e7eb;">
                    <option value="Begynder">Begynder</option>
                    <option value="√òvet">√òvet</option>
                    <option value="Ekspert">Ekspert</option>
                </InputSelect>
            </div>

            <button type="submit"
                    style="
                        width:100%;
                        background:#22c55e;
                        color:white;
                        border:none;
                        padding:14px;
                        border-radius:999px;
                        font-weight:600;
                        font-size:15px;
                        cursor:pointer;">
                Bekr√¶ft booking
            </button>
        </EditForm>

        @if (!string.IsNullOrEmpty(_confirmation))
        {
            <p style="margin-top:16px; color:#16a34a; font-weight:600;">
                @_confirmation
            </p>
        }
    }
</div>

@code {
    [Parameter] public string SessionId { get; set; } = "";

    private CoachingSession.SessionDto? _session;
    private bool _isLoading = true;
    private string _confirmation = "";

    private CoachingSession.BookingForm _booking = new()
    {
        CreatedAt = DateTime.UtcNow,
        Goals = "",
        Notes = "",
        Experience = CoachingSession.Experience.Begynder
    };

    protected override async Task OnInitializedAsync()
    {
        var response = await CoachingService.GetSessionByIdAsync(SessionId);
        response.EnsureSuccessStatusCode();

        _session = await response.Content.ReadFromJsonAsync<CoachingSession.SessionDto>();

        _isLoading = false;
    }

    private async Task ConfirmBooking()
    {
        if (_session is null)
            return;

        var userId = await TokenService.GetUserIdAsync();
        _session.UserId = userId;

        _session.BookingForm = _booking;

        var response = await CoachingService.BookSessionAsync(_session);
        response.EnsureSuccessStatusCode();

        _confirmation = "Booking bekr√¶ftet üéâ";
    }
}
