@page "/trainer/book"
@using Microsoft.AspNetCore.Components
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Services
@using FitLifeFitness.Models
@using System.Net.Http.Json
@using System.Collections.Generic
@using System.Linq
@layout PhoneLayout

@inject CoachingService CoachingService
@inject TokenService TokenService
@inject UserService UserService
@inject NavigationManager Nav

<div class="choose-trainer">
    <div class="choose-trainer-scroll">
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">Find din perfekte tr√¶ner</h1>
                <p class="hero-subtitle">V√¶lg en certificeret tr√¶ner der matcher dine m√•l og ambitioner</p>
            </div>

            <div class="stats-row">
                <div class="stat-pill">
                    <span class="stat-emoji">üèÜ</span>
                    <span class="stat-text">+500 sessioner</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-emoji">‚≠ê</span>
                    <span class="stat-text">4.9 rating</span>
                </div>
            </div>
        </section>

        <div class="choose-trainer-body">
            @if (_isLoading)
            {
                <div class="state-card">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Henter dine tr√¶nere...</p>
                    </div>
                </div>
            }
            else if (_errorOccurred)
            {
                <div class="state-card">
                    <div class="error-state">
                        <span class="error-emoji">‚ö†Ô∏è</span>
                        <p class="error-title">Noget gik galt</p>
                        <p class="error-message">Kunne ikke hente tr√¶nere. Pr√∏v igen.</p>

                        <button class="ghost-btn" type="button" @onclick="Reload">
                            Pr√∏v igen
                        </button>
                    </div>
                </div>
            }
            else if (!Coaches.Any())
            {
                <div class="state-card">
                    <div class="empty-state">
                        <span class="empty-emoji">üïê</span>
                        <p class="empty-title">Ingen tr√¶nere</p>
                        <p class="empty-message">Der er ingen tr√¶nere lige nu.</p>
                    </div>
                </div>
            }
            else
            {
                <section class="trainers-section">
                    <div class="section-header">
                        <h2 class="section-title">Vores tr√¶nere</h2>
                        <span class="trainer-count">@Coaches.Count tilg√¶ngelige</span>
                    </div>

                    <div class="trainer-grid">
                        @foreach (var coach in Coaches)
                        {
                            <article class="trainer-card">
                                <div class="trainer-card-inner">
                                    <div class="trainer-header">
                                        <div class="trainer-avatar-wrapper">
                                            <div class="trainer-avatar">
                                                <span class="avatar-text">@coach.Initial</span>
                                            </div>

                                            @if (coach.HasAvailability)
                                            {
                                                <div class="status-badge">
                                                    <span class="status-dot"></span>
                                                    <span class="status-text">Ledig</span>
                                                </div>
                                            }
                                        </div>

                                        <div class="trainer-info">
                                            <h3 class="trainer-name">@coach.DisplayName</h3>
                                            <p class="trainer-specialty">@coach.Description</p>

                                            <div class="trainer-meta">
                                                <span class="meta-item">
                                                    <svg viewBox="0 0 24 24" class="meta-icon">
                                                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                        <path d="M2 17l10 5 10-5"></path>
                                                        <path d="M2 12l10 5 10-5"></path>
                                                    </svg>
                                                    Certificeret
                                                </span>
                                                <span class="meta-item">
                                                    <svg viewBox="0 0 24 24" class="meta-icon">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                    60 min
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="select-trainer-btn"
                                            type="button"
                                            @onclick="() => GoToBookingForm(coach.Id)">
                                        <span class="btn-text">V√¶lg tr√¶ner</span>
                                        <svg viewBox="0 0 24 24" class="btn-arrow">
                                            <path d="M5 12h14"></path>
                                            <path d="M12 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </article>
                        }
                    </div>
                </section>
            }
        </div>
    </div>
</div>

@code
{
    private bool _isLoading = true;
    private bool _errorOccurred = false;
    private string? LoggedInUserId;

    private List<CoachModel> Coaches { get; set; } = new();
    private Dictionary<string, UserDto> UsersById { get; set; } = new(StringComparer.OrdinalIgnoreCase);

    private class CoachModel
    {
        public string Id { get; set; } = "";
        public string Description { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public string Initial { get; set; } = "?";

        public int AvailableCount { get; set; } = 0;
        public bool HasAvailability => AvailableCount > 0;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task Reload()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _errorOccurred = false;

        try
        {
            LoggedInUserId = await TokenService.GetUserIdAsync();

            await LoadUsersAsync();

            var res = await CoachingService.GetAvailableSessionsAsync();
            res.EnsureSuccessStatusCode();

            var sessions = await res.Content.ReadFromJsonAsync<IEnumerable<CoachingSession.SessionDto>>()
                           ?? Enumerable.Empty<CoachingSession.SessionDto>();

            var coachIds = sessions
                .Where(s => !string.IsNullOrWhiteSpace(s.CoachId))
                .Select(s => s.CoachId!)
                .Distinct()
                .ToList();

            var coachModels = new List<CoachModel>();

            foreach (var coachId in coachIds)
            {
                var displayName = GetDisplayNameFromId(coachId);
                var availableCount = await GetAvailableCountForCoachAsync(coachId);

                var first = sessions.First(s => s.CoachId == coachId);

                coachModels.Add(new CoachModel
                {
                    Id = coachId,
                    Description = first.DescriptionForCoach ?? "Generel tr√¶ning",
                    DisplayName = displayName,
                    Initial = GetInitial(displayName),
                    AvailableCount = availableCount
                });
            }

            Coaches = coachModels
                .OrderByDescending(c => c.HasAvailability)
                .ThenBy(c => c.DisplayName)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            _errorOccurred = true;
            Coaches = new();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<int> GetAvailableCountForCoachAsync(string coachId)
    {
        try
        {
            var res = await CoachingService.GetAvailableSessionsForCoachIdAsync(coachId);
            if (!res.IsSuccessStatusCode) return 0;

            var list = await res.Content.ReadFromJsonAsync<List<CoachingSession.SessionDto>>();
            if (list == null || list.Count == 0) return 0;

            var nowLocal = DateTime.Now;

            return list.Count(s =>
                s.StartTime.ToLocalTime() >= nowLocal.AddMinutes(-1)
            );
        }
        catch
        {
            return 0;
        }
    }

    private async Task LoadUsersAsync()
    {
        var res = await UserService.GetAllUsersAsync();
        if (!res.IsSuccessStatusCode)
        {
            UsersById.Clear();
            return;
        }

        var users = await res.Content.ReadFromJsonAsync<List<UserDto>>() ?? new();

        UsersById = users
            .Where(u => !string.IsNullOrWhiteSpace(u.Id))
            .GroupBy(u => u.Id!, StringComparer.OrdinalIgnoreCase)
            .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);
    }

    private string GetDisplayNameFromId(string? userId)
    {
        if (string.IsNullOrWhiteSpace(userId)) return "Bruger";

        if (UsersById.TryGetValue(userId, out var u))
        {
            if (!string.IsNullOrWhiteSpace(u.FirstName))
                return u.FirstName.Trim();

            if (!string.IsNullOrWhiteSpace(u.Username))
                return u.Username.Trim();
        }

        return $"Bruger {userId[..Math.Min(6, userId.Length)]}";
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }

    private void GoToBookingForm(string coachId)
    {
        Nav.NavigateTo($"/trainer/session/select/{coachId}");
    }
}
