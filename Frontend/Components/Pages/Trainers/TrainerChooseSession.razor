@page "/trainer/session/select/{CoachId}"

@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Services
@using FitLifeFitness.Models
@inject CoachingService CoachingService
@inject NavigationManager Nav
@layout PhoneLayout

<div class="booking-screen">
    <h2 class="booking-title">Vælg en ledig tid</h2>
    <p class="booking-subtitle">Vælg en session hos den valgte træner</p>

    @if (_isLoading)
    {
        <p>Indlæser ledige tider...</p>
    }
    else if (!_sessions.Any())
    {
        <p>Der er ingen ledige tider for denne træner.</p>
    }
    else
    {
        <div class="session-list">
            @foreach (var session in _sessions)
            {
                <div style="
                    background:white;
                    border-radius:14px;
                    padding:14px;
                    margin-bottom:12px;
                    box-shadow:0 4px 12px rgba(0,0,0,0.08);">

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <p style="margin:0; font-weight:600;">
                                @session.StartTime.ToLocalTime().ToString("dd/MM")
                            </p>
                            <p style="margin:4px 0 0 0; color:#6b7280;">
                                @session.StartTime.ToLocalTime().ToString("HH:mm")
                                –
                                @session.EndTime.ToLocalTime().ToString("HH:mm")
                            </p>
                        </div>

                        <button type="button"
                                style="
                                    background:#22c55e;
                                    color:white;
                                    border:none;
                                    padding:8px 16px;
                                    border-radius:999px;
                                    cursor:pointer;"
                                @onclick="() => GoToBooking(session.Id!)">
                            Book
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string CoachId { get; set; } = "";

    private List<CoachingSession.SessionDto> _sessions = new();
    private bool _isLoading = true;
    private string? Jwt { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;

        var response =
            await CoachingService.GetAvailableSessionsForCoachIdAsync(CoachId, Jwt ?? "");

        response.EnsureSuccessStatusCode();

        _sessions =
            await response.Content.ReadFromJsonAsync<List<CoachingSession.SessionDto>>()
            ?? new();

        _isLoading = false;
    }

    private void GoToBooking(string sessionId)
    {
        Nav.NavigateTo($"/trainer/session/book/{sessionId}");
    }
}
