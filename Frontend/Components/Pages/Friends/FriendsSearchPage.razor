@page "/friends/search"
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using Frontend.Models
@layout PhoneLayout
@inject TokenService TokenService
@inject SocialService SocialService
@inject UserService UserService

<section class="search-page">
    <header class="search-hero">
        <h2 class="title">Søg venner</h2>
        <p class="sub">Find venner, følg hinanden og træn sammen</p>
    </header>

    <div class="search-box" role="search">
        <span class="search-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
                <circle cx="11" cy="11" r="6"></circle>
                <path d="M20 20l-3.5-3.5"></path>
            </svg>
        </span>

        <input class="search-input"
               type="search"
               placeholder="Søg på navn eller brugernavn"
               aria-label="Søg efter venner" />
    </div>

    <div class="chips" aria-label="Filtre">
        <button class="chip chip-active" type="button">Alle</button>
    </div>

    <section class="section">
        <div class="section-head">
            <div class="section-title">Alle profiler</div>
        </div>

        <div class="list">
            @if (!string.IsNullOrWhiteSpace(feedError))
            {
                <article class="row">
                    <div class="meta">
                        <div class="name">Fejl</div>
                        <div class="desc">@feedError</div>
                    </div>
                </article>
            }

            @if (isLoading)
            {
                <article class="row">
                    <div class="meta">
                        <div class="name">Loader...</div>
                        <div class="desc">Henter profiler og relationer</div>
                    </div>
                </article>
            }
            else
            {
                @foreach (var item in VisibleUsers)
                {
                    <article class="row">
                        <div class="ava">@GetInitial(GetDisplayName(item))</div>
                        <div class="meta">
                            <div class="name">@GetDisplayName(item)</div>
                            <div class="desc">@item.Username</div>
                        </div>

                        @if (IsOutgoingPending(item.Id))
                        {
                            var isHover = hoveredCancelUserId == item.Id;

                            <button class="btn @(isHover ? "danger" : "ghost")"
                                    type="button"
                                    @onmouseenter="() => hoveredCancelUserId = item.Id"
                                    @onmouseleave="() => hoveredCancelUserId = null"
                                    @onclick="() => OnPendingButtonClick(item)">
                                @(isHover ? "Fortryd" : "Afventer")
                            </button>
                        }

                        else if (IsIncomingPending(item.Id))
                        {
                            <div style="display:flex; gap:8px;">
                                <button class="btn primary" type="button" @onclick="() => AcceptFriendRequest(item)">Accepter</button>
                                <button class="btn ghost" type="button" @onclick="() => DeclineFriendRequest(item)">Afvis</button>
                            </div>
                        }
                        else
                        {
                            <button class="btn primary" type="button" @onclick="() => SendFriendRequest(item)">Tilføj</button>
                        }
                    </article>
                }
            }
            
        </div>
    </section>
</section>

@code
{
    private string? LoggedInUserId { get; set; }
    private string? Username { get; set; }
    
    private string? hoveredCancelUserId;
    private bool hoveredSeedCancel;

    private string UserInitial => GetInitial(Username);

    private List<UserDto> userList = new();

    private HashSet<string> acceptedFriendIds = new();
    private HashSet<string> outgoingPendingIds = new();
    private HashSet<string> incomingPendingIds = new();

    private bool isLoading = true;
    private string? feedError;

    private IEnumerable<UserDto> VisibleUsers =>
        userList
            .Where(u => !string.IsNullOrWhiteSpace(u.Id))
            .Where(u => u.Id != LoggedInUserId)
            .Where(u => !acceptedFriendIds.Contains(u.Id));

    protected override async Task OnInitializedAsync()
    {
        LoggedInUserId = await TokenService.GetUserIdAsync();
        Username = await TokenService.GetUsernameAsync();

        await LoadPageAsync();
    }
    
    private async Task OnPendingButtonClick(UserDto userDto)
    {
        if (hoveredCancelUserId != userDto.Id) return;

        await CancelFriendRequest(userDto);

        hoveredCancelUserId = null;
    }

    private async Task LoadPageAsync()
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId))
        {
            feedError = "Mangler LoggedInUserId";
            return;
        }

        isLoading = true;

        try
        {
            var usersRes = await UserService.GetAllUsersAsync();
            userList = await usersRes.Content.ReadFromJsonAsync<List<UserDto>>() ?? new List<UserDto>();

            await LoadRelationshipSetsAsync(LoggedInUserId);
        }
        catch (Exception ex)
        {
            feedError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadRelationshipSetsAsync(string userId)
    {
        acceptedFriendIds.Clear();
        outgoingPendingIds.Clear();
        incomingPendingIds.Clear();

        var friendsRes = await SocialService.GetAllFriendsAsync(userId);
        var outgoingRes = await SocialService.GetOutgoingFriendRequestsAsync(userId);
        var incomingRes = await SocialService.GetIncomingFriendRequestsAsync(userId);

        if (friendsRes.IsSuccessStatusCode)
        {
            var friends = await friendsRes.Content.ReadFromJsonAsync<List<Friendship>>() ?? new List<Friendship>();
            foreach (var f in friends)
            {
                var otherId = GetOtherId(f, userId);
                if (!string.IsNullOrWhiteSpace(otherId))
                    acceptedFriendIds.Add(otherId);
            }
        }

        if (outgoingRes.IsSuccessStatusCode)
        {
            var outgoing = await outgoingRes.Content.ReadFromJsonAsync<List<Friendship>>() ?? new List<Friendship>();
            foreach (var f in outgoing.Where(x => x.FriendShipStatus == Friendship.FriendshipStatus.Pending))
            {
                var otherId = GetOtherId(f, userId);
                if (!string.IsNullOrWhiteSpace(otherId))
                    outgoingPendingIds.Add(otherId);
            }
        }

        if (incomingRes.IsSuccessStatusCode)
        {
            var incoming = await incomingRes.Content.ReadFromJsonAsync<List<Friendship>>() ?? new List<Friendship>();
            foreach (var f in incoming.Where(x => x.FriendShipStatus == Friendship.FriendshipStatus.Pending))
            {
                var otherId = GetOtherId(f, userId);
                if (!string.IsNullOrWhiteSpace(otherId))
                    incomingPendingIds.Add(otherId);
            }
        }
    }

    private async Task SendFriendRequest(UserDto userDto)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(userDto.Id))
            return;

        var res = await SocialService.SendFriendRequestAsync(LoggedInUserId, userDto.Id);

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke sende anmodning: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private async Task CancelFriendRequest(UserDto userDto)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(userDto.Id))
            return;

        var res = await SocialService.CancelFriendRequestAsync(LoggedInUserId, userDto.Id);

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke fortryde: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private async Task AcceptFriendRequest(UserDto userDto)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(userDto.Id))
            return;

        var res = await SocialService.AcceptFriendRequestAsync(userDto.Id, LoggedInUserId);

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke acceptere: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private async Task DeclineFriendRequest(UserDto userDto)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId) || string.IsNullOrWhiteSpace(userDto.Id))
            return;

        var res = await SocialService.DeclineFriendRequestAsync(LoggedInUserId, userDto.Id);

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke afvise: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private bool IsOutgoingPending(string? otherUserId)
        => !string.IsNullOrWhiteSpace(otherUserId) && outgoingPendingIds.Contains(otherUserId);

    private bool IsIncomingPending(string? otherUserId)
        => !string.IsNullOrWhiteSpace(otherUserId) && incomingPendingIds.Contains(otherUserId);

    private static string? GetOtherId(Friendship f, string userId)
    {
        if (f.SenderId == userId) return f.ReceiverId;
        if (f.ReceiverId == userId) return f.SenderId;
        return null;
    }

    private static string GetDisplayName(UserDto userDto)
    {
        if (!string.IsNullOrWhiteSpace(userDto.FirstName))
            return userDto.FirstName.Trim();

        if (!string.IsNullOrWhiteSpace(userDto.Id))
            return $"Bruger {userDto.Id[..Math.Min(6, userDto.Id.Length)]}";

        return "Bruger";
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }
}
