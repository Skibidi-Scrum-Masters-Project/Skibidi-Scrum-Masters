@page "/notifications"
@using System.Net.Http.Json
@using FitLifeFitness.Components.Layout
@using FitLifeFitness.Models
@using FitLifeFitness.Services
@using Frontend.Models
@layout PhoneLayout
@inject TokenService TokenService
@inject SocialService SocialService
@inject UserService UserService

<section class="noti-page">
    <header class="noti-hero">
        <h2 class="title">Notifikationer</h2>
        <p class="sub">Venneanmodninger og aktivitet</p>
    </header>

    <section class="panel">
        <div class="panel-head">
            <div class="panel-title">Venneanmodninger</div>
            <div class="badge">@PendingList.Count</div>
        </div>

        <div class="list">
            @if (!string.IsNullOrWhiteSpace(feedError))
            {
                <article class="row">
                    <div class="meta">
                        <div class="name">Fejl</div>
                        <div class="desc">@feedError</div>
                    </div>
                </article>
            }

            @if (isLoading)
            {
                <article class="row">
                    <div class="meta">
                        <div class="name">Loader...</div>
                        <div class="desc">Henter venneanmodninger</div>
                    </div>
                </article>
            }
            else
            {
                @if (PendingList.Count == 0)
                {
                    <article class="row">
                        <div class="meta">
                            <div class="name">Ingen anmodninger</div>
                            <div class="desc">Der er ingen nye venneanmodninger lige nu</div>
                        </div>
                    </article>
                }
                else
                {
                    @foreach (var item in PendingList)
                    {
                        var senderId = item.SenderId;
                        var displayName = GetSenderDisplayName(senderId);
                        var initial = GetInitial(displayName);

                        <article class="row">
                            <div class="ava">@initial</div>
                            <div class="meta">
                                <div class="name">@displayName</div>
                                <div class="desc">Sendte en venneanmodning</div>
                            </div>
                            <div class="actions">
                                <button class="btn primary" type="button" @onclick="() => AcceptFriendRequest(item)">Accepter</button>
                                <button class="btn ghost" type="button" @onclick="() => DeclineFriendRequest(item)">Afvis</button>
                            </div>
                        </article>
                    }
                }
            }
        </div>
    </section>

    <section class="panel">
        <div class="panel-head">
            <div class="panel-title">Aktivitet</div>
            <button class="panel-action" type="button">Marker som læst</button>
        </div>

        <div class="list">
            <article class="event">
                <div class="dot"></div>
                <div class="event-body">
                    <div class="event-title">Sofie Jensen gav dig et like</div>
                    <div class="event-sub">Dit opslag fra i går</div>
                </div>
                <div class="time">2m</div>
            </article>

            <article class="event">
                <div class="dot"></div>
                <div class="event-body">
                    <div class="event-title">Mathilde Nielsen kommenterede</div>
                    <div class="event-sub">Stærk træning</div>
                </div>
                <div class="time">1t</div>
            </article>

            <article class="event">
                <div class="dot muted"></div>
                <div class="event-body">
                    <div class="event-title">Du har en ny uge streak</div>
                    <div class="event-sub">Fortsæt sådan</div>
                </div>
                <div class="time">i går</div>
            </article>
        </div>
    </section>
</section>

@code
{
    private List<Friendship> PendingList = new();

    private string? LoggedInUserId;
    private string? Username;

    private string? feedError;
    private bool isLoading = true;
    private string? jwt = string.Empty;

    private Dictionary<string, UserDto> usersById = new();

    protected override async Task OnInitializedAsync()
    {
        LoggedInUserId = await TokenService.GetUserIdAsync();
        Username = await TokenService.GetUsernameAsync();
        jwt = await TokenService.GetTokenAsync();

        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId))
        {
            feedError = "Mangler LoggedInUserId";
            return;
        }

        isLoading = true;

        try
        {
            var incomingRes = await SocialService.GetIncomingFriendRequestsAsync(LoggedInUserId, jwt ?? "");
            var incoming = await incomingRes.Content.ReadFromJsonAsync<List<Friendship>>() ?? new List<Friendship>();

            PendingList = incoming
                .OrderByDescending(f => f.FriendshipId)
                .ToList();

            var usersRes = await UserService.GetAllUsersAsync();
            var users = await usersRes.Content.ReadFromJsonAsync<List<UserDto>>() ?? new List<UserDto>();

            usersById = users
                .Where(u => !string.IsNullOrWhiteSpace(u.Id))
                .GroupBy(u => u.Id!)
                .ToDictionary(g => g.Key, g => g.First());
        }
        catch (Exception ex)
        {
            feedError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AcceptFriendRequest(Friendship friendship)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId))
            return;

        if (string.IsNullOrWhiteSpace(friendship.SenderId))
            return;

        var senderId = friendship.SenderId;

        var res = await SocialService.AcceptFriendRequestAsync(senderId, LoggedInUserId, jwt ?? "");

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke acceptere anmodning: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private async Task DeclineFriendRequest(Friendship friendship)
    {
        feedError = null;

        if (string.IsNullOrWhiteSpace(LoggedInUserId))
            return;

        if (string.IsNullOrWhiteSpace(friendship.SenderId))
            return;

        var senderId = friendship.SenderId;

        var res = await SocialService.DeclineFriendRequestAsync(LoggedInUserId, senderId, jwt ?? "");

        if (!res.IsSuccessStatusCode)
        {
            feedError = $"Kunne ikke afvise anmodning: {(int)res.StatusCode} {res.ReasonPhrase}";
            return;
        }

        await LoadPageAsync();
    }

    private string GetSenderDisplayName(string? senderId)
    {
        if (string.IsNullOrWhiteSpace(senderId))
            return "Bruger";

        if (usersById.TryGetValue(senderId, out var user))
        {
            if (!string.IsNullOrWhiteSpace(user.FirstName))
                return user.FirstName.Trim();

            if (!string.IsNullOrWhiteSpace(user.Username))
                return user.Username.Trim();
        }

        return $"Bruger {senderId[..Math.Min(6, senderId.Length)]}";
    }

    private static string GetInitial(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        return name.Trim().Substring(0, 1).ToUpperInvariant();
    }
}
