@page "/friends"
@using FitLifeFitness.Components.Layout
@layout PhoneLayout
@inject NavigationManager Nav

<div class="friends">

    <header class="friends-head">
        <div>
            <h2 class="friends-title">Venner</h2>
            <p class="friends-sub">@Friends.Count venner</p>
        </div>

        <button class="add-btn" @onclick="AddFriend">
            Tilføj
        </button>
    </header>

    <section class="friends-card">
        <input class="search-input"
               placeholder="Søg på navn"
               @bind="Search"
               @bind:event="oninput" />

        <div class="filter-row">
            <button class="chip @(ShowOnlyCoaches ? "on" : "")" @onclick="ToggleCoaches">
                Kun coaches
            </button>
        </div>
    </section>

    <section class="friends-list">
        @foreach (var f in VisibleFriends)
        {
            <button class="friend-row" @onclick="@(()=>OpenFriend(f))">
                <div class="friend-avatar">@Initials(f.Name)</div>

                <div class="friend-info">
                    <div class="friend-name">@f.Name</div>
                    <div class="friend-meta">@f.City</div>
                </div>

                <div class="friend-right">
                    @if (f.IsCoach)
                    {
                        <div class="tag tag-coach">Coach</div>
                    }
                    <div class="chev">›</div>
                </div>
            </button>
        }

        @if (!VisibleFriends.Any())
        {
            <div class="empty">
                Ingen venner matcher din søgning
            </div>
        }
    </section>

    <section class="friends-card">
        <div class="card-title">TODO</div>
        <ul class="todo">
            <li>Erstat seed data med data fra backend</li>
            <li>Tilføj “tilføj ven” flow (invite, accept, reject)</li>
            <li>Implementer profilside for ven: /friends/{id}</li>
        </ul>
    </section>

</div>

@code {
    private string Search = "";
    private bool ShowOnlyCoaches = false;

    private List<FriendModel> Friends = new()
    {
        new() { Id = "f1", Name = "Sara Jensen", City = "Aarhus", IsCoach = false },
        new() { Id = "f2", Name = "Mikkel Holm", City = "Aalborg", IsCoach = false },
        new() { Id = "f3", Name = "Nanna Larsen", City = "Aarhus", IsCoach = true },
        new() { Id = "f4", Name = "Jonas Madsen", City = "København", IsCoach = true },
        new() { Id = "f5", Name = "Emil Sørensen", City = "Odense", IsCoach = false },
        new() { Id = "f6", Name = "Freja Nielsen", City = "Aarhus", IsCoach = false }
    };

    private IEnumerable<FriendModel> VisibleFriends
    {
        get
        {
            IEnumerable<FriendModel> q = Friends;

            if (ShowOnlyCoaches)
            {
                q = q.Where(x => x.IsCoach);
            }

            if (!string.IsNullOrWhiteSpace(Search))
            {
                q = q.Where(x => x.Name.Contains(Search, StringComparison.OrdinalIgnoreCase));
            }

            return q.OrderBy(x => x.Name);
        }
    }

    private void ToggleCoaches() => ShowOnlyCoaches = !ShowOnlyCoaches;

    private void OpenFriend(FriendModel f)
    {
        Nav.NavigateTo($"/friends/{f.Id}");
    }

    private void AddFriend()
    {
        // TODO: Tilføj ven flow, fx naviger til /friends/add
        // Nav.NavigateTo("/friends/add");
    }

    private static string Initials(string name) =>
        string.Join("", name.Split(" ", StringSplitOptions.RemoveEmptyEntries).Select(x => x[0])).ToUpper();

    private class FriendModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string City { get; set; } = "";
        public bool IsCoach { get; set; }
    }
}
